!function(){"use strict";angular.module("ngDebounceThrottle",[]).factory("$debounce",["$rootScope","$timeout",function(u,p){return function(t,n,o,i){var a,r,s,c,l=function(){!(s=null)!==o&&(!1!==i&&u.$applyAsync(),c=t.apply(a,r))};function e(){a=this,r=arguments;var e=o&&!s;return s&&p.cancel(s),s=p(l,n,!1),e&&(!1!==i&&u.$applyAsync(),c=t.apply(a,r)),c}return e.cancel=function(){p.cancel(s),s=null},e}}]).factory("$throttle",["$rootScope","$timeout",function(f,m){return function(n,o,i,a,r){var s,c,l,u,p=0,d=function(){p=!1===i?0:(new Date).getTime(),!(l=null)===r&&f.$applyAsync(),u=n.apply(s,c),l||(s=c=null)},e=function(){s=this,c=arguments;var e=(new Date).getTime();p||!1!==i||(p=e);var t=o-(e-p);return t<=0||o<t?(l&&(m.cancel(l),l=null),p=e,!0===r&&f.$applyAsync(),u=n.apply(s,c),l||(s=c=null)):l||!1===a||(l=m(d,t,!1)),u};return e.cancel=function(){m.cancel(l),p=0,l=s=c=null},e}}])}(),angular.module("uh4dApp",["ui.router","ngAnimate","ngResource","mgcrea.ngStrap","ui.bootstrap","ng-clamp","dokuvis.viewport","dokuvis.utils","dokuvis.imageViewer","uh4d.images","uh4d.models"]).config(["$stateProvider","$urlRouterProvider","$modalProvider","$uibModalProvider","$selectProvider",function(e,t,n,o,i){t.otherwise("/"),e.state({name:"root",url:"?edit",abstract:!0,views:{root:{template:"<ui-view></ui-view>"},header:"header"},params:{edit:{type:"query",value:null}}}).state({name:"root.home",url:"/",templateUrl:"partials/home.08637f4f.html"}).state({name:"root.search",url:"/search?query&page&filterObjIncl&filterObjExcl",component:"search",params:{query:{type:"query",dynamic:!0,value:null},page:{type:"query",dynamic:!0,value:null},filterObjIncl:{type:"query",dynamic:!0,array:!0,value:[]},filterObjExcl:{type:"query",dynamic:!0,array:!0,value:[]}}}).state({name:"root.search.image",url:"/image/:imageId",redirectTo:function(e){if(!e.params().imageId)return"root.search"},params:{imageId:{dynamic:!0}},resolve:{imageModalInstance:["$uibModal",function(e){return e.open({component:"imageModal",size:"large"})}]},onExit:["imageModalInstance",function(e){e.close()}]}).state({name:"root.search.compare",url:"/compare?imageId1&imageId2",redirectTo:function(e){if(!e.params().imageId1||!e.params().imageId2)return"root.search"},resolve:{compareModalInstance:["$uibModal",function(e){return e.open({component:"compareModal",size:"xlarge"})}]},onExit:["compareModalInstance",function(e){e.close()}]}).state({name:"root.help",url:"/help",templateUrl:"partials/help.1328b83d.html"}),angular.extend(n.defaults,{backdrop:"static",keyboard:!1}),angular.extend(o.options,{animation:!1,backdrop:"static",keyboard:!1}),angular.extend(i.defaults,{templateUrl:"partials/overrides/bs.select.tpl.4f5a4048.html"})}]).run(["$rootScope","$state",function(t,e){t.showModelLoadPanel=!0,t.$watch(function(){return e.params.edit},function(e){t.editableMode="true"===e})}]),angular.module("uh4dApp").component("header",{templateUrl:"app/header/header.tpl.cace8e76.html",controller:["$scope","$state",function(e,t){var n=this;n.submitSearch=function(){t.go("root.search",{query:n.searchTerm})},e.$watch(function(){return t.params.query},function(e){n.searchTerm=e})}]}),angular.module("uh4dApp").component("search",{templateUrl:"app/search/search.tpl.0fb18a93.html",controller:["$scope","$rootScope","$state","$uiRouterGlobals","Image","DigitalObject","Utilities",function(e,i,s,t,n,o,a){function r(e){n.query({query:e||s.params.query,filterObjIncl:s.params.filterObjIncl,filterObjExcl:s.params.filterObjExcl}).$promise.then(function(e){var t,n,o;console.log(e),t=e,i.$broadcast("imageQuerySuccess",t),n=[],e.forEach(function(e){e.spatial&&n.push(e)}),o=n,i.$broadcast("spatialImageLoad",o,!0)}).catch(function(e){a.throwApiException("Image.query() in search component",e)})}console.log("search component",e),this.loadModel=function(){o.query().$promise.then(function(e){var t,n;console.log(e),i.showModelLoadPanel=!1,t=e,i.$broadcast("modelQuerySuccess",t,!0===n)}).catch(function(e){a.throwApiException("DigitalObject.query",e)})},e.$on("searchUpdate",function(){r()}),e.$on("filterByObject",function(e,t,n){console.log("filterByObject event",t,n);var o=[].concat(s.params.filterObjIncl),i=[].concat(s.params.filterObjExcl),a=!1;switch(n){case"include":-1===o.indexOf(t.name)&&(o.push(t.name),a=!0);break;case"exclude":-1===i.indexOf(t.name)&&(i.push(t.name),a=!0);break;default:var r=o.indexOf(t.name);-1!==r&&(o.splice(r,1),a=!0),-1!==(r=i.indexOf(t.name))&&(i.splice(r,1),a=!0)}a&&s.go("root.search",{filterObjIncl:o,filterObjExcl:i})}),e.$watchGroup([function(){return s.params.query},function(){return s.params.filterObjIncl.length},function(){return s.params.filterObjExcl.length}],function(){r()})}]}),angular.module("uh4dApp").factory("SpatializeInterface",function(){var o={callFunc:{},markers2D:[],markers3D:[],imageWidth:0,imageHeight:0,getDLTInputs:function(){if(o.markers2D.length!==o.markers3D.length)return console.warn("Missing markers!"),void console.log(o.markers2D,o.markers3D);for(var e="",t=0,n=o.markers2D.length;t<n;t++)e+=[t+1,o.markers3D[t].x,o.markers3D[t].y,o.markers3D[t].z,1e3*o.markers2D[t].x,1e3*o.markers2D[t].y,"\n"].join(" ");return console.log(e),e}};return o}),angular.module("dokuvis.utils",["mgcrea.ngStrap","pascalprecht.translate"]).factory("Utilities",["$timeout","$alert",function(a,o){var r={waitfor:function(e,t,n,o,i){e()===t?i(o):setTimeout(function(){r.waitfor(e,t,n,o,i)},n)},dblclickSwitch:function(t,n){return function(e){o?(o=!1,i&&a.cancel(i),n&&n(e)):i=a(function(){o=!1,t&&t(e)},300,!(o=!0))};var o,i},dangerAlert:function(e){o({content:e,type:"danger",duration:5})},throwException:function(e,t,n){o({title:e+":",content:t,type:"danger",duration:5}),console.error(e+": "+t,n,"\n"+(new Error).stack.split("\n")[2])},throwApiException:function(e,t){403===t.status&&(e="Access denied "+e+" ("+t.statusText+" "+t.status+")"),o({title:"API Exception:",content:e,type:"danger",duration:5}),console.error("API Exception: "+e,t,"\n"+(new Error).stack.split("\n")[2])}};return r}]).factory("ConfirmDialog",["$q","$alert",function(a,r){var s={backdrop:"static",templateUrl:"components/dokuvis.utils/confirmAlert.tpl.28b6556b.html",show:!0},c={abortButtonText:"abort",actionButtonText:"OK",headerText:"continue?",bodyText:"Sind Sie sicher?",type:"warning",translationData:{}};return function(e,t){return t||(t={}),function(e,t){var n={},o={};angular.extend(n,s,t),angular.extend(o,c,e),n.alertOptions=o;var i=a.defer();return n.controller=function(e){e.alertOptions=o,e.alertOptions.ok=function(){e.$hide(),i.resolve()},e.alertOptions.abort=function(){e.$hide(),i.reject()}},r(n),i.promise}(e,t)}}]).directive("fileDropArea",["$timeout","$state",function(e,i){return{restrict:"AE",scope:{uploader:"=",label:"@"},link:function(t,n,o){e(function(){var e=angular.element(n);"uiSref"in o&&(e.find("input").remove(),t.uploader.onAfterAddingAll=function(){i.includes(o.uiSref)||i.includes("**"+o.uiSref)||i.go(o.uiSref)}),"multiple"in o&&e.find("input").attr("multiple",!0),"column"in o&&e.children().css("flex-direction","column")}),t.openFileDialog=function(){e(function(){angular.element(n).find("input").trigger("click")})}},template:'<div ng-if="uploader" data-uploader="uploader" nv-file-drop nv-file-over ng-click="openFileDialog()">\n\t<input type="file" ng-hide="1" data-uploader="uploader" nv-file-select ng-click="$event.stopPropagation()"/>\n\t<svg x="0px" y="0px" viewBox="0 0 10 10" enable-background="new 0 0 10 10" xml:space="preserve">\n\t\t<path d="M3.746,10V6.283H0V3.717h3.746V0h2.497v3.717H10v2.566H6.243V10H3.746z"/>\n\t</svg>\n\t<div>{{label|translate}}</div>\n</div>'}}]).directive("noContextMenu",function(){return{compile:function(e){e.bind("contextmenu",function(e){e.preventDefault()})}}}),angular.module("dokuvis.viewport",["pascalprecht.translate","ngDebounceThrottle"]).component("viewport",{template:"<canvas ng-class=\"{'cursor_orbit': navigation.rotate, 'cursor_pan': navigation.pan, 'cursor_zoom': navigation.zoom}\"></canvas>\n<div class=\"viewport-extras\"></div>",controller:["$scope","$element","$attrs","$state","$window","$timeout","viewportCache","viewportSettings","$rootScope","$q","Utilities","$debounce","$throttle","SpatializeInterface","$log","$compile","$animate","Image",function(B,_,i,e,a,o,r,s,q,m,G,t,n,c,l,Q,X,Y){console.log(B,_,i);var J,Z,u,p,d,f,g=i.id||0;c.callFunc[g]={};var h,v,K,E,ee,te,ne,y,w,b,x,T,M,$,D,j,R,H,C,oe,ie,ae,S=s.defaults.NEAR,re=s.defaults.FAR,V=new THREE.Raycaster,se=[],k=[],I=[],O=0,L=!1,ce=new THREE.Vector2,z=null,le=-1,ue=!1,pe=!1,de=!1,fe=B.navigation={default:!0,rotate:!1,pan:!1,zoom:!1},me=!1,A=!1,P=!0,ge=!1,he=r.objects,U=r.plans,W=r.spatialImages,N=r.geometries,F=r.materials;function ve(){Z&&(Z.$destroy(),Z=null),J&&(X.leave(J),J=null)}var Ee=t(function(e,t){var n,o;n=e,o=t,(p=B.$new(!1)).position=o,p.entry=n,p.close=ye,u=Q("<viewport-tooltip></viewport-tooltip>")(p),X.enter(u,_)},500,!(this.$onInit=function(){console.log("viewport $onInit"),h=_.width(),v=_.height(),console.log("viewport size: ",h,v),ne=new THREE.CombinedCamera(h,v,35,S,re,S,re),r.viewpoint?ne.position.copy(r.viewpoint.cameraPosition):ne.position.set(-100,60,100),ee=r.scene,K=_.find("canvas"),(E=new THREE.WebGLRenderer({antialias:!0,alpha:!1,preserveDrawingBuffer:!0,canvas:K.get(0)})).setClearColor(DV3D.Defaults.backgroundColor,1),E.setSize(h,v),_.append(E.domElement),(te=new THREE.OrbitControls(ne,E.domElement)).zoomSpeed=1,r.viewpoint&&te.target.copy(r.viewpoint.controlsTarget),ne.target=te.target,te.addEventListener("change",Me),te.addEventListener("end",function(){ut()}),y=r.directionalLight;var e=new THREE.LoadingManager;e.onProgress=be,e.onLoad=function(){xt()},b=new THREE.CTMLoader(e),x=new THREE.TextureLoader(e),K.on("mousedown",Ze),K.on("mousemove",Ke),K.on("mouseup",et),K.on("dblclick",tt),_.on("mouseleave",nt),K.on("wheel",ot),K.on("contextmenu",function(e){e.preventDefault()});var t,n,o=angular.element(a);o.on("keydown",it),o.on("keyup",at),o.on("resize",$t),w=new THREE.Octree({}),(M=new DV3D.GizmoMove(10,2.5,1.2)).addEventListener("change",Se),($=new DV3D.GizmoRotate(10)).addEventListener("change",Se),he.forEach(function(e){e.addEventListener("change",Re),e.addEventListener("toggle",Et),e.addEventListener("focus",yt),e.addEventListener("select",wt)}),W.forEach(function(e){e.addEventListener("change",Re),e.addEventListener("toggle",mt),e.addEventListener("select",wt),e.addEventListener("focus",yt),w.add(e.object.collisionObject)}),Se(),xe(ne),w.update(),"navigation"in i&&((t=B.$new(!1)).focus=function(e){if(!ne.inOrthographicMode)switch(e){case"selected":bt(se);break;default:xt()}},n=Q("<viewport-navigation></viewport-navigation>")(t),X.enter(n,_)),"compass"in i&&((t=B.$new(!1)).faceNorth=Mt,n=Q("<viewport-compass></viewport-compass>")(t),X.enter(n,_)),"loadProgress"in i&&(t=B.$new(!1),n=Q("<viewport-load-progress></viewport-load-progress>")(t),X.enter(n,_)),"imageControls"in i&&(t=B.$new(!1),n=Q("<viewport-image-controls></viewport-image-controls>")(t),X.enter(n,_)),"selectionDisplay"in i&&((t=B.$new(!1)).exitIsolation=ft,n=Q("<viewport-selection-display></viewport-selection-display>")(t),X.enter(n,_)),"analysisTools"in i&&((t=B.$new(!1)).linkToObjects=function(){var t=0,n=W.list.length;W.forEach(function(e){qe(e),console.log("Link object "+ ++t+" / "+n)})},t.toggleDummyCreationMode=function(){return ge=!ge},n=Q("<viewport-analysis-tools></viewport-analysis-tools>")(t),X.enter(n,_))}),!1);function ye(){p&&(p.$destroy(),p=null),u&&(X.leave(u),u=null,B.$applyAsync())}function we(){f&&(f.$destroy(),f=null),d&&(X.leave(d),d=null),_.find("viewport-selection-display, viewport-analysis-tools").show()}function be(e,t,n){B.$broadcast("viewportLoadProgress",e,t,n)}function xe(e){B.$broadcast("viewportCameraMove",e)}B.$on("triggerSpatializeManual",function(e,t){var n;"spatializeManual"in i&&(n=t,angular.element(_).find("viewport-spatialize-manual").length||((f=B.$new(!1)).source=n,f.camera=ne,f.controls=te,f.animate=He,f.close=we,d=Q("<viewport-spatialize-manual></viewport-spatialize-manual>")(f),X.enter(d,_),_.find("viewport-selection-display, viewport-analysis-tools").hide()))});var Te=t(function(){E&&E.render(ee,ne),w.update()},100);function Me(){ft(),He(),xe(ne)}function $e(){L||(te.removeEventListener("change",Me),L=!0,Se())}function De(){L&&(te.addEventListener("change",Me),L=!1)}function je(){L||Se()}var Re=t(je,50),He=n(je,20),Ce=n(je,500);function Se(){if(L?(TWEEN.update(),TWEEN.getAll().length||C?requestAnimationFrame(Se):De()):W.forEach(function(e){e.updateTextureByDistance(ne.position,30)},!0),te&&te.update(),r.grid){var e=s.defaults.gridSize/s.defaults.gridDivisions;r.grid.position.x=Math.round(ne.position.x/e)*e,r.grid.position.z=Math.round(ne.position.z/e)*e}if(C&&C.draw(),y){y.position.set(4,4,4);var t=(new THREE.Matrix4).makeRotationFromQuaternion(ne.quaternion);y.position.applyMatrix4(t)}Ve()}function Ve(){E&&E.render(ee,ne)}function ke(e){var t=new THREE.Vector3(e.x,e.y,S).unproject(ne).sub(ne.position).normalize();V.set(ne.position,t)}function Ie(e,t){var n=V.intersectObjects(e,t||!1);return n.length?n[0]:null}function Oe(e){var t=Array.from(arguments),n=[];return-1!==t.indexOf("objects")&&he.forEach(function(e){"object"===e.type&&n.push(e.object)},!0),-1!==t.indexOf("plans")&&U.forEach(function(e){n.push(e.object.mesh)},!0),-1!==t.indexOf("spatialImages")&&w.search(V.ray.origin,0,!0,V.ray.direction).forEach(function(e){e.object.parent.entry.visible&&n.push(e.object)}),n}function Le(e,t){ke(e);var n=Ie(Oe("objects","plans","spatialImages"),!0);n?(l.debug(n),n.object.entry instanceof DV3D.Entry?ze(n.object.entry,t):n.object.parent.entry instanceof DV3D.Entry?ze(n.object.parent.entry,t):l.warn("Raycast hit unknown object",n)):ze(null,t)}function ze(e,t,n){t=t||!1,n=n||!1;var o=!1;se.length&&!t&&(se.forEach(function(e){Ue(e),o=!0}),gt(),se=[]),e&&!n&&-1===se.indexOf(e)?(Pe(e),se.push(e),o=!0,e instanceof DV3D.PlanEntry&&gt(e.object,"move")):e&&!n&&-1!==se.indexOf(e)&&(Ue(e),se.splice(se.indexOf(e),1),o=!0,T&&T.object===e.object&&gt()),o&&Ae(),Re()}var Ae=t(function(){q.$broadcast("viewportSelectionChange",se)},200);function Pe(e){e instanceof DV3D.ObjectEntry?(!function(e){if("object"!==e.type)return;switch(s.shading){case"xray":e.object.material=F.xraySelectionMat}e.edges&&(e.edges.material===F.edgesMat?e.edges.material=F.edgesSelectionMat:e.edges.material.color=F.edgesSelectionMat.color)}(e),e.children.forEach(function(e){Pe(e)})):e instanceof DV3D.PlanEntry?e.object.select():e instanceof DV3D.ImageEntry&&e.object.select(),e.select(null,!0)}function Ue(e){e instanceof DV3D.ObjectEntry?(!function(e){if("object"!==e.type)return;switch(s.shading){case"xray":e.object.material=F.xrayMat}e.edges&&(e.edges.material===F.edgesSelectionMat?e.edges.material=F.edgesMat:e.edges.material.color=F.edgesMat.color)}(e),e.children.forEach(function(e){Ue(e)})):e instanceof DV3D.PlanEntry?e.object.deselect():e instanceof DV3D.ImageEntry&&e.object.deselect(),e.select(null,!1)}function We(e){if(-1===I.indexOf(e)){for(var t=0;t<k.length;t++)k[t]!==e&&-1===I.indexOf(k[t])&&(Ne(k[t]),k.splice(t,1),--t);e&&-1===k.indexOf(e)&&("object"===e.userData.type&&function(e){e.material=e.material.clone();var t=new THREE.Color(16776960);e.material.color.lerp(t,.5),e.material.name+="_highlight"}(e),k.push(e))}}function Ne(e){if(e.material!==F[e.userData.originalMat]&&-1===r.standardMaterials.indexOf(e.material.name))switch(e.material.dispose(),s.shading){case"grey":e.material=F.defaultDoublesideMat;break;case"transparent":e.material=F.transparentMat;break;default:e.material=F[e.userData.originalMat]}}function Fe(e,t){!0===t?e&&-1!==I.indexOf(e)&&(_e(e),I.splice(I.indexOf(e),1)):e&&-1===I.indexOf(e)&&(We(),"object"===e.userData.type&&function(e){Ne(e),e.material=e.material.clone();var t=new THREE.Color(16711680);e.material.color.lerp(t,.5),e.material.name+="_mark"}(e),I.push(e))}function Be(){I.forEach(function(e){_e(e)}),I=[]}function _e(e){Ne(e)}function qe(e){var t=[];he.forEach(function(e){"object"===e.type&&t.push(e.object)},!0);for(var n=0;n<20;n++)for(var o=0;o<20;o++){var i=n*e.object.width/21+e.object.width/20-e.object.width/2,a=o*e.object.height/21+e.object.height/20-e.object.height/2,r=new THREE.Vector3(i,a,0);r.applyMatrix4(e.object.image.matrixWorld);var s=r.sub(e.object.position).normalize();V.set(e.object.position,s);var c=V.intersectObjects(t,!0);if(c[0]){var l=c[0].object.entry;l&&-1===se.indexOf(l)&&(Pe(l),se.push(l))}}console.log(e),console.log(se.map(function(e){if(e instanceof DV3D.ObjectEntry)return e.name})),e.source.$setLinksToObjects({objectIds:se.map(function(e){if(e instanceof DV3D.ObjectEntry)return e.name})}).then(function(e){console.log(e)}).catch(function(e){G.throwApiException("#Image.setLinksToObjects",e)}),ze(null,!1,!0),Re()}function Ge(t,e){if(t!==e){var n="onlyEdges"===t&&"onlyEdges"!==e,o="onlyEdges"===e&&"onlyEdges"!==t,i="xray"===t&&"xray"!==e,a=s.showEdges&&"xray"===e;"custom"===e&&categoryDeactivate(),he.forEach(function(e){switch(e.visible&&(n&&(e.parent?e.parent.object.remove(e.object):ee.remove(e.object)),o&&(e.parent?e.parent.object.add(e.object):ee.add(e.object)),i&&e.edges&&ee.remove(e.edges),a&&e.edges&&ee.add(e.edges)),t){case"grey":e.object.material=F.defaultDoublesideMat;break;case"transparent":e.object.material=F.transparentMat;break;case"xray":-1!==se.indexOf(e)?e.object.material=F.xraySelectionMat:e.object.material=F.xrayMat;break;default:Array.isArray(e.object.userData.originalMat)?e.object.material=e.object.userData.originalMat.map(function(e){return F[e]}):e.object.material=F[e.object.userData.originalMat]}}),Se()}}function Qe(e){if(ne){switch(e){case"perspective":ne.toPerspective(),ne.setZoom(1);break;case"top":ne.toOrthographic(te.target),ne.toTopView();break;case"front":ne.toOrthographic(te.target),ne.toFrontView();break;case"back":ne.toOrthographic(te.target),ne.toBackView();break;case"left":ne.toOrthographic(te.target),ne.toLeftView();break;case"right":ne.toOrthographic(te.target),ne.toRightView()}Se()}}function Xe(e){B.$broadcast("viewportNavigationChange",e)}function Ye(e){var t=new THREE.Vector2;return t.x=e.offsetX/h*2-1,t.y=-e.offsetY/v*2+1,t}function Je(e){var t=h*(e.x+1)/2,n=v*(1-e.y)/2;return new THREE.Vector2(t,n)}function Ze(e){if(ve(),ye(),le=e.button,ce=Ye(e),z=e,ge&&0===e.button){var t=new THREE.Plane(new THREE.Vector3(0,1,0),-3);ke(ce),oe=V.ray.intersectPlane(t)}else if(fe.default)if(0===e.button)if(e.shiftKey){var n=angular.element("<div/>",{id:"select-rectangle",class:"select-rectangle"});_.append(n),me=!0}else ne.inPerspectiveMode;else 1===e.button&&(te.onMouseDown(e.originalEvent,2),K.addClass("cursor_pan"),de=!0);else fe.rotate?0===e.button&&ne.inPerspectiveMode&&(te.onMouseDown(e.originalEvent,0),ue=!0):fe.pan?0===e.button&&(te.onMouseDown(e.originalEvent,2),de=!0):fe.zoom&&0===e.button&&(te.onMouseDown(e.originalEvent,1),pe=!0)}function Ke(e){e.preventDefault();var t,n,o,i,a,r=Ye(e);if(ye(),ge&&oe){var s=new THREE.Plane(new THREE.Vector3(0,1,0),-3);ke(r);var c=V.ray.intersectPlane(s),l=(new THREE.Vector3).subVectors(c,oe),u=l.length();ie=l.normalize(),ae?(ae.setDirection(l),ae.setLength(u)):(ae=new THREE.ArrowHelper(l,oe,u),ee.add(ae)),Se()}else if(-1!==le)ue||de||pe?te.onMouseMove(e.originalEvent):me?_.find("#select-rectangle").css((n=r,o=Je(t=ce),i=Je(n),a={},n.x>t.x?(a.left=o.x,a.width=i.x-o.x):(a.left=i.x,a.width=o.x-i.x),n.y<t.y?(a.top=o.y,a.height=i.y-o.y):(a.top=i.y,a.height=o.y-i.y),a)):0===le&&ne.inPerspectiveMode&&!ce.equals(r)&&(te.onMouseDown(z.originalEvent,0),K.addClass("cursor_orbit"),ue=!0);else{if(ke(r),P)var p=Oe("objects");else p=Oe("objects","spatialImages");var d=Ie(p,!0);if(d){var f=d.object.entry||d.object.parent.entry;f instanceof DV3D.ImageEntry?f.highlight(!0):W.dehighlight(),Ee(f,new THREE.Vector2(e.offsetX,e.offsetY))}else W.dehighlight(),Ee.cancel()}}function et(e){if(-1!==le){le=-1;var t,n,o,i,a,r,s,c,l,u,p,d,f,m,g,h,v,E,y,w,b,x,T,M,$,D,j,R,H,C,S,V,k,I,O,L,z,A,P,U,W=Ye(e);if(ge&&oe)ae&&(ee.remove(ae),ae.line.geometry.dispose(),ae.line.material.dispose(),ae.cone.geometry.dispose(),ae.cone.material.dispose()),z=oe,A=ie,P=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,-1),A),U=(new THREE.Matrix4).compose(z,P,new THREE.Vector3(1,1,1)),Y.createDummy({matrix:U.toArray(),offset:[0,0],ck:1/Math.tan((45*Math.random()+20)/2*THREE.Math.DEG2RAD)*.5,width:Math.round(800*Math.random()+400),height:Math.round(800*Math.random()+400)}).$promise.then(function(e){console.log(e),pt(e).then(function(e){Se(),qe(e)}),q.$broadcast("imageUpdate",e)}).catch(function(e){G.throwApiException("Image.createDummy",e)}),ie=oe=ae=null,Se();else if(fe.default&&2!==e.button)if(ue)te.onMouseUp(e.originalEvent),K.removeClass("cursor_orbit"),ue=!1;else if(de)te.onMouseUp(e.originalEvent),K.removeClass("cursor_pan"),de=!1;else if(pe)te.onMouseUp(e.originalEvent),K.removeClass("cursor_zoom"),pe=!1;else if(me){if(_.find("#select-rectangle").remove(),me=!1,0!==e.button)return;var N,F;W.x>ce.x&&W.y<ce.y||W.x<ce.x&&W.y>ce.y?(N=ce,F=W):(N=new THREE.Vector2(ce.x,W.y),F=new THREE.Vector2(W.x,ce.y)),o=N,i=F,a=e.ctrlKey,r=new THREE.Vector3(o.x,o.y,.5).unproject(ne),s=new THREE.Vector3(o.x,i.y,.5).unproject(ne),c=new THREE.Vector3(i.x,i.y,.5).unproject(ne),l=new THREE.Vector3(i.x,o.y,.5).unproject(ne),u=new THREE.Vector3(0,0,.5).unproject(ne),p=(new THREE.Vector3).subVectors(r,ne.position),d=(new THREE.Vector3).subVectors(s,ne.position),f=(new THREE.Vector3).subVectors(c,ne.position),m=(new THREE.Vector3).subVectors(l,ne.position),g=(new THREE.Vector3).subVectors(u,ne.position),h=new THREE.Vector3(0,0,.5).unproject(ne).add(g.clone().setLength(re)),v=(new THREE.Vector3).subVectors(h,ne.position),E=(new THREE.Vector3).crossVectors(d,p).normalize(),y=(new THREE.Vector3).crossVectors(f,d).normalize(),w=(new THREE.Vector3).crossVectors(m,f).normalize(),b=(new THREE.Vector3).crossVectors(p,m).normalize(),x=g.clone().normalize(),T=v.clone().negate().normalize(),M=-E.dot(r),$=-y.dot(s),D=-w.dot(c),j=-b.dot(l),R=-x.dot(u),H=-T.dot(h),C=new THREE.Plane(E,M),S=new THREE.Plane(y,$),V=new THREE.Plane(w,D),k=new THREE.Plane(b,j),I=new THREE.Plane(x,R),O=new THREE.Plane(T,H),L=new THREE.Frustum(C,S,V,k,I,O),a||ze(null,!1,!0),he.forEach(function(e){if("object"===e.type&&-1===se.indexOf(e.object)&&L.intersectsObject(e.object)){console.log("first check");for(var t=e.object.geometry.attributes.position.array,n=e.object.matrixWorld,o=0,i=t.length;o<i;o+=3){var a=new THREE.Vector3(t[o],t[o+1],t[o+2]);if(a.applyMatrix4(n),L.containsPoint(a)){console.log("second check"),ze(e,!0);break}}}},!0),Se()}else W.equals(ce)&&(Le(W,e.ctrlKey),Se());else fe.rotate||fe.pan||fe.zoom?(2===e.button&&Xe(),(ue||de||pe)&&(te.onMouseUp(e.originalEvent),ue=de=pe=!1)):2===e.button&&W.equals(ce)&&(Le(W),se[0]&&(Ee.cancel(),ye(),(se[0]instanceof DV3D.ImageEntry||se[0]instanceof DV3D.ObjectEntry)&&(t=se[0],n=new THREE.Vector2(e.offsetX,e.offsetY),(Z=B.$new(!1)).position=n,Z.entry=t,Z.close=ve,Z.deleteDummy=ct,J=Q("<viewport-context-menu no-context-menu></viewport-context-menu>")(Z),X.enter(J,_))))}}function tt(){se[0]&&(se[0]instanceof DV3D.ImageEntry?se[0].focus():se[0]instanceof DV3D.ObjectEntry&&se[0].focus())}function nt(e){le=-1,ve(),ye(),fe.default?ue?(te.onMouseUp(e.originalEvent),K.removeClass("cursor_orbit"),ue=!1):de?(te.onMouseUp(e.originalEvent),K.removeClass("cursor_pan"),de=!1):pe?(te.onMouseUp(e.originalEvent),K.removeClass("cursor_zoom"),pe=!1):me&&(_.find("#select-rectangle").remove(),me=!1):(fe.rotate||fe.pan||fe.zoom)&&(ue||de||pe)&&(te.onMouseUp(e.originalEvent),ue=de=pe=!1)}function ot(e){e.preventDefault(),ye(),te.onMouseWheel(e.originalEvent)}function it(e){-1===["INPUT","TEXTAREA"].indexOf(e.target.tagName)&&te.onKeyDown(e.originalEvent)}function at(e){if(-1===["INPUT","TEXTAREA"].indexOf(e.target.tagName))switch(e.keyCode){case 70:Qe("front");break;case 76:Qe("left");break;case 80:Qe("perspective");break;case 84:Qe("top")}}B.$watch(function(){return s.shading},function(e,t){Ge(e,t)}),B.$watch(function(){return s.camera},function(e,t){Ge(e,t)}),B.$on("viewportNavigationChange",function(e,t){var n;e.stopPropagation&&e.stopPropagation(),n=t,D&&(ee.remove(D),D.dispose(),D=null),j&&(ee.remove(j),j.dispose(),A=!1,We(j=null)),fe.default=!1,fe.rotate=!1,fe.pan=!1,fe.zoom=!1,n&&n in fe?fe[n]=!0:fe.default=!0,Se()});var rt=null;function st(e){var t=new THREE.Vector3(e.cameraMatrix[12],e.cameraMatrix[13],e.cameraMatrix[14]),n=(new THREE.Vector3).fromArray(e.cameraCenter);new TWEEN.Tween(ne.position.clone()).to(t,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){ne.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(n,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){te.target.copy(this)}).start(),ne.fov===e.cameraFOV&&new TWEEN.Tween({fov:ne.fov}).to({fov:e.cameraFOV},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){ne.fov=this.fov,ne.updateProjectionMatrix()}).start(),$e()}function ct(t){ze(null),q.$broadcast("imageUpdate",t.source,!0),t.source.$deleteDummy().then(function(e){console.log(e),ee.remove(t.object),w.remove(t.object.collisionObject),W.remove(t),t.dispose(),console.log(t),Re()}).catch(function(e){G.throwApiException("Image.$deleteDummy",e)})}function lt(){R&&(R.update(ne,function(t){var e=w.search(t,O),n=0;return e.forEach(function(e){t.clone().sub(e.position).length()<O&&n++}),n}),Re()),H&&(H.update(ne,function(n){var e=w.search(n,O),o=0,i=0,a=O,r=new THREE.Vector3;return e.forEach(function(e){var t=n.clone().sub(e.position).length();t<O&&(r.add(new THREE.Vector3(0,0,-1).applyQuaternion(e.object.parent.quaternion)),o++,i+=t,a=Math.min(a,t))}),{direction:r.normalize(),count:o,disWeight:1-a/O,dirWeight:1-i/O/o}}),Re()),C&&(C.update(ne,function(n){var e=w.search(n,O),o=0,i=0,a=O,r=new THREE.Vector3;return e.forEach(function(e){var t=n.clone().sub(e.position).length();t<O&&(r.add(new THREE.Vector3(0,0,-1).applyQuaternion(e.object.parent.quaternion)),o++,i+=t,a=Math.min(a,t))}),{direction:r.normalize(),count:o,disWeight:1-a/O,dirWeight:1-i/O/o}}),$e())}B.$on("snapshotViewScreen",function(e,t,n){if(!angular.element(_).find("viewport-snapshot-view").length){var o=B.$new(!1);o.screen=t,o.pins=n,rt=Q("<viewport-snapshot-view></viewport-snapshot-view>")(o),X.enter(rt,_),angular.element(_).find("viewport-navigation").attr("disabled",!0),st(t)}}),B.$on("snapshotViewClose",function(){B.closeSnapshotView()}),B.closeSnapshotView=function(){rt&&X.leave(rt),rt=null,angular.element(_).find("viewport-navigation").attr("disabled",!1)},B.$on("snapshotStart",function(){if(!angular.element(_).find("viewport-snapshot").length){var e=B.$new(!1);e.size={width:h,height:v},rt=Q("<viewport-snapshot></viewport-snapshot>")(e),X.enter(rt,_),angular.element(_).find("viewport-navigation").attr("disabled",!0),o(function(){var e;e={sData:E.domElement.toDataURL("image/jpeg"),cameraMatrix:ne.matrix.toArray(),cameraFOV:ne.fov,cameraCenter:te.target.toArray(),width:h,height:v},q.$broadcast("snapshotScreenshot",e)})}}),B.$on("snapshotEnd",function(){rt&&X.leave(rt),rt=null,angular.element(_).find("viewport-navigation").attr("disabled",!1),Be(),Re()}),B.startPinning=function(){Xe(),j=new DV3D.Pin(3,.5),ee.add(j),A=!0},B.abortPinning=function(){A=!1,Xe()},B.mousemovePinLayer=function(e){if(A&&j){var t=Ye(e),n=[];he.forEach(function(e){"object"===e.type&&n.push(e.object)},!0),ke(t);var o=Ie(n);o?(j.set(o),We(o.object)):(j.set(),We()),He()}},B.mouseleavePinLayer=function(){A&&j&&(j.set(),We(),Re())},B.mouseupPinLayer=function(e){if(e.preventDefault(),A&&j&&0===e.button&&k[0]){var t=k[0];-1===I.indexOf(t)&&(Fe(t),n=he.get(t.id),o=j.matrixWorld.toArray(),q.$broadcast("snapshotPinSuccess",n,o),He())}var n,o},B.$on("snapshotPinRemove",function(e,t){Fe(t.object,!0),Re()}),B.$on("snapshotViewStart",function(e,t){st(t)}),B.$on("viewportHeatMapUpdate",function(e,t){if(t){if(t.typeChange&&(!R||"heatMap"===t.type&&t.visible||(ee.remove(R),R.dispose(),R=null),!H||"vectorField"===t.type&&t.visible||(ee.remove(H),H.dispose(),H=null),!C||"windMap"===t.type&&t.visible||(ee.remove(C),C.dispose(),C=null,De()),t.visible)){switch(t.type){case"heatMap":R=new DV3D.HeatMap3,ee.add(R);break;case"vectorField":H=new DV3D.VectorField,ee.add(H);break;case"windMap":(C=new DV3D.WindMap).configure({numParticles:2e4}),C._useWeight=t.useWeight,ee.add(C)}O=t.radius,lt()}t.overlayChange&&(R&&(R.material.depthTest=!t.overlay,R.material.depthWrite=!t.overlay),H&&H.arrows.forEach(function(e){e.object.cone.material.depthTest=!t.overlay,e.object.line.material.depthTest=!t.overlay,e.object.cone.material.transparent=t.overlay,e.object.line.material.transparent=t.overlay}),C&&(C.material.depthTest=!t.overlay,C.material.depthWrite=!t.overlay)),t.radiusChange&&(O=t.radius,lt()),t.settingsChange&&(C&&(C._useWeight=t.useWeight),lt()),Re()}});var ut=t(lt,500);function pt(e){if(!e.spatial)return m.reject("No spatial information");var t=m.defer(),n=new DV3D.ImagePane("data/"+e.file.path+e.file.preview,{width:e.file.width,height:e.file.height,ck:e.spatial.ck,offset:e.spatial.offset,preview:"data/"+e.file.path+e.file.thumb});n.onComplete=function(){1!==s.images.opacity&&i.setOpacity(s.images.opacity),i.setScale(s.images.scale),Re(),t.resolve(i)};var o=(new THREE.Matrix4).fromArray(e.spatial.matrix);n.applyMatrix(o),ee.add(n),t.promise.then(function(){w.add(n.collisionObject),Te()}),n.name=e.spatial.id,n.userData.source=e,n.userData.type="image";var i=new DV3D.ImageEntry(n,e.title);return i.addEventListener("change",Re),i.addEventListener("toggle",mt),i.addEventListener("select",wt),i.addEventListener("focus",yt),W.add(i),t.promise}function dt(e){ft(),function(t,e){W.forEach(function(e){e.object!==t&&e.toggle(!1)},!0),!1!==e&&(P=!0);B.$broadcast("viewportIsolationEnter")}(e,!1);var t=new THREE.Vector3(0,0,-100);t.applyQuaternion(e.quaternion),t.add(e.position);var n=Math.abs(e.image.position.z*e.scale.z);ne.cameraP.near>.8*n&&(ne.cameraP.near=.8*n,ne.updateProjectionMatrix()),new TWEEN.Tween(ne.position.clone()).to(e.position,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){ne.position.copy(this)}).onComplete(function(){o(function(){P=!0},50)}).start(),new TWEEN.Tween(te.target.clone()).to(t,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){te.target.copy(this)}).start(),new TWEEN.Tween({fov:ne.fov}).to({fov:e.fov},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){ne.fov=this.fov,ne.updateProjectionMatrix()}).start(),$e()}function ft(){P&&(W.forEach(function(e){e.toggle(!0)}),P=!1,B.$broadcast("viewportIsolationExit"))}function mt(e){var t=e.target;if(e.visible){if(ee.getObjectById(t.object.id))return;ee.add(t.object)}else ee.remove(t.object),ze(t,!1,!0);Re()}function gt(e,t,n){switch(T&&T.attachToObject(null),t){case"move":T=M;break;case"rotate":T=$;break;default:T=null}T&&T.attachToObject(e,n)}function ht(e){if(e.id in F)return F[e.id];var t=new THREE.MeshLambertMaterial;return t.name=e.id,Array.isArray(e.diffuse)?(t.color=new THREE.Color(e.diffuse[0],e.diffuse[1],e.diffuse[2]),t.color.convertLinearToGamma()):"string"==typeof e.diffuse&&x.load("data/"+e.path+e.diffuse,function(e){t.map=e,t.needsUpdate=!0},null,function(e){l.warn("Couldn't load texture",e.path[0].src)}),e.alpha&&x.load("data/"+e.path+e.alpha,function(e){t.alphaMap=e,t.transparent=!0,t.needsUpdate=!0},null,function(e){l.warn("Couldn't load texture",e.path[0].src)}),t.side=THREE.DoubleSide,F[e.id]=t}function vt(e){var o=m.defer();return JSZipUtils.getBinaryContent(e,function(e,t){e?o.reject(e):JSZip.loadAsync(t).then(function(e){return e.file(/.+\.json$/i)[0].async("text")}).then(function(e){e=JSON.parse(e);var t=new Float32Array(e.data.attributes.position.array),n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(t,3)),o.resolve(n)}).catch(function(e){G.throwException("JSZip Error","Failed to load or extract zip file.",e),o.reject()})}),o.promise}function Et(e){var t=e.target,n=t.parent?t.parent.object:ee;if(e.visible&&t.parent&&!t.parent.visible&&(t.parent.visible=!0,Et({target:t.parent,visible:!0})),e.visible){if(n.getObjectById(t.object.id))return;n.add(t.object),s.showEdges&&t.edges&&ee.add(t.edges)}else n.remove(t.object),s.showEdges&&t.edges&&ee.remove(t.edges),ze(t,!1,!0);Re()}function yt(e){if(e.target.object){var t=e.target.object;t instanceof DV3D.ImagePane?dt(t):t instanceof DV3D.Plan?function(e){var t=e.mesh.geometry,n=e.mesh.matrixWorld,o=(new THREE.Quaternion).setFromRotationMatrix(n),i=new THREE.Vector3(t.attributes.normal.array[0],t.attributes.normal.array[1],t.attributes.normal.array[2]).applyQuaternion(o),a=t.boundingBox.clone().applyMatrix4(n),r=h/v,s=Math.sqrt(Math.pow(a.max.x-a.min.x,2)+Math.pow(a.max.z-a.min.z,2))/2,c=(a.max.y-a.min.y)/2;(.707<i.y||i.y<-.707)&&(s=Math.sqrt(Math.pow(a.max.x-a.min.x,2)+Math.pow(a.max.y-a.min.y,2))/2,c=(a.max.z-a.min.z)/2),r<s/c&&(c=1/r*s);var l=c/Math.tan(ne.fov/2*Math.PI/180),u=t.boundingSphere.center.clone().applyMatrix4(n),p=new THREE.Vector3;p.addVectors(u,i.setLength(l)),new TWEEN.Tween(ne.position.clone()).to(p,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){ne.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(u,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){te.target.copy(this)}).onComplete(function(){ne.toOrthographic(te.target),B.$apply()}).start(),$e()}(t):bt([e.target])}}function wt(e){ze(e.target,e.originalEvent.ctrlKey)}function bt(e){if(!(e.length<1))if(1===e.length&&e[0]instanceof DV3D.ImageEntry)dt(e[0].object);else{var o=[];!function e(t){for(var n=0;n<t.length;n++)e(t[n].children),"object"!==t[n].type&&"plan"!==t[n].type||o.push(t[n].object)}(e),Tt(o)}}function xt(){var t=[];he.forEach(function(e){"object"===e.type&&t.push(e.object)},!0),t.length<1||Tt(t)}function Tt(e){var t=new THREE.Box3;e.forEach(function(e){t.expandByObject(e)});var n=t.getBoundingSphere(),o=(new THREE.Vector3).subVectors(ne.position,te.target),i=n.radius/Math.tan(ne.fov/2*THREE.Math.DEG2RAD),a=(new THREE.Vector3).addVectors(n.center,o.setLength(i));ne.cameraP.near=n.radius/100,ne.cameraP.far=Math.max(100*n.radius,s.defaults.FAR),ne.updateProjectionMatrix(),new TWEEN.Tween(ne.position.clone()).to(a,500).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){ne.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(n.center,500).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){te.target.copy(this)}).start(),$e()}function Mt(){var e=new THREE.Vector3(ne.position.x,te.target.y,ne.position.z).sub(te.target),t=e.length(),n=Math.atan2(e.x,e.z);new TWEEN.Tween({theta:n}).to({theta:0},1e3).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){e.x=t*Math.sin(this.theta),e.y=ne.position.y,e.z=t*Math.cos(this.theta),ne.position.copy(new THREE.Vector3(te.target.x,0,te.target.z)).add(e)}).start(),$e()}function $t(){h=_.width(),v=_.height(),l.debug("resize called",h,v),ne.setSize(h,v),ne.cameraP.updateProjectionMatrix(),E.setSize(h,v),Se()}B.$on("spatialImageLoad",function(e,t,n){ze(null);var o,i=[],a=[],r=[];(o=Array.isArray(t)?t:[t]).forEach(function(e){if(e.spatial){var t=W.getByName(e.spatial.id);t?a.push({entry:t,resource:e}):i.push(e)}}),W.forEach(function(t){o.find(function(e){return!!e.spatial&&t.name===e.spatial.id})||r.push(t)}),r.forEach(function(e){ee.remove(e.object),w.remove(e.object.collisionObject),W.remove(e),e.dispose()}),a.forEach(function(e){e.entry.source=e.resource,e.entry.object.userData.source=e.resource}),i.forEach(function(e){pt(e)}),lt()}),B.$on("modelQuerySuccess",function(e,t){!function(){for(var e in[].concat(he.list).forEach(function(e){e.object.parent.remove(e.object),e.edges&&ee.remove(e.edges),he.remove(e),e.dispose()}),N)N.hasOwnProperty(e)&&-1===r.standardGeometries.indexOf(e)&&(N[e].mesh&&N[e].mesh.dispose(),N[e].edges&&N[e].edges.dispose(),delete N[e]);for(e in F)F.hasOwnProperty(e)&&-1===r.standardMaterials.indexOf(e)&&(F[e].map&&F[e].map.dispose(),F[e].alphaMap&&F[e].alphaMap.dispose(),F[e].dispose(),delete F[e]);Se()}(),b.manager.reset(),function n(e){return e.reduce(function(e,t){return e.then(function(){return function(a){var r,e=m.defer();switch(a.obj.type){case"group":r=new THREE.Group;break;case"object":r=new THREE.Mesh(N.initGeo,F.defaultMat);break;default:return e.reject("Unsupported type"),e.promise}var t=new THREE.Matrix4;if(t.fromArray(a.obj.matrix),"Z"===a.obj.up&&!a.parent){var n=new THREE.Matrix4;n.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),t.multiplyMatrices(n,t)}var o=new THREE.Vector3,i=new THREE.Quaternion,s=new THREE.Vector3;t.decompose(o,i,s);var c="number"==typeof a.obj.unit?a.obj.unit:1;a.parent||(o.multiplyScalar(c),s.multiplyScalar(c));t.compose(o,i,s),r.applyMatrix(t),r.matrixAutoUpdate=!1,r.name=a.obj.id,r.userData.id=a.obj.id,r.userData.name=a.obj.name,r.userData.type=a.obj.type,r.userData.layer=a.obj.layer;var l=null;a.parent&&(l=ee.getObjectByName(a.parent,!0));l?l.add(r):ee.add(r);var u=new DV3D.ObjectEntry(r);if(u.addEventListener("change",Re),u.addEventListener("toggle",Et),u.addEventListener("focus",yt),u.addEventListener("select",wt),he.add(u),"object"===a.obj.type){var p=Array.isArray(a.file.mesh)?a.file.mesh.reduce(function(e,t){return e+t}):a.file.mesh;if(p in N&&f(N[p].mesh),Array.isArray(a.file.mesh)){var d=[];a.file.mesh.reduce(function(e,n){return e.then(function(){var t=m.defer();return b.load("data/"+a.file.path+n,function(e){d.push(e),t.resolve()},{useWorker:!1}),t.promise})},m.resolve()).then(function(){f(d)})}else b.load("data/"+a.file.path+a.file.mesh,f,{useWorker:!1})}function f(o){if(Array.isArray(o)){var e=o;(o=e[0]).clearGroups(),o.addGroup(0,o.index.count,0);for(var t=1;t<e.length;t++){o.merge(e[t]);var n=e[t].index.count;o.addGroup(o.index.count-n,n,t),e[t].dispose()}o.name||(o.name=a.file.mesh.reduce(function(e,t){return e+t}))}else o.clearGroups(),o.addGroup(0,o.index.count,0),o.name||(o.name=a.file.mesh);if(o.name in N||(N[o.name]={mesh:o}),o.computeBoundingBox(),r.geometry=o,a.materials&&Array.isArray(a.materials)?1!==a.materials.length?(r.material=a.materials.map(ht),r.userData.originalMat=a.materials.map(function(e){return e.id})):(r.material=ht(a.materials[0]),r.userData.originalMat=a.materials[0].id):(r.material=F.defaultDoublesideMat,r.userData.originalMat="defaultDoublesideMat"),a.file.edges&&!Array.isArray(a.file.edges))vt("data/"+a.file.path+a.file.edges).then(function(e){var t=new THREE.LineSegments(e,F.edgesMat);t.matrix=r.matrixWorld,t.matrixAutoUpdate=!1,ee.add(t),N[o.name].edges=e,u.addEdges(t),Ce()}).catch(function(e){e&&G.throwException("Loading Error","Some error occurred while loading objects. See console for details.",e)});else if(a.file.edges&&Array.isArray(a.file.edges)){var i=[];a.file.edges.reduce(function(e,t){return e.then(function(){return vt("data/"+a.file.path+t).then(function(e){return i.push(e),m.resolve()})})},m.resolve()).then(function(){for(var e=i[0],t=1;t<i.length;t++)e.merge(i[t]),i[t].dispose();var n=new THREE.LineSegments(e,F.edgesMat);n.matrix=r.matrixWorld,n.matrixAutoUpdate=!1,ee.add(n),N[o.name].edges=e,u.addEdges(n),Ce()}).catch(function(e){e&&G.throwException("Loading Error","Some error occurred while loading objects. See console for details.",e)})}Ce()}return e.resolve(),e.promise}(t)}).then(function(){return n(t.children)})},m.resolve())}(t).then(function(){l.debug("objects loaded")}).catch(function(e){G.throwException("Loading Error","An error occurred while loading objects. See concole for details.",e)})}),B.$on("viewportFocusStart",function(e,t){if(!ne.inOrthographicMode)switch(t){case"selected":bt(se);break;default:xt()}}),B.$on("$destroy",function(){ze(null,!1,!0),W.dehighlight(),Be(),ft(),B.spatialize&&(angular.forEach(c.markers3D,function(e){ee.remove(e.object),e.object.dispose()}),c.markers3D.splice(0,c.markers3D.length),Ve(),B.$applyAsync()),R&&(ee.remove(R),R.dispose()),delete c.callFunc[g],r.viewpoint||(r.viewpoint={cameraPosition:new THREE.Vector3,controlsTarget:new THREE.Vector3}),r.viewpoint.cameraPosition.copy(ne.position),r.viewpoint.controlsTarget.copy(te.target),te.dispose(),E.forceContextLoss(),E.dispose();var e=angular.element(a);e.off("keydown",it),e.off("keyup",at),e.off("resize",$t),he.forEach(function(e){e.removeEventListener("change",Re),e.removeEventListener("toggle",Et),e.removeEventListener("focus",yt),e.removeEventListener("select",wt)}),W.forEach(function(e){e.removeEventListener("change",Re),e.removeEventListener("toggle",mt),e.removeEventListener("focus",yt),e.removeEventListener("select",wt)}),l.debug("destroy viewport directive")})}]}),angular.module("dokuvis.viewport").factory("viewportSettings",[function(){var e=[{value:"color",label:"Color"},{value:"grey",label:"Grey"},{value:"transparent",label:"Transparent"},{value:"onlyEdges",label:"Only edges"},{value:"xray",label:"X-Ray"},{value:"custom",label:"Custom"}],t=[{value:"perspective",label:"Perspective"},{value:"top",label:"Top"},{value:"front",label:"Front"},{value:"back",label:"Back"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"custom",label:"Custom"}];return{defaults:{NEAR:1,FAR:5e3,initWidth:800,initHeight:600,backgroundColor:6710886,selectionColor:16535082,highlightColor:16777028,objectColor:14540253,edgeColor:3407667,gridSize:3e3,gridDivisions:100},shadings:e,cameras:t,shading:e[0].value,camera:t[0].value,showEdges:!0,images:{opacity:1,scale:3}}}]).factory("viewportCache",["viewportSettings",function(e){var t=new THREE.Scene;t.fog=new THREE.Fog(e.defaults.backgroundColor,e.defaults.FAR-100,e.defaults.FAR);var n=new THREE.GridHelper(e.defaults.gridSize,e.defaults.gridDivisions,2834e3,2834e3);n.position.set(1e3,-.1,-1e3),n.material.dispose(),n.material=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)},opacity:{value:.7},fogNear:{value:1},fogFar:{value:e.defaults.gridSize/2}},vertexShader:"#include <common>\n#include <color_pars_vertex>\n\nvarying float fogDepth;\n\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n\n\t#include <color_vertex>\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\n\t#include <worldpos_vertex>\n\n\tfogDepth = -mvPosition.z;\n\n}",fragmentShader:"uniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <color_pars_fragment>\n\nvarying float fogDepth;\nuniform float fogNear;\nuniform float fogFar;\n\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\n\tgl_FragColor = diffuseColor;\n\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\tgl_FragColor.a *= 1.0 - fogFactor;\n\n}",vertexColors:THREE.VertexColors,transparent:!0}),t.add(n),t.add(new THREE.AmbientLight(8947848));var o=new THREE.DirectionalLight(16777215,.7);o.position.set(-2,8,4),t.add(o);var i=new THREE.SphereBufferGeometry(4e3,32,15),a=new THREE.ShaderMaterial({uniforms:{topColor:{value:(new THREE.Color).setHSL(.6,1,.6)},horizonColor:{value:new THREE.Color(16777215)},bottomColor:{value:new THREE.Color(6710886)},offset:{value:33},topExponent:{value:.6},bottomExponent:{value:.3}},vertexShader:"\t\t\t\t\tvarying vec3 vWorldPosition;\t\t\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4(position, 1.0);\t\t\t\t\t\tvWorldPosition = worldPosition.xyz;\t\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\t\t\t\t\t}",fragmentShader:"\t\t\t\t\tuniform vec3 topColor;\t\t\t\t\tuniform vec3 horizonColor;\t\t\t\t\tuniform vec3 bottomColor;\t\t\t\t\tuniform float offset;\t\t\t\t\tuniform float topExponent;\t\t\t\t\tuniform float bottomExponent;\t\t\t\t\tvarying vec3 vWorldPosition;\t\t\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\t\tfloat h = normalize(vWorldPosition + offset).y;\t\t\t\t\t\tif (h > 0.0)\t\t\t\t\t\t\tgl_FragColor = vec4( mix( horizonColor, topColor, max( pow( h, topExponent ), 0.0 ) ), 1.0);\t\t\t\t\t\telse\t\t\t\t\t\t\tgl_FragColor = vec4( mix( horizonColor, bottomColor, max( pow( abs(h), bottomExponent ), 0.0 ) ), 1.0);\t\t\t\t\t}",side:THREE.BackSide});t.add(new THREE.Mesh(i,a));var r={};r.initGeo=new THREE.Geometry;var s={};s.defaultMat=new THREE.MeshLambertMaterial({name:"defaultMat",color:DV3D.Defaults.objectColor}),s.defaultDoublesideMat=new THREE.MeshLambertMaterial({name:"defaultDoublesideMat",color:DV3D.Defaults.objectColor,side:THREE.DoubleSide}),s.defaultUnsafeMat=new THREE.MeshLambertMaterial({name:"defaultUnsafeMat",color:11184810,transparent:!0,opacity:.5,depthWrite:!1}),s.selectionMat=new THREE.MeshLambertMaterial({name:"selectionMat",color:DV3D.Defaults.selectionColor,side:THREE.DoubleSide}),s.transparentMat=new THREE.MeshLambertMaterial({name:"transparentMat",color:13421772,transparent:!0,opacity:.5,depthWrite:!1}),s.transparentSelectionMat=new THREE.MeshLambertMaterial({name:"transparentSelectionMat",color:DV3D.Defaults.selectionColor,transparent:!0,opacity:.5,depthWrite:!1}),s.wireframeMat=new THREE.MeshBasicMaterial({name:"wireframeMat",color:DV3D.Defaults.edgeColor,wireframe:!0}),s.wireframeSelectionMat=new THREE.MeshBasicMaterial({name:"wireframeSelectionMat",color:DV3D.Defaults.selectionColor,wireframe:!0}),s.highlightMat=new THREE.MeshLambertMaterial({name:"highlightMat",color:16777028}),s.transparentHighlightMat=new THREE.MeshLambertMaterial({name:"transparentHighlightMat",color:16777028,transparent:!0,opacity:.5}),s.xrayMat=new THREE.ShaderMaterial({name:"xrayMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.1},intensity:{type:"f",value:1},vColor:{type:"c",value:new THREE.Color(0)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),s.xraySelectionMat=new THREE.ShaderMaterial({name:"xraySelectionMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.3},intensity:{type:"f",value:1.5},vColor:{type:"c",value:new THREE.Color(DV3D.Defaults.selectionColor)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),s.edgesMat=new THREE.LineBasicMaterial({name:"edgesMat",color:DV3D.Defaults.edgeColor}),s.edgesSelectionMat=new THREE.LineBasicMaterial({name:"edgesSelectionMat",color:DV3D.Defaults.selectionColor}),s.edgesHighlightMat=new THREE.LineBasicMaterial({name:"edgesHighlightMat",color:16777028});var c=new THREE.FontLoader,l={};return c.load("fonts/helvetiker_bold.typeface.json",function(e){l.HelvetikerBold=e}),THREE.DokuVisTray={scene:t,grid:n,directionalLight:o,geometries:r,materials:s,standardGeometries:Object.keys(r),standardMaterials:Object.keys(s),fonts:l,objects:new DV3D.ObjectCollection,plans:new DV3D.Collection,spatialImages:new DV3D.Collection},THREE.DokuVisTray}]),angular.module("dokuvis.viewport").component("viewportNavigation",{templateUrl:"components/dokuvis.viewport/viewportNavigation.tpl.ec4e8328.html",controller:["$scope","viewportSettings",function(o,e){var i=this;this.$onInit=function(){this.navigation={default:!0,rotate:!1,pan:!1,zoom:!1},this.vpSettings=e},this.focus=function(e){o.$parent.focus(e)},this.setNavigationMode=function(e){o.$emit("viewportNavigationChange",e)},o.$on("viewportNavigationChange",function(e,t){var n;n=t,i.navigation.default=!1,i.navigation.rotate=!1,i.navigation.pan=!1,i.navigation.zoom=!1,n&&n in i.navigation?i.navigation[n]=!0:i.navigation.default=!0,o.$applyAsync()})}]}).directive("viewportAxis",["$timeout",function(t){return{restrict:"E",scope:!0,link:function(e,n){var o,i,a,r;function s(){o.render(a,i)}t(function(){var e,t;e=n.width(),t=n.height(),(o=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(e,t),n.append(o.domElement),(i=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,100)).position.set(0,0,50),r=new THREE.AxisHelper(50),(a=new THREE.Scene).add(r),s()}),e.$on("viewportCameraMove",function(e,t){i.rotation.copy(t.rotation),i.position.copy(t.getWorldDirection().negate().setLength(50)),s()}),e.$on("$destroy",function(){r.geometry.dispose(),r.material.dispose(),o.forceContextLoss(),o.dispose()})}}}]).component("viewportCompass",{template:'<div class="north" title="Orient north" ng-click="$ctrl.faceNorth()">N</div>',controller:["$scope","$element","$timeout",function(e,n,t){var o,i,a,r,s;function c(){o.render(a,i)}t(function(){var e,t;e=n.width(),t=n.height(),s=e,(o=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(e,t),n.append(o.domElement),(i=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,100)).position.set(0,0,s),a=new THREE.Scene,(new THREE.TextureLoader).load("img/compass_v01.52931ae1.png",function(e){e.anisotropy=8;var t=new THREE.PlaneBufferGeometry(s-1,s-1);t.rotateX(-Math.PI/2);var n=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});r=new THREE.Mesh(t,n),a.add(r),c()})}),this.faceNorth=function(){e.$parent.faceNorth()},e.$on("viewportCameraMove",function(e,t){i.rotation.copy(t.rotation),i.position.copy(t.getWorldDirection().negate().setLength(s)),c()}),e.$on("$destroy",function(){r.geometry.dispose(),r.material.dispose(),o.forceContextLoss(),o.dispose()})}]}).component("viewportLoadProgress",{template:'<div class="loadprogress-bar ng-hide" ng-show="$ctrl.visible" ng-style="{ width: $ctrl.progress + \'%\' }"></div>\n<div class="loadprogress-label ng-hide" ng-show="$ctrl.visible">{{ $ctrl.item }} &ndash; {{ $ctrl.loaded }} / {{ $ctrl.total }}</div>',controller:["$scope",function(i){var a=this;this.$onInit=function(){this.visible=!1,this.item="",this.loaded=0,this.total=0,this.progress=0},i.$on("viewportLoadProgress",function(e,t,n,o){a.visible||(a.progress=n/o*100,a.visible=!0,i.$apply()),a.item=t,a.loaded=n,a.total=o,a.progress=n/o*100,100===a.progress&&(a.visible=!1,i.$applyAsync())})}]}).component("viewportSpatializeManual",{templateUrl:"/components/dokuvis.viewport/viewportSpatializeManual.tpl.7046bc90.html",controller:["$scope","$rootScope","Utilities",function(a,t,n){var e,r,s,c=this;this.$onInit=function(){e=this.source=a.$parent.source,r=this.camera=a.$parent.camera,s=a.$parent.controls,this.opacity=50,this.moveStep=.2},this.transformView=function(e){var t,n,o=new THREE.Vector3(0,1,0).applyQuaternion(r.quaternion),i=(new THREE.Vector3).subVectors(s.center,r.position).normalize();switch(e){case"up":t=new THREE.Vector3(0,c.moveStep,0),n=o;break;case"down":t=new THREE.Vector3(0,-c.moveStep,0),n=o.negate();break;case"left":t=new THREE.Vector3(-c.moveStep,0,0),n=o.cross(i);break;case"right":t=new THREE.Vector3(c.moveStep,0,0),n=o.cross(i).negate();break;case"forward":t=new THREE.Vector3(0,0,-c.moveStep);break;case"backward":t=new THREE.Vector3(0,0,c.moveStep);break;case"tilt-up":n=new THREE.Vector3(0,c.moveStep,0);break;case"tilt-down":n=new THREE.Vector3(0,-c.moveStep,0)}t&&r.translateOnAxis(t,c.moveStep),n&&(n.setLength(c.moveStep),s.center.add(n)),a.$parent.animate()},this.changeFOV=function(){r.updateProjectionMatrix(),a.$parent.animate()},this.save=function(){e&&r&&(e.spatialize={matrix:r.matrixWorld.toArray(),offset:[0,0],ck:1/Math.tan(r.fov/2*THREE.Math.DEG2RAD)*.5},e.$spatialize({method:"manual"}).then(function(e){console.log(e),t.$broadcast("searchUpdate"),c.close()}).catch(function(e){n.throwApiException("#Source.spatialize",e)}))},this.close=function(){a.$parent.close()}}]}).directive("viewportSnapshot",["$rootScope",function(o){return{templateUrl:"components/dokuvis.viewport/viewportSnapshot.e66a2239.html",restrict:"E",scope:!0,link:function(t,n){t.mode="paint",t.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1,width:t.size.width,height:t.size.height},t.setMode=function(e){"pin"===(t.mode=e)?t.startPinning():t.abortPinning()},t.$on("snapshotPrepareSave",function(){var e;e=n.find("#pwCanvasMain")[0].toDataURL("image/png"),o.$broadcast("snapshotPainting",e)}),n.on("$destroy",function(){t.$destroy()})}}}]).directive("viewportSnapshotView",function(){return{templateUrl:"components/dokuvis.viewport/viewportSnapshotView.tpl.5da3350b.html",restrict:"E",scope:!0,link:function(e,t){e.screenOpacity=0,e.paintOpacity=1,t.on("$destroy",function(){e.$destroy()})}}}).component("viewportImageControls",{templateUrl:"components/dokuvis.viewport/viewportImageCtrls.tpl.1c61c567.html",controller:["viewportCache","viewportSettings",function(e,t){var n=this;this.$onInit=function(){this.opacity=100*t.images.opacity,this.scale=t.images.scale},this.setOpacity=function(){e.spatialImages.setOpacity(n.opacity/100),t.images.opacity=n.opacity/100},this.setScale=function(){e.spatialImages.forEach(function(e){e.setScale(n.scale)}),t.images.scale=n.scale}}]}).component("viewportSelectionDisplay",{templateUrl:"components/dokuvis.viewport/viewportSelectionDisplay.tpl.e04582f6.html",controller:["$scope","$rootScope","$state","DigitalObject",function(e,t,n,o){var i=this;this.$onInit=function(){this.imageList=[],this.objectList=[],this.inIsolationMode=!1,this.includesList=[],this.excludesList=[],n.params.filterObjIncl.forEach(function(e){o.get({id:e}).$promise.then(function(e){console.log(e),i.includesList.push({id:e.id,name:e.obj.name,label:e.obj.name})})}),n.params.filterObjExcl.forEach(function(e){o.get({id:e}).$promise.then(function(e){i.excludesList.push({id:e.id,name:e.obj.name,label:e.obj.name})})})},e.$on("viewportSelectionChange",function(e,t){i.imageList=t.filter(function(e){return e instanceof DV3D.ImageEntry}),i.objectList=t.filter(function(e){return e instanceof DV3D.ObjectEntry})}),this.exitIsolation=function(){e.$parent.exitIsolation()},e.$on("viewportIsolationEnter",function(){i.inIsolationMode=!0}),e.$on("viewportIsolationExit",function(){i.inIsolationMode=!1}),this.removeFilterObject=function(e){t.$broadcast("filterByObject",e,"remove")},e.$on("filterByObject",function(e,t,n){switch(n){case"include":i.includesList.push(t);break;case"exclude":i.excludesList.push(t);break;default:var o=i.includesList.findIndex(function(e){return e.name===t.name});-1!==o&&i.includesList.splice(o,1),-1!==(o=i.excludesList.findIndex(function(e){return e.name===t.name}))&&i.excludesList.splice(o,1)}})}]}).component("viewportContextMenu",{templateUrl:"components/dokuvis.viewport/viewportContextMenu.tpl.a538615a.html",controller:["$scope","$element","$rootScope","$state","$timeout","ImageCollection",function(t,n,o,e,i,a){var r=this;this.$onInit=function(){this.entry=t.$parent.entry,this.position={x:-999,y:-999},i(function(){var e=n.find(".context-menu-dialog");r.position.x=Math.min(t.$parent.position.x,n.width()-e.width()),r.position.y=Math.min(t.$parent.position.y,n.height()-e.height())}),this.isImage=this.entry instanceof DV3D.ImageEntry,this.isObject=this.entry instanceof DV3D.ObjectEntry,this.isDummyImage=/_dummy$/.test(this.entry.name),this.isObject&&(-1!==e.params.filterObjIncl.indexOf(this.entry.name)&&(this.isIncluded=!0),-1!==e.params.filterObjExcl.indexOf(this.entry.name)&&(this.isExcluded=!0))},this.openDetails=function(){e.go(".image",{imageId:this.entry.source.id}),t.$parent.close()},this.addToCollection=function(){a.add(this.entry.source),t.$parent.close()},this.removeFromCollection=function(){a.remove(this.entry.source),t.$parent.close()},this.focus=function(){this.entry.focus(),t.$parent.close()},this.filterByObject=function(e){o.$broadcast("filterByObject",this.entry,e),t.$parent.close()},this.deleteDummyImage=function(){t.$parent.deleteDummy(this.entry),t.$parent.close()}}]}).component("viewportTooltip",{templateUrl:"components/dokuvis.viewport/viewportTooltip.tpl.eb3eee44.html",controller:["$scope","$element","$timeout",function(a,r,e){var s=this;this.$onInit=function(){this.entry=a.$parent.entry,this.position={x:-999,y:-999},this.isImage=this.entry instanceof DV3D.ImageEntry,this.isObject=this.entry instanceof DV3D.ObjectEntry,this.tooltipCss={};var i=r.find(".tooltip-dialog");i.find("img.tooltip-image").on("load",function(){s.tooltipCss.image={left:Math.min(0,r.width()-a.$parent.position.x-i.width()),top:Math.min(0,r.height()-a.$parent.position.y-i.height())},a.$applyAsync()}),e(function(){var e=i.find("[ng-bind]"),t=e.position(),n=0<a.$parent.position.y+t.top,o=r.width()-a.$parent.position.x-e.outerWidth();s.tooltipCss.label={transform:"translate("+Math.min(o,Math.max(-10,-a.$parent.position.x))+"px,"+(n?"-100%":"0")+")",top:n?"-20px":"20px"},s.tooltipCss.line={top:n?"-20px":"0"},s.position=a.$parent.position})}}]}).component("viewportAnalysisTools",{templateUrl:"components/dokuvis.viewport/viewportAnalysisTools.tpl.be013860.html",controller:["$scope","$debounce",function(t,e){var n=this;function o(e){t.$emit("viewportHeatMapUpdate",angular.extend(e,{type:n.analysis.type,visible:n.analysis.visible,overlay:n.analysis.overlay,radius:n.analysis.radius,useWeight:n.analysis.disWeight?"disWeight":"countWeight"}))}this.$onInit=function(){n.analysis={type:"heatMap",visible:!1,overlay:!1,radius:40,disWeight:!1,toggle:function(){o({typeChange:!0,overlayChange:!0})},toggleOverlay:function(){o({overlayChange:!0})},changeType:function(){o({typeChange:!0,overlayChange:!0})},changeRadius:e(function(){o({radiusChange:!0})},1e3),changeSetting:function(){o({settingsChange:!0})}}},this.linkToObjects=function(){t.$parent.linkToObjects()},this.toggleDummyCreationMode=function(){n.dummyCreationMode=t.$parent.toggleDummyCreationMode()}}]}),angular.module("dokuvis.viewport").directive("viewportObjectTree",["viewportCache",function(e){return{templateUrl:"components/dokuvis.viewport/viewportObjectTree.tpl.42bf6dea.html",restrict:"E",link:function(t){t.objects=e.objects,t.layers=e.objects.layers,t.hierarchy=e.objects.hierarchy,t.showLayers=!1,t.showHierarchy=!0,t.switchTo=function(e){switch(e){case"layers":t.showLayers=!0,t.showHierarchy=!1;break;default:t.showLayers=!1,t.showHierarchy=!0}}}}}]).directive("viewportPlanList",["viewportCache",function(t){return{templateUrl:"components/dokuvis.viewport/viewportPlanList.tpl.7c5d4820.html",restrict:"E",link:function(e){e.plans=t.plans}}}]).directive("viewportImageList",["viewportCache",function(t){return{templateUrl:"components/dokuvis.viewport/viewportImageList.tpl.a009c803.html",restrict:"E",link:function(e){e.images=t.spatialImages}}}]),angular.module("dokuvis.imageViewer",[]).directive("imageViewer",["$document","$window","$timeout","SpatializeInterface","$debounce","$log",function(U,W,N,F,B,_){return{restrict:"E",template:'<div class="ctrl-container ctrl-bottom-left" ng-if="grid">\n\t<div>\n\t\t<div class="ctrl-group">\n\t\t\t<input type="checkbox" ng-model="grid.visible" ng-change="grid.onVisibilityChange()"/> Show grid\n\t\t</div>\n\t\t<div class="ctrl-group" ng-show="grid.visible">\n\t\t\t<div class="ctrl-slider">\n\t\t\t<span>Size</span>\n\t\t\t<input class="dvSlider" type="range" min="0" max="100" step="1" ng-model="grid.size" ng-change="grid.onSizeChange()"/>\n\t\t</div>\n\t</div>\n\t</div>\n</div>',scope:{source:"=src",options:"=options"},link:function(n,o,e){angular.element(o).css("overflow","hidden");var i,a,r,s,c,l,u,p,d,f,m,g,h,t,v=!1,E=!1,y=!1,w=!1,b=!1,x=.0015,T=.1,M=-.05,$=-1,D=new THREE.TextureLoader;function j(){n.$applyAsync()}U.on("mouseup",V),angular.element(W).on("resize",j);var R=B(function(){A()},200,!1,!1);function H(e){-1!==["jpg","png"].indexOf(e.split(".").pop())&&(E=!0,console.log("source:",e),v&&(y||(u.add(m),y=!0),D.load(e,function(e){r=n.options&&n.options.width&&n.options.height?n.options.width/n.options.height:e.image.width/e.image.height,n.spatialize&&(F.imageWidth=n.options.width||e.image.width,F.imageHeight=n.options.height||e.image.height),m.geometry.dispose(),m.geometry=new THREE.PlaneBufferGeometry(r,1,1,1),m.material.map&&m.material.map.dispose(),m.material.map=e,m.material.needsUpdate=!0,L()},null,function(){console.error("ImageViewer: Couldn't load texture!")})))}function C(){p.render(u,d)}function S(e){e.preventDefault(),(0===e.button&&!b||1===e.button)&&(w=!0)}function V(e){if(!w||0!==e.button&&1!==e.button){if(0===e.button&&b){var t=h;g.setNumber(F.markers2D.length+1),F.markers2D.push({object:g,u:t.x,v:t.y,x:(t.x-.5)*r,y:t.y-.5}),b=!1,g=null,C(),n.$applyAsync()}}else w=!1}function k(e){if(e.preventDefault(),w)m.translateX(e.originalEvent.movementX*x*-m.position.z),m.translateY(e.originalEvent.movementY*x*m.position.z),O(),C();else if(b){var t=new THREE.Vector2;t.x=e.offsetX/i*2-1,t.y=-e.offsetY/a*2+1,function(e){var t=new THREE.Vector3(e.x,e.y,.5).unproject(d),n=new THREE.Raycaster(d.position,t.sub(d.position).normalize()).intersectObject(m);if(n[0]){var o=n[0].uv;h=o,g.position.set(o.x*r-r/2,o.y-.5,0)}}(t),C()}}function I(e){if(e.originalEvent.deltaY<0){var t=-T*m.position.z;if(m.position.z+t>M)return;m.translateZ(t),O(),C()}else 0<e.originalEvent.deltaY&&(t=T*m.position.z,m.position.z+t<=$&&(t=$-m.position.z),m.translateZ(t),O(),C())}function O(){var e=Math.abs(m.position.z)*Math.tan(c),t=Math.abs(m.position.z)*Math.tan(l),n=2*e,o=2*t,i=Math.abs(m.position.x-r/2)+Math.abs(m.position.x+r/2),a=Math.abs(m.position.y-.5)+Math.abs(m.position.y+.5);r<s&&i<n?(e<m.position.x+r/2&&m.translateX(e-(m.position.x+r/2)),-e>m.position.x-r/2&&m.translateX(-e-(m.position.x-r/2))):(e>m.position.x+r/2&&m.translateX(e-(m.position.x+r/2)),-e<m.position.x-r/2&&m.translateX(-e-(m.position.x-r/2))),s<r&&a<o?(t<m.position.y+.5&&m.translateY(t-(m.position.y+.5)),-t>m.position.y-.5&&m.translateY(-t-(m.position.y-.5))):(t>m.position.y+.5&&m.translateY(t-(m.position.y+.5)),-t<m.position.y-.5&&m.translateY(-t-(m.position.y-.5)))}function L(){if(r<s)m.position.set(0,0,-1),$=-1;else{var e=r/2/Math.tan(c);m.position.set(0,0,-e),$=-e}C()}function z(){angular.forEach(F.markers2D,function(e){m.remove(e.object),e.object.dispose()}),F.markers2D.splice(0,F.markers2D.length),C(),n.$applyAsync()}function A(e,t){i=e||o.width(),a=t||o.height(),s=i/a,c=Math.atan(.5*s),l=Math.atan(.5);var n=m&&m.position.z===$;$=r&&s<r?-r/2/Math.tan(c):-1,d&&(d.aspect=s,d.updateProjectionMatrix()),p&&(p.setSize(i,a),m&&n?L():C())}function P(e){var t=Math.log(.1),n=(Math.log(2)-t)/100;return Math.exp(t+n*(e-0))}n.$watch(function(){R()}),n.$watch("source",H),N(function(){A(),function(){u=new THREE.Scene,(p=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setClearColor(16777215,0),p.setSize(i,a),o.append(p.domElement),(d=new THREE.PerspectiveCamera(2*l*180/Math.PI,s,.01,500)).lookAt(new THREE.Vector3(0,0,-1));var e=new THREE.PlaneBufferGeometry(1,1,1,1),t=new THREE.MeshBasicMaterial;(m=new THREE.Mesh(e,t)).position.set(0,0,-1),(f=angular.element(p.domElement)).on("mousedown",S),f.on("mousemove",k),f.on("wheel",I),f.on("contextmenu",function(e){e.preventDefault()}),v=!0,C()}(),E&&H(n.source)}),"spatialize"in e&&(n.spatialize={markers:F.markers2D}),n.spatialize&&(n.startMarking=function(){(g=new DV3D.TorusMarker(.008)).addEventListener("change",C),m.add(g),b=!0},n.clearMarkers=z),"grid"in e&&(n.grid={visible:!1,size:50,onSizeChange:function(){var e=P(this.size);t.scale.set(e,e,e),C()},onVisibilityChange:function(){if(!this.visible||t&&m.getObjectById(t.id))m.remove(t);else{if(!t){(t=new THREE.GridHelper(20,200,65280,16776960)).material.transparent=!0,t.material.opacity=.5,t.rotateX(Math.PI/2),t.position.set(0,0,.01);var e=P(this.size);t.scale.set(e,e,e)}m.add(t)}C()}}),n.$on("$destroy",function(){m&&(m.geometry.dispose(),m.material.map&&m.material.map.dispose(),m.material.dispose()),t&&(m.geometry.dispose(),m.material.dispose()),p&&(p.forceContextLoss(),p.dispose(),p=null),n.spatialize&&z(),U.off("mouseup",V),angular.element(W).off("resize",j),_.debug("destroy imageViewer directive")})}}}]),angular.module("uh4d.images",["ngResource","xeditable","ngTagsInput","dndLists","uh4d.actors"]).run(["editableOptions","editableThemes",function(e,t){e.theme="bs3",t.bs3.buttonsClass="btn-sm",t.bs3.inputClass="form-control-sm",t.bs3.submitTpl='<button type="submit" class="btn btn-primary"><span class="fa fa-check"></span></button>',t.bs3.cancelTpl='<button type="button" class="btn btn-default" ng-click="$form.$cancel()"><span class="fa fa-times"></span></button>'}]).factory("Image",["$resource",function(e){return e("api/image/:id",{id:"@id"},{query:{url:"api/search",method:"GET",isArray:!0},update:{method:"PUT"},spatialize:{method:"PUT",url:"api/image/:id/spatial"},checkFileUpdate:{url:"api/image/:id/file/check",method:"GET"},updateFile:{url:"api/image/:id/file/update",method:"GET"},setLinksToObjects:{url:"api/image/:id/link",method:"PUT"},createDummy:{url:"api/image/dummy",method:"POST"},deleteDummy:{url:"api/image/dummy/:id",method:"DELETE"}})}]).component("imageList",{templateUrl:"components/uh4d.images/imageList.tpl.806b856b.html",controller:["$scope","$element","$state","Image","Utilities","viewportCache","$debounce","ImageCollection",function(e,t,o,n,i,a,r,s){var c=this;function l(){c.images&&c.images.length&&c.images.forEach(function(e){s.get(e.id)?e.inCollection=!0:!0===e.inCollection&&(e.inCollection=!1)})}c.images=[],c.itemsPerPage=20,c.$onInit=function(){c.listTab="selection",c.listMode="list",c.listOrderBy={prop:"title",desc:!1},c.page=0,c.selection=[],s.promise.then(function(e){c.collection=e,l()})},e.$on("imageQuerySuccess",function(e,t){c.images=t,c.currentPage=1,l()}),e.$on("viewportSelectionChange",function(e,t){console.log(t),c.selection=t.filter(function(e){return e instanceof DV3D.ImageEntry}).map(function(e){return e.source})}),e.$on("ImageCollectionUpdate",function(){l()}),e.$on("imageUpdate",function(e,t,n){if(!0===n){var o=c.images.findIndex(function(e){return e.id===t.id});c.images.splice(o,1)}else{var i=c.images.find(function(e){return e.id===t.id});i?angular.extend(i,t):c.images.push(t)}}),c.openImage=function(e){o.go(".image",{imageId:e})},c.openCompareModal=function(e,t,n){e.stopPropagation(),o.go(".compare",{imageId1:t.id,imageId2:n.id})},c.setListTab=function(e){e===c.listTab?c.listTab="":c.listTab=e},c.setListMode=function(e){switch(e){case"list":case"cards":c.listMode=e}},c.onPaginationChange=function(){t.find(".list-body").scrollTop(0)},c.addToCollection=function(e,t){e.stopPropagation(),s.add(t),c.collection=s.get()},c.removeFromCollection=function(e,t){e.stopPropagation(),s.remove(t),c.collection=s.get()},c.collectionChangedByDnd=function(e){c.collection.splice(e,1),s.updateStorage()},c.focusImage=function(e,t){if(e.stopPropagation(),t){var n=a.spatialImages.getByName(t.id);console.log(n),n&&n.focus()}}}]}).component("imageModal",{templateUrl:"components/uh4d.images/imageModal.tpl.e2eb0aa1.html",controller:["$rootScope","$state","$timeout","Image","Utilities","ImageCollection","Person","LegalBody","$http",function(o,e,t,i,a,r,n,s,c){var l=this;function u(e){o.$broadcast("imageUpdate",e)}l.$onInit=function(){t(function(){!function(n){if(!n)return;i.get({id:n}).$promise.then(function(e){var t;console.log(e),l.image=e,l.tags=e.tags.map(function(e){return{text:e}}),r.get(n)&&(l.image.inCollection=!0),o.editableMode&&(t=n,i.checkFileUpdate({id:t}).$promise.then(function(e){e.message||(l.fileUpdate=e)}).catch(function(e){a.throwApiException("Image.checkFileUpdate",e)}))}).catch(function(e){a.throwApiException("Image.get",e)})}(e.params.imageId)},0,!1)},l.addToCollection=function(){r.add(l.image)},l.removeFromCollection=function(){r.remove(l.image)},l.startSpatialize=function(){e.go("^"),o.$broadcast("triggerSpatializeManual",l.image)},l.updateImage=function(t,e){if(l.image[t]===e)return!1;var n=l.image[t];return"tags"===t?l.image.tags=e.map(function(e){return e.text}):l.image[t]=e,l.image.$update({prop:t}).then(function(e){return console.log(e),u(l.image),!1}).catch(function(e){return a.throwApiException("Image.update",e),l.image[t]=n,!1})},l.updateFile=function(){l.isSaving=!0,i.updateFile({id:l.image.id}).$promise.then(function(e){console.log(e),l.image.file=e,l.fileUpdate=null,u(l.image),l.isSaving=!1}).catch(function(e){a.throwApiException("Image.updateFile",e),l.isSaving=!1})},l.queryPersons=function(e){return n.query({name:e}).$promise.then(function(e){return e.map(function(e){return e.name})}).catch(function(e){a.throwApiException("Person.query",e)})},l.queryLegalBodies=function(e){return s.query({name:e}).$promise.then(function(e){return e.map(function(e){return e.name})}).catch(function(e){a.throwApiException("LegalBody.query",e)})},l.queryTags=function(e){return c.get("api/tag?query="+e).then(function(e){return console.log(e),e.data.map(function(e){return e.tag})}).catch(function(e){a.throwApiException("$http.get api/tag",e)})},l.close=function(){e.go("^")}}]}).component("compareModal",{templateUrl:"components/uh4d.images/compareModal.tpl.170ab045.html",controller:["$q","$state","$timeout","Image","Utilities",function(n,e,t,o,i){var a=this;function r(e){var t=n.defer();return o.get({id:e}).$promise.then(function(e){t.resolve(e)}).catch(function(e){i.throwApiException("Image.get",e),t.resolve(null)}),t.promise}a.$onInit=function(){t(function(){r(e.params.imageId1).then(function(e){a.image1=e}),r(e.params.imageId2).then(function(e){a.image2=e})},0,!1)},a.close=function(){e.go("^")}}]}).service("ImageCollection",["$window","$rootScope","$q","Image","Utilities",function(i,e,a,r,s){var c=[],l=i.localStorage.collectionIds?angular.fromJson(i.localStorage.collectionIds):[],t=[],n=a.defer();function u(){e.$broadcast("ImageCollectionUpdate",c)}l.forEach(function(e){t.push(r.get({id:e}).$promise)}),a.all(t).then(function(e){e.forEach(function(e){e&&(e.inCollection=!0,c.push(e))}),n.resolve(c)}),this.promise=n.promise,this.get=function(t){return t?c.find(function(e){return e.id===t}):c},this.add=function(e){if(e){var t,n,o="string"==typeof e?e:e.id;if(-1===l.indexOf(o))l.push(o),i.localStorage.collectionIds=angular.toJson(l),"string"==typeof e?(t=o,n=a.defer(),r.get({id:t}).$promise.then(function(e){n.resolve(e)}).catch(function(e){s.throwApiException("Image.get() in ImageCollection",e),n.resolve()}),n.promise).then(function(e){e&&(e.inCollection=!0,c.push(e))}):(e.inCollection=!0,c.push(e)),u()}},this.remove=function(e){if(e){var t="string"==typeof e?e:e.id,n=l.indexOf(t);-1!==n&&(l.splice(n,1),i.localStorage.collectionIds=angular.toJson(l),-1!==(n=c.findIndex(function(e){return e.id===t}))&&c.splice(n,1),e.inCollection&&(e.inCollection=!1),u())}},this.updateStorage=function(){l=c.map(function(e){return e.id}),i.localStorage.collectionIds=angular.toJson(l)}}]),angular.module("uh4d.models",["ngResource"]).factory("DigitalObject",["$resource",function(e){function i(e,t){for(var n=0;n<e.length;n++){if(e[n].id===t)return e[n];if(e[n].children){var o=i(e[n].children,t);if(void 0!==o)return o}}}var a=e("api/model/:id",{id:"@id"},{query:{method:"GET",isArray:!0,transformResponse:function(e){return function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.children||(n.children=[]),n.parent){var o=i(e,n.parent);o&&(o.children||(o.children=[]),o.children.push(new a(n)),e.splice(t,1),t--)}}return e}(angular.fromJson(e))}}});return a}]),angular.module("uh4d.actors",["ngResource"]).factory("Person",["$resource",function(e){return e("api/person/:id",{id:"@id"})}]).factory("LegalBody",["$resource",function(e){return e("api/legalbody/:id",{id:"@id"})}]);