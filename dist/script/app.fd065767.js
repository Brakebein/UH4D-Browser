!function(){"use strict";angular.module("ngDebounceThrottle",[]).factory("$debounce",["$rootScope","$timeout",function(u,p){return function(t,n,a,o){var i,r,s,c,l=function(){!(s=null)!==a&&(!1!==o&&u.$applyAsync(),c=t.apply(i,r))};function e(){i=this,r=arguments;var e=a&&!s;return s&&p.cancel(s),s=p(l,n,!1),e&&(!1!==o&&u.$applyAsync(),c=t.apply(i,r)),c}return e.cancel=function(){p.cancel(s),s=null},e}}]).factory("$throttle",["$rootScope","$timeout",function(m,f){return function(n,a,o,i,r){var s,c,l,u,p=0,d=function(){p=!1===o?0:(new Date).getTime(),!(l=null)===r&&m.$applyAsync(),u=n.apply(s,c),l||(s=c=null)},e=function(){s=this,c=arguments;var e=(new Date).getTime();p||!1!==o||(p=e);var t=a-(e-p);return t<=0||a<t?(l&&(f.cancel(l),l=null),p=e,!0===r&&m.$applyAsync(),u=n.apply(s,c),l||(s=c=null)):l||!1===i||(l=f(d,t,!1)),u};return e.cancel=function(){f.cancel(l),p=0,l=s=c=null},e}}])}(),angular.module("uh4dApp",["ui.router","ngAnimate","ngResource","mgcrea.ngStrap","ui.bootstrap","ng-clamp","dokuvis.viewport","dokuvis.utils","dokuvis.imageViewer","uh4d.images","uh4d.models"]).config(["$stateProvider","$urlRouterProvider","$modalProvider","$uibModalProvider",function(e,t,n,a){t.otherwise("/"),e.state({name:"root",url:"?edit",abstract:!0,views:{root:{template:"<ui-view></ui-view>"},header:"header"},params:{edit:{type:"query",value:null}}}).state({name:"root.home",url:"/",templateUrl:"partials/home.32280aee.html"}).state({name:"root.search",url:"/search?query&page",component:"search",params:{query:{type:"query",dynamic:!0,value:null},page:{type:"query",dynamic:!0,value:null}}}).state({name:"root.search.image",url:"/image/:imageId",redirectTo:function(e){if(!e.params().imageId)return"root.search"},params:{imageId:{dynamic:!0}},resolve:{imageModalInstance:["$uibModal",function(e){return e.open({component:"imageModal",size:"large"})}]},onExit:["imageModalInstance",function(e){e.close()}]}).state({name:"root.search.compare",url:"/compare?imageId1&imageId2",redirectTo:function(e){if(!e.params().imageId1||!e.params().imageId2)return"root.search"},resolve:{compareModalInstance:["$uibModal",function(e){return e.open({component:"compareModal",size:"xlarge"})}]},onExit:["compareModalInstance",function(e){e.close()}]}).state({name:"root.help",url:"/help",templateUrl:"partials/help.708fd659.html"}),angular.extend(n.defaults,{backdrop:"static",keyboard:!1}),angular.extend(a.options,{animation:!1,backdrop:"static",keyboard:!1})}]).run(["$rootScope","$state",function(t,e){t.showModelLoadPanel=!0,t.$watch(function(){return e.params.edit},function(e){t.editableMode="true"===e})}]),angular.module("uh4dApp").component("header",{templateUrl:"app/header/header.tpl.7811cb19.html",controller:["$rootScope","$state",function(n,e){var a=this;a.$onInit=function(){},a.submitSearch=function(){e.go("root.search",{query:a.searchTerm})},n.$watch(function(){return e.params.query},function(e){var t;a.searchTerm=e,t=a.searchTerm,n.$broadcast("updateSearchTerm",t)})}]}),angular.module("uh4dApp").component("search",{templateUrl:"app/search/search.tpl.8dd75db6.html",controller:["$rootScope","$state","$uiRouterGlobals","Image","DigitalObject","Utilities",function(o,e,t,n,a,i){var r=this;function s(e){n.query({query:e}).$promise.then(function(e){var t,n,a;console.log(e),t=e,o.$broadcast("imageQuerySuccess",t),n=[],e.forEach(function(e){e.spatial&&n.push(e)}),a=n,o.$broadcast("spatialImageLoad",a,!0)}).catch(function(e){i.throwApiException("Image.query() in search component",e)})}r.$onInit=function(){e.params.query?s(e.params.query):s("")},o.$on("updateSearchTerm",function(e,t){console.log("updateSearchTerm",t),s(t)}),r.loadModel=function(){a.query().$promise.then(function(e){var t,n;console.log(e),o.showModelLoadPanel=!1,t=e,o.$broadcast("modelQuerySuccess",t,!0===n)}).catch(function(e){i.throwApiException("DigitalObject.query",e)})},o.$on("spatializeManualSuccess",function(){r.performSearch()})}]}),angular.module("uh4dApp").factory("webglInterface",["$rootScope","$anchorScroll","$debounce",function(i,t,e){var r={callFunc:{}};DV3D.callFunc=r.callFunc,r.viewportSettings={shading:["color","grey","transparent","onlyEdges","xray","Custom"],camera:["Perspective","Top","Front","Back","Left","Right","Custom"],edges:!0,ssao:"aa"},r.viewportSettings.shadingSel=r.viewportSettings.shading[0],r.viewportSettings.cameraSel=r.viewportSettings.camera[0],r.unsafeSettings={},r.categories=[],r.activeCategory=null,r.vPanel={},r.vPanel.expand=!1,r.vPanel.activeTab=0,r.vizSettings={opacitySelected:100,edges:!0,edgesOpacity:100,edgesColor:100},r.snapshot={active:!1,mode:"paint",text:"",title:"",refObj:[],refSrc:[],screenshots:[]},r.snapshot.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1},r.spatialize={active:!1,opacity:50,image:null,fov:35},r.listProperties={plans:{visible:!0,opacity:1},images:{visible:!0,scale:10,opacity:1}},r.objects=[],r.layerList=[],r.layers=[],r.hierarchList=[],r.selected=[],r.plans=new DV3D.Collection,r.spatialImages=new DV3D.Collection;var s={};function c(e,t){for(var n=0,a=e.length;n<a;n++){var o=e[n];if(o.id===t)return o;var i=c(o.children,t);if(void 0!==i)return i}}function a(e){for(var t=0;t<r.plans.length;t++)if(r.plans[t].id===e)return r.plans[t]}r.insertIntoLists=function(e){var t,n,a,o=new r.ObjectEntry(e);t=o,void 0!==(n=c(r.hierarchList,t.parent))?(t.parent=n).children.push(t):(t.parent=null,r.hierarchList.push(t)),a=o,r.layerList.push(a),a.layer in s?s[a.layer].count++:(s[a.layer]={count:1},r.layers.push({name:a.layer,visible:!0,expand:!1})),i.$applyAsync()},r.insertIntoPlanlist=function(e){e.visible=!0,e.selected=!1,e.opacity=1,r.plans.push(e),i.$applyAsync()},r.clearLists=function(){console.log("clearList"),r.layerLists=[],r.layers=[],r.hierarchList=[]},r.ObjectEntry=function(e){this.id=e.id,this.name=e.name,this.title=e.title,this.type=e.type,this.layer=e.layer||0,this.parent=e.parent||null,this.children=[],this.parentVisible=!0,this.visible=!0,this.selected=!1,this.expand=!1,this.opacity=1;var t=this;this.toggle=function(){t.visible=!t.visible,!t.visible&&t.selected&&r.callFunc.selectObject(t.id,!1,!0),r.callFunc.toggleObject(t,t.visible)},this.select=function(e){t.visible&&e&&r.callFunc.selectObject(t.id,e.ctrlKey,!1)},this.setOpacity=function(e){r.callFunc.setObjectOpacity(t,e)},this.focus=function(){r.callFunc.focusObject(t.id)},this.showSources=function(){r.callFunc.highlightSources(t)}},r.selectListEntry=function(e,t){var n="plan"===t.type?a(e):c(r.hierarchList,e);n&&(n.selected=!0,r.selected.push(t),n.parent&&function e(t){t.expand=!0;t.parent&&e(t.parent)}(n.parent),o(n.id),i.$applyAsync())},r.deselectListEntry=function(e,t){var n="plan"===t.type?a(e):c(r.hierarchList,e);n&&(n.selected=!1,r.selected.splice(r.selected.indexOf(t),1),i.$applyAsync())};var o=e(function(e){console.log("anchorScroll called","list"+e),t("list"+e)},200,!0);return r}]),angular.module("uh4dApp").factory("SpatializeInterface",function(){var a={callFunc:{},markers2D:[],markers3D:[],imageWidth:0,imageHeight:0,getDLTInputs:function(){if(a.markers2D.length!==a.markers3D.length)return console.warn("Missing markers!"),void console.log(a.markers2D,a.markers3D);for(var e="",t=0,n=a.markers2D.length;t<n;t++)e+=[t+1,a.markers3D[t].x,a.markers3D[t].y,a.markers3D[t].z,1e3*a.markers2D[t].x,1e3*a.markers2D[t].y,"\n"].join(" ");return console.log(e),e}};return a}),angular.module("dokuvis.utils",["mgcrea.ngStrap","pascalprecht.translate"]).factory("Utilities",["$timeout","$alert",function(i,a){var r={waitfor:function(e,t,n,a,o){e()===t?o(a):setTimeout(function(){r.waitfor(e,t,n,a,o)},n)},dblclickSwitch:function(t,n){return function(e){a?(a=!1,o&&i.cancel(o),n&&n(e)):o=i(function(){a=!1,t&&t(e)},300,!(a=!0))};var a,o},dangerAlert:function(e){a({content:e,type:"danger",duration:5})},throwException:function(e,t,n){a({title:e+":",content:t,type:"danger",duration:5}),console.error(e+": "+t,n,"\n"+(new Error).stack.split("\n")[2])},throwApiException:function(e,t){403===t.status&&(e="Access denied "+e+" ("+t.statusText+" "+t.status+")"),a({title:"API Exception:",content:e,type:"danger",duration:5}),console.error("API Exception: "+e,t,"\n"+(new Error).stack.split("\n")[2])}};return r}]).factory("ConfirmDialog",["$q","$alert",function(i,r){var s={backdrop:"static",templateUrl:"components/dokuvis.utils/confirmAlert.tpl.fdb2729a.html",show:!0},c={abortButtonText:"abort",actionButtonText:"OK",headerText:"continue?",bodyText:"Sind Sie sicher?",type:"warning",translationData:{}};return function(e,t){return t||(t={}),function(e,t){var n={},a={};angular.extend(n,s,t),angular.extend(a,c,e),n.alertOptions=a;var o=i.defer();return n.controller=function(e){e.alertOptions=a,e.alertOptions.ok=function(){e.$hide(),o.resolve()},e.alertOptions.abort=function(){e.$hide(),o.reject()}},r(n),o.promise}(e,t)}}]).directive("fileDropArea",["$timeout","$state",function(e,o){return{restrict:"AE",scope:{uploader:"=",label:"@"},link:function(t,n,a){e(function(){var e=angular.element(n);"uiSref"in a&&(e.find("input").remove(),t.uploader.onAfterAddingAll=function(){o.includes(a.uiSref)||o.includes("**"+a.uiSref)||o.go(a.uiSref)}),"multiple"in a&&e.find("input").attr("multiple",!0),"column"in a&&e.children().css("flex-direction","column")}),t.openFileDialog=function(){e(function(){angular.element(n).find("input").trigger("click")})}},template:'<div ng-if="uploader" data-uploader="uploader" nv-file-drop nv-file-over ng-click="openFileDialog()">\n\t<input type="file" ng-hide="1" data-uploader="uploader" nv-file-select ng-click="$event.stopPropagation()"/>\n\t<svg x="0px" y="0px" viewBox="0 0 10 10" enable-background="new 0 0 10 10" xml:space="preserve">\n\t\t<path d="M3.746,10V6.283H0V3.717h3.746V0h2.497v3.717H10v2.566H6.243V10H3.746z"/>\n\t</svg>\n\t<div>{{label|translate}}</div>\n</div>'}}]).directive("noContextMenu",function(){return{compile:function(e){e.bind("contextmenu",function(e){e.preventDefault()})}}}),angular.module("dokuvis.viewport",["pascalprecht.translate","ngDebounceThrottle"]).directive("viewport",["$state","$window","$timeout","viewportCache","viewportSettings","webglInterface","$rootScope","$q","Utilities","$debounce","$throttle","SpatializeInterface","$log","$compile","$animate",function(e,qe,Ge,Qe,Xe,_e,Ye,Je,Ze,Ke,et,tt,nt,at,ot){return{restrict:"E",replace:!1,transclude:!0,template:"<canvas ng-class=\"{'cursor_orbit': navigation.rotate, 'cursor_pan': navigation.pan, 'cursor_zoom': navigation.zoom}\"></canvas>\n<div class=\"viewport-extras\" ng-transclude></div>",scope:{callFunc:"=",screenshotCallback:"="},link:function(A,U,e){console.log(A,e);var t=e.id||0;_e.callFunc[t]={},tt.callFunc[t]={},A.hud={navigation:"navToolbar"in e,axis:"axis"in e,focus:!1,move:!1,shading:!1,camera:!1,options:"optionToolbar"in e,spatialize:"spatialize"in e},angular.forEach(A.navToolbar,function(e){A.hud[e]=!0});var d,m,F,f,g,W,B,a,h,n,o,i,r,s,c,l,u="spatializeManual"in e,N=null,p=Xe.defaults.NEAR,q=Xe.defaults.FAR,v=new THREE.Raycaster,G=[],E=[],y=[],w=[],b=0,T=(_e.viewportSettings.shadingSel,!1),Q=new THREE.Vector2,M=null,X=-1,_=!1,Y=!1,J=!1;A.navigation={default:!0,rotate:!1,pan:!1,zoom:!1};var x,Z=A.navigation,K=!1,D=!1,ee=Qe.objects,R=[],S=Qe.plans,$=Qe.spatialImages,H=Qe.geometries,j=Qe.materials;function V(e,t,n){A.$broadcast("viewportLoadProgress",e,t,n)}function C(e){A.$broadcast("viewportCameraMove",e)}function k(){T||(W.removeEventListener("change",te),T=!0,te())}function I(){T||(W.removeEventListener("change",te),T=!0,te())}Ge(function(){!function(){d=U.width(),m=U.height(),console.log("viewport size: ",d,m),B=new THREE.CombinedCamera(d,m,35,p,q,p,q),Qe.viewpoint?B.position.copy(Qe.viewpoint.cameraPosition):B.position.set(-100,60,100),g=Qe.scene,F=U.find("canvas"),(f=new THREE.WebGLRenderer({antialias:!0,alpha:!1,preserveDrawingBuffer:!0,canvas:F.get(0)})).setClearColor(DV3D.Defaults.backgroundColor,1),f.setSize(d,m),U.append(f.domElement),(W=new THREE.OrbitControls(B,f.domElement)).zoomSpeed=1,Qe.viewpoint&&W.center.copy(Qe.viewpoint.controlsCenter),B.target=W.center,W.addEventListener("change",function(){z(),C(B)}),a=Qe.directionalLight;var e=new THREE.LoadingManager;e.onProgress=V,e.onLoad=function(){We()},h=new THREE.CTMLoader(e),n=new THREE.TextureLoader(e),F.on("mousedown",ve),F.on("mousemove",Ee),F.on("mouseup",ye),F.on("dblclick",we),U.on("mouseleave",be),F.on("wheel",Te),F.on("contextmenu",function(e){e.preventDefault()});var t=angular.element(qe);t.on("keydown",Me),t.on("keyup",xe),t.on("resize",Ne),(i=new DV3D.GizmoMove(10,2.5,1.2)).addEventListener("change",te),(r=new DV3D.GizmoRotate(10)).addEventListener("change",te),ee.forEach(function(e){e.addEventListener("change",L),e.addEventListener("toggle",Pe),e.addEventListener("focus",Ae),e.addEventListener("select",Ue)}),$.forEach(function(e){e.addEventListener("change",L),e.addEventListener("toggle",Ie),e.addEventListener("select",Ue),e.addEventListener("focus",Ae)}),te(),C(B)}()}),et(function(){for(var e=0;e<R.length;e++){var t=R[e];if(Potree.utils.computeTransformedBoundingBox(t.boundingBox,t.matrixWorld),!t.material._defaultIntensityRangeChanged){var n=t.pcoGeometry.root;if(null!==n&&n.loaded){var a=t.pcoGeometry.root.geometry.attributes;if(a.intensity){for(var o=a.intensity.array,i=[],r=0;r<o.length;r++)i.push(o[r]);i.sort();var s=i[parseInt(.75*(i.length-1))];t.material.intensityRange=s<=1?[0,1]:s<=256?[0,255]:[0,s]}}}t.material.clipMode=pcConfig.clipMode,t.generateDEM=pcConfig.generateDEM,t.minimumNodePixelSize=pcConfig.minNodeSize,t.numVisibleNodes,t.numVisiblePoints,t.progress;var c=t.material.classification,l=!1;for(var u in pcConfig.classifications){var p=pcConfig.classifications[u].visible?1:0;c[u]?c[u].w!==p&&(c[u].w=p,l=!0):(c.DEFAULT?c[u]=c.DEFAULT:c[u]=new THREE.Vector4(.3,.6,.6,.5),l=!0),l&&t.material.recomputeClassification()}}var d=Potree.updatePointClouds(R,B,f);d.visibleNodes.length,d.numVisiblePoints},500,!1,!0),_e.callFunc.animate=function(){te()};var L=Ke(te,50),z=et(te,20),O=et(te,500);function te(){if(T?(TWEEN.update(),TWEEN.getAll().length?requestAnimationFrame(te):(T=!1,W.addEventListener("change",te))):$.forEach(function(e){e.updateTextureByDistance(B.position,30)},!0),W&&W.update(),a){a.position.set(4,4,4);var e=(new THREE.Matrix4).makeRotationFromQuaternion(B.quaternion);a.position.applyMatrix4(e)}if(A.hud.spatialize&&tt.markers3D.length)for(var t=0,n=tt.markers3D.length;t<n;t++)tt.markers3D[t].object.lookAt(B.position);P()}function P(){f&&f.render(g,B)}function ne(e,t,n){n=n||!1;var a=new THREE.Vector3(e.x,e.y,p).unproject(B).sub(B.position).normalize();v.set(B.position,a);var o=v.intersectObjects(t,n);return o.length?o[0]:null}function ae(e,t){var n=[];ee.forEach(function(e){"object"===e.type&&n.push(e.object)},!0),S.forEach(function(e){n.push(e.object.mesh)},!0),$.forEach(function(e){n.push(e.object.collisionObject)},!0);var a=ne(e,n,!0);a?(nt.debug(a),a.object.entry instanceof DV3D.Entry?oe(a.object.entry,t):a.object.parent.entry instanceof DV3D.Entry?oe(a.object.parent.entry,t):nt.warn("Raycast hit unknown object",a)):oe(null,t)}function oe(e,t,n){t=t||!1,n=n||!1;var a=!1;G.length&&!t&&(G.forEach(function(e){ie(e),a=!0}),Le(),G=[]),e&&!n&&-1===G.indexOf(e)?(function t(e){e instanceof DV3D.ObjectEntry?(function(e){if("object"===e.type){switch(Xe.shading){case"xray":e.object.material=j.xraySelectionMat}e.edges&&(e.edges.material===j.edgesMat?e.edges.material=j.edgesSelectionMat:e.edges.material.color=j.edgesSelectionMat.color)}}(e),e.children.forEach(function(e){t(e)})):e instanceof DV3D.PlanEntry?e.object.select():e instanceof DV3D.ImageEntry&&e.object.select(),e.select(null,!0)}(e),G.push(e),a=!0,e instanceof DV3D.PlanEntry&&Le(e.object,"move")):e&&!n&&-1!==G.indexOf(e)&&(ie(e),G.splice(G.indexOf(e),1),a=!0,o&&o.object===e.object&&Le()),a&&Ye.$broadcast("viewportSelectionChange",G),Ye.$applyAsync(),L()}function ie(e){e instanceof DV3D.ObjectEntry?(function(e){if("object"===e.type){switch(Xe.shading){case"xray":e.object.material=j.xrayMat}e.edges&&(e.edges.material===j.edgesSelectionMat?e.edges.material=j.edgesMat:e.edges.material.color=j.edgesMat.color)}}(e),e.children.forEach(function(e){ie(e)})):e instanceof DV3D.PlanEntry?e.object.deselect():e instanceof DV3D.ImageEntry&&e.object.deselect(),e.select(null,!1)}function re(e){if(-1===y.indexOf(e)){for(var t=0;t<E.length;t++)E[t]!==e&&-1===y.indexOf(E[t])&&(se(E[t]),E.splice(t,1),--t);e&&-1===E.indexOf(e)&&("object"===e.userData.type&&function(e){e.material=e.material.clone();var t=new THREE.Color(16776960);e.material.color.lerp(t,.5),e.material.name+="_highlight"}(e),E.push(e))}}function se(e){if(e.material!==j[e.userData.originalMat]&&-1===Qe.standardMaterials.indexOf(e.material.name))switch(e.material.dispose(),Xe.shading){case"grey":e.material=j.defaultDoublesideMat;break;case"transparent":e.material=j.transparentMat;break;default:e.material=j[e.userData.originalMat]}}function ce(e,t){!0===t?e&&-1!==y.indexOf(e)&&(ue(e),y.splice(y.indexOf(e),1)):e&&-1===y.indexOf(e)&&(re(),"object"===e.userData.type&&function(e){se(e),e.material=e.material.clone();var t=new THREE.Color(16711680);e.material.color.lerp(t,.5),e.material.name+="_mark"}(e),y.push(e))}function le(){y.forEach(function(e){ue(e)}),y=[]}function ue(e){se(e)}function pe(t,e){if(t!==e){var n="onlyEdges"===t&&"onlyEdges"!==e,a="onlyEdges"===e&&"onlyEdges"!==t,o="xray"===t&&"xray"!==e,i=Xe.showEdges&&"xray"===e;"custom"===e&&Ye.$broadcast("categoryDeactivate"),ee.forEach(function(e){switch(e.visible&&(n&&(e.parent?e.parent.object.remove(e.object):g.remove(e.object)),a&&(e.parent?e.parent.object.add(e.object):g.add(e.object)),o&&e.edges&&g.remove(e.edges),i&&e.edges&&g.add(e.edges)),t){case"color":e.object.material=j[e.object.userData.originalMat];break;case"grey":e.object.material=j.defaultDoublesideMat;break;case"transparent":e.object.material=j.transparentMat;break;case"xray":-1!==G.indexOf(e)?e.object.material=j.xraySelectionMat:e.object.material=j.xrayMat;break;default:e.object.material=j[e.object.userData.originalMat]}}),te()}}function de(e){if(B){switch(e){case"perspective":B.toPerspective(),B.setZoom(1);break;case"top":B.toOrthographic(W.center),B.toTopView();break;case"front":B.toOrthographic(W.center),B.toFrontView();break;case"back":B.toOrthographic(W.center),B.toBackView();break;case"left":B.toOrthographic(W.center),B.toLeftView();break;case"right":B.toOrthographic(W.center),B.toRightView()}te()}}function me(e,t){var n;s&&(g.remove(s),s.dispose(),s=null),c&&(g.remove(c),c.dispose(),D=!1,re(c=null)),Z.default=!1,Z.rotate=!1,Z.pan=!1,Z.zoom=!1,e&&e in Z?Z[e]=!0:Z.default=!0,!1!==t&&(n=e,A.$broadcast("viewportNavigationChange",n)),te()}function fe(e,t,n){1===n?(-1===G.indexOf(e)?(e.material=j[e.userData.originalMat],t&&(t.material=j.edgesMat)):(e.material=j.selectionMat,t&&(t.material=j.edgesSelectionMat)),e.userData.modifiedMat=!1):e.userData.modifiedMat||(e.material=e.material.clone(),e.material.transparent=!0,e.material.depthWrite=!1,e.material.needsUpdate=!0,t&&(t.material=t.material.clone(),t.material.transparent=!0,t.material.depthWrite=!1,t.material.needsUpdate=!0),e.userData.modifiedMat=!0),e.material.opacity=n,t&&(t.material.opacity=n)}function ge(e){var t=new THREE.Vector2;return t.x=e.offsetX/d*2-1,t.y=-e.offsetY/m*2+1,t}function he(e){var t=d*(e.x+1)/2,n=m*(1-e.y)/2;return new THREE.Vector2(t,n)}function ve(e){if(A.closeContextMenu(),X=e.button,Q=ge(e),M=e,Z.default)if(0===e.button)if(e.shiftKey){var t=angular.element("<div/>",{id:"select-rectangle",class:"select-rectangle"});U.append(t),K=!0}else B.inPerspectiveMode;else 1===e.button&&(W.onMouseDown(e.originalEvent,2),F.addClass("cursor_pan"),J=!0);else Z.rotate?0===e.button&&B.inPerspectiveMode&&(W.onMouseDown(e.originalEvent,0),_=!0):Z.pan?0===e.button&&(W.onMouseDown(e.originalEvent,2),J=!0):Z.zoom&&0===e.button&&(W.onMouseDown(e.originalEvent,1),Y=!0)}function Ee(e){e.preventDefault();var t,n,a,o,i,r=ge(e);-1!==X&&(new THREE.Vector2(e.originalEvent.movementX||e.originalEvent.mozMovementX||e.originalEvent.webkitMovementX||0,e.originalEvent.movementY||e.originalEvent.mozMovementY||e.originalEvent.webkitMovementY||0),_||J||Y?W.onMouseMove(e.originalEvent):K?U.find("#select-rectangle").css((n=r,a=he(t=Q),o=he(n),i={},n.x>t.x?(i.left=a.x,i.width=o.x-a.x):(i.left=o.x,i.width=a.x-o.x),n.y<t.y?(i.top=a.y,i.height=o.y-a.y):(i.top=o.y,i.height=a.y-o.y),i)):0===X&&B.inPerspectiveMode&&!Q.equals(r)&&(W.onMouseDown(M.originalEvent,0),F.addClass("cursor_orbit"),_=!0))}function ye(e){if(-1!==X){X=-1;var t,n,a,o,i,r,s,c,l,u,p,d,m,f,g,h,v,E,y,w,b,T,M,x,D,R,S,$,H,j,V,C,k,I,L=ge(e);if(Z.default&&2!==e.button)if(_)W.onMouseUp(e.originalEvent),F.removeClass("cursor_orbit"),_=!1;else if(J)W.onMouseUp(e.originalEvent),F.removeClass("cursor_pan"),J=!1;else if(Y)W.onMouseUp(e.originalEvent),F.removeClass("cursor_zoom"),Y=!1;else if(K){if(U.find("#select-rectangle").remove(),K=!1,0!==e.button)return;var z,O;L.x>Q.x&&L.y<Q.y||L.x<Q.x&&L.y>Q.y?(z=Q,O=L):(z=new THREE.Vector2(Q.x,L.y),O=new THREE.Vector2(L.x,Q.y)),t=z,n=O,a=e.ctrlKey,o=new THREE.Vector3(t.x,t.y,.5).unproject(B),i=new THREE.Vector3(t.x,n.y,.5).unproject(B),r=new THREE.Vector3(n.x,n.y,.5).unproject(B),s=new THREE.Vector3(n.x,t.y,.5).unproject(B),c=new THREE.Vector3(0,0,.5).unproject(B),l=(new THREE.Vector3).subVectors(o,B.position),u=(new THREE.Vector3).subVectors(i,B.position),p=(new THREE.Vector3).subVectors(r,B.position),d=(new THREE.Vector3).subVectors(s,B.position),m=(new THREE.Vector3).subVectors(c,B.position),f=new THREE.Vector3(0,0,.5).unproject(B).add(m.clone().setLength(q)),g=(new THREE.Vector3).subVectors(f,B.position),h=(new THREE.Vector3).crossVectors(u,l).normalize(),v=(new THREE.Vector3).crossVectors(p,u).normalize(),E=(new THREE.Vector3).crossVectors(d,p).normalize(),y=(new THREE.Vector3).crossVectors(l,d).normalize(),w=m.clone().normalize(),b=g.clone().negate().normalize(),T=-h.dot(o),M=-v.dot(i),x=-E.dot(r),D=-y.dot(s),R=-w.dot(c),S=-b.dot(f),$=new THREE.Plane(h,T),H=new THREE.Plane(v,M),j=new THREE.Plane(E,x),V=new THREE.Plane(y,D),C=new THREE.Plane(w,R),k=new THREE.Plane(b,S),I=new THREE.Frustum($,H,j,V,C,k),a||oe(null,!1,!0),ee.forEach(function(e){if("object"===e.type&&-1===G.indexOf(e.object)&&I.intersectsObject(e.object)){console.log("first check");for(var t=e.object.geometry.attributes.position.array,n=e.object.matrixWorld,a=0,o=t.length;a<o;a+=3){var i=new THREE.Vector3(t[a],t[a+1],t[a+2]);if(i.applyMatrix4(n),I.containsPoint(i)){console.log("second check"),oe(e,!0);break}}}},!0),te()}else L.equals(Q)&&(ae(L,e.ctrlKey),te());else if(Z.rotate||Z.pan||Z.zoom)2===e.button&&me(),(_||J||Y)&&(W.onMouseUp(e.originalEvent),_=J=Y=!1);else if(2===e.button&&L.equals(Q)&&(ae(L),G[0]&&G[0]instanceof DV3D.ImageEntry)){console.log("open context menu");var P=A.$new(!1);P.position=new THREE.Vector2(e.offsetX,e.offsetY),P.entry=G[0],N=at("<viewport-context-menu no-context-menu></viewport-context-menu>")(P),ot.enter(N,U)}}}function we(e){G[0]&&(G[0]instanceof DV3D.ImageEntry?G[0].focus():G[0]instanceof DV3D.ObjectEntry&&G[0].focus())}function be(e){X=-1,A.closeContextMenu(),Z.default?_?(W.onMouseUp(e.originalEvent),F.removeClass("cursor_orbit"),_=!1):J?(W.onMouseUp(e.originalEvent),F.removeClass("cursor_pan"),J=!1):Y?(W.onMouseUp(e.originalEvent),F.removeClass("cursor_zoom"),Y=!1):K&&(U.find("#select-rectangle").remove(),K=!1):(Z.rotate||Z.pan||Z.zoom)&&(_||J||Y)&&(W.onMouseUp(e.originalEvent),_=J=Y=!1)}function Te(e){e.preventDefault(),W.onMouseWheel(e.originalEvent)}function Me(e){-1===["INPUT","TEXTAREA"].indexOf(e.target.tagName)&&W.onKeyDown(e.originalEvent)}function xe(e){if(-1===["INPUT","TEXTAREA"].indexOf(e.target.tagName))switch(e.keyCode){case 70:de("front");break;case 76:de("left");break;case 80:de("perspective");break;case 84:de("top")}}_e.callFunc.setSelected=function(e,t,n){oe(e,t,n),te()},A.$on("viewportShadingChange",function(e,t,n){e.stopPropagation(),pe(t,n)}),A.$on("viewportCameraChange",function(e,t){e.stopPropagation(),de(t)}),A.$on("viewportNavigationChange",function(e,t){e.targetScope!==A&&(e.stopPropagation(),me(t,!1))}),Ye.$watch(function(){return _e.vizSettings.opacitySelected},function(e){for(var t=0;t<G.length;t++){var n,a=G[t];n="plan"===a.userData.type?S[a.id].edges:ee[a.id].edges,a.userData.modifiedMat||(a.material=a.material.clone(),a.material.transparent=!0,a.material.depthWrite=!1,a.material.needsUpdate=!0,n.material=n.material.clone(),n.material.transparent=!0,n.material.needsUpdate=!0,a.userData.modifiedMat=!0),a.material.opacity=e/100,n.material.opacity=e/100}}),_e.callFunc.setObjectOpacity=function(e,t){var n=ee[e.id].mesh,a=ee[e.id].edges;"object"===e.type&&fe(n,a,t),e.opacity=t,function e(t,n){for(var a=0;a<t.length;a++){var o=t[a].id,i=ee[o].mesh,r=ee[o].edges;"object"===t[a].type&&fe(i,r,n),t[a].opacity=n,e(t[a].children,n)}}(e.children,t),te()},A.closeContextMenu=function(){N&&(ot.leave(N),N=null,A.$applyAsync())},A.startMeasuring=function(){A.setNavigationMode(),(s=new DV3D.Measure(2)).addEventListener("change",te),g.add(s),s.onComplete=function(e){A.measureDistance=e,A.$applyAsync()}};var De=null;function Re(e){var t=new THREE.Vector3(e.cameraMatrix[12],e.cameraMatrix[13],e.cameraMatrix[14]),n=(new THREE.Vector3).fromArray(e.cameraCenter);new TWEEN.Tween(B.position.clone()).to(t,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){B.position.copy(this)}).start(),new TWEEN.Tween(W.center.clone()).to(n,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){W.center.copy(this)}).start(),B.fov===e.cameraFOV&&new TWEEN.Tween({fov:B.fov}).to({fov:e.cameraFOV},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){B.fov=this.fov,B.updateProjectionMatrix()}).start(),I()}function Se(){angular.forEach(tt.markers3D,function(e){g.remove(e.object),e.object.dispose()}),tt.markers3D.splice(0,tt.markers3D.length),P(),A.$applyAsync()}if(A.$on("snapshotViewScreen",function(e,t,n){if(!angular.element(U).find("viewport-snapshot-view").length){var a=A.$new(!1);a.screen=t,a.pins=n,De=at("<viewport-snapshot-view></viewport-snapshot-view>")(a),ot.enter(De,U),angular.element(U).find("viewport-navigation").attr("disabled",!0),Re(t)}}),A.$on("snapshotViewClose",function(){A.closeSnapshotView()}),A.closeSnapshotView=function(){De&&ot.leave(De),De=null,angular.element(U).find("viewport-navigation").attr("disabled",!1)},A.$on("snapshotStart",function(){if(!angular.element(U).find("viewport-snapshot").length){var e=A.$new(!1);e.size={width:d,height:m},De=at("<viewport-snapshot></viewport-snapshot>")(e),ot.enter(De,U),angular.element(U).find("viewport-navigation").attr("disabled",!0),Ge(function(){var e;e={sData:f.domElement.toDataURL("image/jpeg"),cameraMatrix:B.matrix.toArray(),cameraFOV:B.fov,cameraCenter:W.center.toArray(),width:d,height:m},Ye.$broadcast("snapshotScreenshot",e)})}}),A.$on("snapshotEnd",function(){De&&ot.leave(De),De=null,angular.element(U).find("viewport-navigation").attr("disabled",!1),le(),L()}),A.startPinning=function(){me(),c=new DV3D.Pin(3,.5),g.add(c),D=!0},A.abortPinning=function(){D=!1,me()},A.mousemovePinLayer=function(e){if(D&&c){var t=ge(e),n=[];ee.forEach(function(e){"object"===e.type&&n.push(e.object)},!0);var a=ne(t,n);a?(c.set(a),re(a.object)):(c.set(),re()),z()}},A.mouseleavePinLayer=function(){D&&c&&(c.set(),re(),L())},A.mouseupPinLayer=function(e){if(e.preventDefault(),D&&c&&0===e.button&&E[0]){var t=E[0];-1===y.indexOf(t)&&(ce(t),n=ee.get(t.id),a=c.matrixWorld.toArray(),Ye.$broadcast("snapshotPinSuccess",n,a),z())}var n,a},A.$on("snapshotPinRemove",function(e,t){ce(t.object,!0),L()}),A.$on("snapshotViewStart",function(e,t){Re(t)}),u){var $e=null;A.$on("spatializeManualStart",function(e,t){if(!angular.element(U).find("viewport-spatialize-manual").length){var n=A.$new(!1);n.source=t,n.camera=B,n.controls=W,n.animate=z,$e=at("<viewport-spatialize-manual></viewport-spatialize-manual>")(n),ot.enter($e,U),U.find("viewport-selection-display, viewport-analysis-tools").hide()}}),A.closeSpatializeManual=function(){ot.leave($e),$e=null,U.find("viewport-selection-display, viewport-analysis-tools").show()}}function He(){l&&l.update(function(t){var n=0;return $.forEach(function(e){new THREE.Vector2(t.x,t.z).sub(new THREE.Vector2(e.object.position.x,e.object.position.z)).length()<b&&n++},!0),n})}function je(e,t){if(!e.spatial)return Je.reject("No spatial information");var n=$.getByName(e.content);if(n&&t)$.remove(n),g.remove(n.object),n.object.dispose();else if(n&&!t)return Je.reject("Already loaded");var a=Je.defer(),o=new DV3D.ImagePane("data/"+e.file.path+e.file.preview,{width:e.file.width,height:e.file.height,ck:e.spatial.ck,offset:e.spatial.offset,preview:"data/"+e.file.path+e.file.thumb});o.onComplete=function(){1!==Xe.images.opacity&&r.setOpacity(Xe.images.opacity),r.setScale(Xe.images.scale),L(),a.resolve(r)};var i=(new THREE.Matrix4).fromArray(e.spatial.matrix);o.applyMatrix(i),g.add(o),o.name=e.spatial.id,o.userData.source=e,o.userData.type="image";var r=new DV3D.ImageEntry(o,e.title);return r.addEventListener("change",L),r.addEventListener("toggle",Ie),r.addEventListener("select",Ue),r.addEventListener("focus",Ae),$.add(r),a.promise}function Ve(e){var t;t=e,$.forEach(function(e){e.object!==t&&e.toggle(!1)},!0),A.$broadcast("viewportIsolationEnter");var n=new THREE.Vector3(0,0,-100);n.applyQuaternion(e.quaternion),n.add(e.position);var a=Math.abs(e.image.position.z*e.scale.z);B.cameraP.near>.8*a&&(B.cameraP.near=.8*a,B.updateProjectionMatrix()),new TWEEN.Tween(B.position.clone()).to(e.position,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){B.position.copy(this)}).start(),new TWEEN.Tween(W.center.clone()).to(n,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){W.center.copy(this)}).start(),new TWEEN.Tween({fov:B.fov}).to({fov:e.fov},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){B.fov=this.fov,B.updateProjectionMatrix()}).start(),I()}function Ce(){console.log("exit isolation"),$.forEach(function(e){e.toggle(!0)}),A.$broadcast("viewportIsolationExit")}function ke(e){var t=e.mesh.geometry,n=e.mesh.matrixWorld,a=(new THREE.Quaternion).setFromRotationMatrix(n),o=new THREE.Vector3(t.attributes.normal.array[0],t.attributes.normal.array[1],t.attributes.normal.array[2]).applyQuaternion(a),i=t.boundingBox.clone().applyMatrix4(n),r=d/m,s=Math.sqrt(Math.pow(i.max.x-i.min.x,2)+Math.pow(i.max.z-i.min.z,2))/2,c=(i.max.y-i.min.y)/2;(.707<o.y||o.y<-.707)&&(s=Math.sqrt(Math.pow(i.max.x-i.min.x,2)+Math.pow(i.max.y-i.min.y,2))/2,c=(i.max.z-i.min.z)/2),r<s/c&&(c=1/r*s);var l=c/Math.tan(B.fov/2*Math.PI/180),u=t.boundingSphere.center.clone().applyMatrix4(n),p=new THREE.Vector3;p.addVectors(u,o.setLength(l)),new TWEEN.Tween(B.position.clone()).to(p,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){B.position.copy(this)}).start(),new TWEEN.Tween(W.center.clone()).to(u,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){W.center.copy(this)}).onComplete(function(){B.toOrthographic(W.center),_e.viewportSettings.cameraSel="Custom",A.$apply()}).start(),k()}function Ie(e){var t=e.target;if(e.visible){if(g.getObjectById(t.object.id))return;g.add(t.object)}else g.remove(t.object),oe(t,!1,!0);L()}function Le(e,t,n){switch(o&&o.attachToObject(null),t){case"move":o=i;break;case"rotate":o=r;break;default:o=null}o&&o.attachToObject(e,n)}function ze(e){if(e.id in j)return j[e.id];var t=new THREE.MeshLambertMaterial;return t.name=e.id,Array.isArray(e.diffuse)?(t.color=new THREE.Color(e.diffuse[0],e.diffuse[1],e.diffuse[2]),t.color.convertLinearToGamma()):"string"==typeof e.diffuse&&n.load("data/"+e.path+e.diffuse,function(e){t.map=e,t.needsUpdate=!0},null,function(e){nt.warn("Couldn't load texture",e.path[0].src)}),e.alpha&&n.load("data/"+e.path+e.alpha,function(e){t.alphaMap=e,t.transparent=!0,t.needsUpdate=!0},null,function(e){nt.warn("Couldn't load texture",e.path[0].src)}),t.side=THREE.DoubleSide,j[e.id]=t}function Oe(e){var a=Je.defer();return JSZipUtils.getBinaryContent(e,function(e,t){e?a.reject(e):JSZip.loadAsync(t).then(function(e){return e.file(/.+\.json$/i)[0].async("text")}).then(function(e){e=JSON.parse(e);var t=new Float32Array(e.data.attributes.position.array),n=new THREE.BufferGeometry;n.addAttribute("position",new THREE.BufferAttribute(t,3)),a.resolve(n)}).catch(function(e){Ze.throwException("JSZip Error","Failed to load or extract zip file.",e),a.reject()})}),a.promise}function Pe(e){var t=e.target,n=t.parent?t.parent.object:g;if(e.visible&&t.parent&&!t.parent.visible&&(t.parent.visible=!0,Pe({target:t.parent,visible:!0})),e.visible){if(n.getObjectById(t.object.id))return;n.add(t.object),Xe.showEdges&&t.edges&&g.add(t.edges)}else n.remove(t.object),Xe.showEdges&&t.edges&&g.remove(t.edges),oe(t,!1,!0);L()}function Ae(e){if(e.target.object){var t=e.target.object;t instanceof DV3D.ImagePane?Ve(t):t instanceof DV3D.Plan?ke(t):Fe([e.target])}}function Ue(e){oe(e.target,e.originalEvent.ctrlKey)}function Fe(e){if(!(e.length<1))if(1===e.length&&e[0]instanceof DV3D.ImageEntry)Ve(e[0].object);else{var a=[];!function e(t){for(var n=0;n<t.length;n++)e(t[n].children),"object"!==t[n].type&&"plan"!==t[n].type||a.push(t[n].object)}(e),Be(a)}}function We(){var t=[];ee.forEach(function(e){"object"===e.type&&t.push(e.object)},!0),t.length<1||Be(t)}function Be(e){var o=0,i=0,r=0,s=0,c=0,l=0;e.forEach(function(e,t){e.geometry.boundingBox||e.geometry.computeBoundingBox();var n=e.geometry.boundingBox.min.clone().applyMatrix4(e.matrixWorld),a=e.geometry.boundingBox.max.clone().applyMatrix4(e.matrixWorld);if(0===t)return o=n.x,r=n.y,c=n.z,i=a.x,s=a.y,void(l=a.z);n.x<o&&(o=n.x),n.y<r&&(r=n.y),n.z<c&&(c=n.z),a.x>i&&(i=a.x),a.y>s&&(s=a.y),a.z>l&&(l=a.z)});var t=new THREE.Geometry;t.vertices.push(new THREE.Vector3(o,r,c)),t.vertices.push(new THREE.Vector3(i,s,l)),t.computeBoundingSphere();var n=(new THREE.Vector3).subVectors(B.position,W.center),a=t.boundingSphere.radius/Math.tan(B.fov/2*THREE.Math.DEG2RAD),u=(new THREE.Vector3).addVectors(t.boundingSphere.center,n.setLength(a));B.cameraP.near=t.boundingSphere.radius/100,B.cameraP.far=Math.max(100*t.boundingSphere.radius,200),B.updateProjectionMatrix(),new TWEEN.Tween(B.position.clone()).to(u,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){B.position.copy(this)}).start(),new TWEEN.Tween(W.center.clone()).to(t.boundingSphere.center,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){W.center.copy(this)}).start(),I()}function Ne(){d=U.width(),m=U.height(),nt.debug("resize called",d,m),B.setSize(d,m),B.cameraP.updateProjectionMatrix(),f.setSize(d,m),te()}A.setCameraFOV=function(e){return e&&(B.fov=e,B.updateProjectionMatrix(),z()),B},A.$on("viewportHeatMapUpdate",function(e,t){t&&(t.visibilityChange&&(t.visible?(l||((l=new DV3D.HeatMap(1500,1500,150,150)).translateX(600),l.translateZ(-500),l.updateMatrixWorld()),g.add(l),b=t.radius,He()):g.remove(l)),t.overlayChange&&l.toggleOverlay(t.overlay),t.radiusChange&&(b=t.radius,He()),L())}),A.$on("spatialImageLoad",function(e,t,n){!0===n&&(oe(null),[].concat($.list).forEach(function(e){g.remove(e.object),$.remove(e),e.dispose()})),Array.isArray(t)?t.forEach(function(e){je(e)}):je(t),He()}),A.exitIsolation=Ce,A.hud.spatialize&&(tt.callFunc[t].loadSpatializeImage=loadSpatializeImage,tt.callFunc[t].setImageView=Ve,A.spatialize={markers:tt.markers3D},A.startMarking=function(){(x=new DV3D.TorusMarker(.5)).addEventListener("change",te),g.add(x)},A.clearMarkers=Se),_e.callFunc.load3DPlan=function(e){if(!S.getByName(e.info.content)){var t=new DV3D.Plan("data/"+e.file.path+e.file.content,"data/"+e.info.materialMapPath+e.info.materialMap,e.info.scale);t.onComplete=function(){te()},g.add(t),t.name=e.info.content,t.userData.name=e.info.materialName,t.userData.source=e.source,t.userData.type="plan";var n=new DV3D.PlanEntry(t);t.entry=n,S.add(n),console.log("Plan",t)}},_e.callFunc.viewOrthoPlan=ke,_e.callFunc.toggle=function(e,t){t?g.add(e):g.remove(e),L()},A.internalCallFunc=A.callFunc||{},_e.callFunc.getObjForPlans=function(e){if(S.get(e)){for(var t=S.get(e).mesh.geometry,n=S.get(e).mesh.matrixWorld,a=[],o=t.index.count*t.index.itemSize,i=0;i<o;i+=3){for(var r=new THREE.Geometry,s=0;s<3;s++){var c=t.index.array[i+s]*t.attributes.position.itemSize,l=new THREE.Vector3(t.attributes.position.array[c],t.attributes.position.array[c+1],t.attributes.position.array[c+2]);r.vertices.push(l)}r.applyMatrix(n),r.computeBoundingBox();var u=new THREE.Mesh(r,j.defaultMat);for(var p in ee)"group"!=ee[p].mesh.userData.type&&overlapAABB(ee[p].mesh,u)&&a.push(ee[p].mesh.userData.eid);r.dispose()}return{plan:S.get(e).mesh.name,objs:a}}},_e.callFunc.highlightObjects=function(e){oe(null,!1,!0);for(var t=0;t<e.length;t++)for(var n in ee)ee[n].mesh.userData.eid===e[t].meshId&&(ee[n].mesh,oe(ee[n].mesh,!0));te()},A.$on("modelQuerySuccess",function(e,t){!function(){for(var e in[].concat(ee.list).forEach(function(e){e.object.parent.remove(e.object),e.edges&&g.remove(e.edges),ee.remove(e),e.dispose()}),H)H.hasOwnProperty(e)&&-1===Qe.standardGeometries.indexOf(e)&&(H[e].mesh&&H[e].mesh.dispose(),H[e].edges&&H[e].edges.dispose(),delete H[e]);for(e in j)j.hasOwnProperty(e)&&-1===Qe.standardMaterials.indexOf(e)&&(j[e].map&&j[e].map.dispose(),j[e].alphaMap&&j[e].alphaMap.dispose(),j[e].dispose(),delete j[e]);te()}(),h.manager.reset(),function n(e){return e.reduce(function(e,t){return e.then(function(){return function(i){var r,e=Je.defer();switch(i.obj.type){case"group":r=new THREE.Group;break;case"object":r=new THREE.Mesh(H.initGeo,j.defaultMat);break;default:return e.reject("Unsupported type"),e.promise}var t=new THREE.Matrix4;if(t.fromArray(i.obj.matrix),"Z"===i.obj.up&&!i.parent){var n=new THREE.Matrix4;n.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),t.multiplyMatrices(n,t)}var a=new THREE.Vector3,o=new THREE.Quaternion,s=new THREE.Vector3;t.decompose(a,o,s);var c="number"==typeof i.obj.unit?i.obj.unit:1;i.parent||(a.multiplyScalar(c),s.multiplyScalar(c)),t.compose(a,o,s),r.applyMatrix(t),r.matrixAutoUpdate=!1,r.name=i.obj.id,r.userData.id=i.obj.id,r.userData.name=i.obj.name,r.userData.type=i.obj.type,r.userData.layer=i.obj.layer;var l=null;i.parent&&(l=g.getObjectByName(i.parent,!0)),l?l.add(r):g.add(r);var u=new DV3D.ObjectEntry(r);if(u.addEventListener("change",L),u.addEventListener("toggle",Pe),u.addEventListener("focus",Ae),u.addEventListener("select",Ue),ee.add(u),"object"===i.obj.type){var p=Array.isArray(i.file.mesh)?i.file.mesh.reduce(function(e,t){return e+t}):i.file.mesh;if(p in H&&m(H[p].mesh),Array.isArray(i.file.mesh)){var d=[];i.file.mesh.reduce(function(e,n){return e.then(function(){var t=Je.defer();return h.load("data/"+i.file.path+n,function(e){d.push(e),t.resolve()},{useWorker:!1}),t.promise})},Je.resolve()).then(function(){m(d)})}else h.load("data/"+i.file.path+i.file.mesh,m,{useWorker:!1})}function m(a){if(Array.isArray(a)){var e=a;(a=e[0]).clearGroups(),a.addGroup(0,a.index.count,0);for(var t=1;t<e.length;t++){a.merge(e[t]);var n=e[t].index.count;a.addGroup(a.index.count-n,n,t),e[t].dispose()}a.name||(a.name=i.file.mesh.reduce(function(e,t){return e+t}))}else a.clearGroups(),a.addGroup(0,a.index.count,0),a.name||(a.name=i.file.mesh);if(a.name in H||(H[a.name]={mesh:a}),a.computeBoundingBox(),r.geometry=a,i.materials&&Array.isArray(i.materials)?1!==i.materials.length?(r.material=i.materials.map(ze),r.userData.originalMat=i.materials.map(function(e){return e.id})):(r.material=ze(i.materials[0]),r.userData.originalMat=i.materials[0].id):(r.material=j.defaultDoublesideMat,r.userData.originalMat="defaultDoublesideMat"),i.file.edges&&!Array.isArray(i.file.edges))Oe("data/"+i.file.path+i.file.edges).then(function(e){var t=new THREE.LineSegments(e,j.edgesMat);t.matrix=r.matrixWorld,t.matrixAutoUpdate=!1,g.add(t),H[a.name].edges=e,u.addEdges(t),O()}).catch(function(e){e&&Ze.throwException("Loading Error","Some error occurred while loading objects. See console for details.",e)});else if(i.file.edges&&Array.isArray(i.file.edges)){var o=[];i.file.edges.reduce(function(e,t){return e.then(function(){return Oe("data/"+i.file.path+t).then(function(e){return o.push(e),Je.resolve()})})},Je.resolve()).then(function(){for(var e=o[0],t=1;t<o.length;t++)e.merge(o[t]),o[t].dispose();var n=new THREE.LineSegments(e,j.edgesMat);n.matrix=r.matrixWorld,n.matrixAutoUpdate=!1,g.add(n),H[a.name].edges=e,u.addEdges(n),O()}).catch(function(e){e&&Ze.throwException("Loading Error","Some error occurred while loading objects. See console for details.",e)})}O()}return e.resolve(),e.promise}(t)}).then(function(){return n(t.children)})},Je.resolve())}(t).then(function(){nt.debug("objects loaded")}).catch(function(e){Ze.throwException("Loading Error","An error occurred while loading objects. See concole for details.",e)})}),_e.callFunc.resetScene=function(){for(var e in ee)if(ee.hasOwnProperty(e)){var t=ee[e];t.mesh.parent.remove(t.mesh),t.edges&&g.remove(t.edges),delete ee[e]}for(var e in H)H.hasOwnProperty(e)&&(H[e].meshGeo&&H[e].meshGeo.dispose(),H[e].edgesGeo&&H[e].edgesGeo.dispose(),delete H[e]);te(),_e.clearLists()},_e.callFunc.selectObject=function(e,t,n){ee[e].visible&&oe(ee[e].mesh,t,n),te()},_e.callFunc.toggleObject=function(e,t){var n,a=(n=e.parent?ee[e.parent.id].mesh:g).getObjectById(e.id);t&&!a?(n.add(ee[e.id].mesh),g.add(ee[e.id].edges),ee[e.id].visible=!0,function e(t){for(var n=0;n<t.length;n++){var a=t[n].id;g.add(ee[a].edges),ee[a].visible=!0,e(t[n].children)}}(e.children)):t||(n.remove(ee[e.id].mesh),g.remove(ee[e.id].edges),ee[e.id].visible=!1,function e(t){for(var n=0;n<t.length;n++){var a=t[n].id;g.remove(ee[a].edges),ee[a].visible=!1,e(t[n].children)}}(e.children)),te()},A.$on("categoryActivate",function(e,n){console.log(n),Xe.shading="custom",n.attributes.forEach(function(e){if(0!==e.id&&-1!==e.id){var t=e.color.match(/\d+(\.\d+)?/g),n=j[e.id];n?n.color.setRGB(parseInt(t[0])/255,parseInt(t[1])/255,parseInt(t[2])/255):n=new THREE.MeshLambertMaterial({name:e.id,color:new THREE.Color(parseInt(t[0])/255,parseInt(t[1])/255,parseInt(t[2])/255),side:THREE.DoubleSide});var a=parseFloat(t[3]);1!==a?(n.transparent=!0,n.opacity=a):n.transparent=!1,j[e.id]=n}}),angular.forEach(ee,function(e){var t=e.mesh.userData;"object"===t.type&&(t.categories[n.id]&&t.categories[n.id].attrId?e.mesh.material=j[t.categories[n.id].attrId]:e.mesh.material=j.defaultDoublesideMat)}),te()}),_e.callFunc.addPin=function(e,t){if(!w[e]){var n,a,o,i,r=new DV3D.Pin(3,.5),s=t.pinMatrix;return r.applyMatrix((new THREE.Matrix4).set(s[0],s[4],s[8],s[12],s[1],s[5],s[9],s[13],s[2],s[6],s[10],s[14],s[3],s[7],s[11],s[15])),g.add(r),w[e]=r,te(),n=new THREE.Vector3(s[12],s[13],s[14]),a=n.project(B),o=d*(a.x+1)/2,i=m*(1-a.y)/2,new THREE.Vector2(o,i)}},_e.callFunc.removePin=function(e){w[e]&&(g.remove(w[e]),w[e].dispose(),delete w[e]),te()},_e.callFunc.removePins=function(){for(var e in w)g.remove(w[e]),w[e].dispose();w=[],te()},_e.callFunc.resize=function(){Ne()},_e.callFunc.explodePlans=function(){if(G[0]&&"plan"===G[0].userData.type){var h=G[0];console.log(h);var v={top:[],bottom:[],left:[],right:[]},E=new THREE.Vector3(h.mesh.geometry.attributes.normal.array[0],h.mesh.geometry.attributes.normal.array[1],h.mesh.geometry.attributes.normal.array[2]).applyQuaternion(h.quaternion).normalize(),y=h.mesh.geometry.boundingBox.clone().applyMatrix4(h.matrixWorld);S.forEach(function(e){if(e.object.id!==h.id){var t=e.object,n=new THREE.Vector3(t.mesh.geometry.attributes.normal.array[0],t.mesh.geometry.attributes.normal.array[1],t.mesh.geometry.attributes.normal.array[2]).applyQuaternion(t.quaternion).normalize(),a=t.mesh.geometry.boundingBox.clone().applyMatrix4(t.matrixWorld),o=(new THREE.Vector3).subVectors(a.max,a.min).multiply(E).length(),i=o/2+5,r=(new THREE.Vector3).subVectors(y.min,t.position),s=(new THREE.Vector3).subVectors(y.max,t.position);n.dot(r)>n.dot(s)?i+=r.projectOnVector(n).length():i+=s.projectOnVector(n).length();var c="",l=new THREE.Vector3;if(.9<n.x?(c="right",l.set(1,0,0)):n.x<-.9?(c="left",l.set(-1,0,0)):.9<n.z?(c="bottom",l.set(0,0,1)):n.z<-.9&&(c="top",l.set(0,0,-1)),c){for(var u=0;u<v[c].length;u++)i+=v[c][u].height+5;v[c].push({name:t.name,height:o})}var p=t.position.clone(),d=t.position.clone().add((new THREE.Vector3).copy(n).multiplyScalar(i));d.add((new THREE.Vector3).subVectors(y.min,d).multiply(E));var m=t.quaternion.clone(),f=E.angleTo(n),g=t.quaternion.clone().multiply((new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),f));new TWEEN.Tween({t:0}).to({t:1,p:d},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){t.position.lerpVectors(p,d,this.t),THREE.Quaternion.slerp(m,g,t.quaternion,this.t)}).start()}},!0),k()}},_e.callFunc.resetPlans=function(){S.forEach(function(e){var t=e.object,n=new THREE.Vector3,a=new THREE.Quaternion,o=new THREE.Vector3;t.userData.initMatrix.decompose(n,a,o);var i=t.position.clone(),r=t.quaternion.clone();new TWEEN.Tween({t:0}).to({t:1},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){t.position.lerpVectors(i,n,this.t),THREE.Quaternion.slerp(r,a,t.quaternion,this.t)}).start()}),k()},_e.callFunc.focusObject=function(e){var t=[ee[e].mesh],a=[];!function e(t){for(var n=0;n<t.length;n++)e(t[n].children),"object"===t[n].userData.type&&a.push(t[n])}(t),Be(a)},A.$on("viewportFocusStart",function(e,t){if(!B.inOrthographicMode)switch(t){case"selected":Fe(G);break;default:We()}}),A.$on("$destroy",function(){oe(null,!1,!0),le(),Ce(),A.spatialize&&Se(),l&&(g.remove(l),l.dispose()),delete tt.callFunc[t],Qe.viewpoint||(Qe.viewpoint={cameraPosition:new THREE.Vector3,controlsCenter:new THREE.Vector3}),Qe.viewpoint.cameraPosition.copy(B.position),Qe.viewpoint.controlsCenter.copy(W.center),W.dispose(),f.forceContextLoss(),f.dispose();var e=angular.element(qe);e.off("keydown",Me),e.off("keyup",xe),e.off("resize",Ne),ee.forEach(function(e){e.removeEventListener("change",L),e.removeEventListener("toggle",Pe),e.removeEventListener("focus",Ae),e.removeEventListener("select",Ue)}),$.forEach(function(e){e.removeEventListener("change",L),e.removeEventListener("toggle",Ie),e.removeEventListener("focus",Ae),e.removeEventListener("select",Ue)}),nt.debug("destroy viewport directive")})}}}]),angular.module("dokuvis.viewport").factory("viewportSettings",[function(){var e=[{value:"color",label:"Color"},{value:"grey",label:"Grey"},{value:"transparent",label:"Transparent"},{value:"onlyEdges",label:"Only edges"},{value:"xray",label:"X-Ray"},{value:"custom",label:"Custom"}],t=[{value:"perspective",label:"Perspective"},{value:"top",label:"Top"},{value:"front",label:"Front"},{value:"back",label:"Back"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"custom",label:"Custom"}];return{defaults:{NEAR:1,FAR:4e3,initWidth:800,initHeight:600,backgroundColor:6710886,selectionColor:16535082,highlightColor:16777028,objectColor:14540253,edgeColor:3355443},shadings:e,cameras:t,shading:e[0].value,camera:t[0].value,showEdges:!0,images:{opacity:1,scale:3}}}]).factory("viewportCache",["viewportSettings",function(e){var t=new THREE.Scene;t.fog=new THREE.Fog(e.defaults.backgroundColor,e.defaults.FAR-100,e.defaults.FAR),t.add(new THREE.GridHelper(100,10)),t.add(new THREE.AmbientLight(8947848));var n=new THREE.DirectionalLight(16777215,.7);n.position.set(-2,8,4),t.add(n);var a={};a.initGeo=new THREE.Geometry;var o={};o.defaultMat=new THREE.MeshLambertMaterial({name:"defaultMat",color:DV3D.Defaults.objectColor}),o.defaultDoublesideMat=new THREE.MeshLambertMaterial({name:"defaultDoublesideMat",color:DV3D.Defaults.objectColor,side:THREE.DoubleSide}),o.defaultUnsafeMat=new THREE.MeshLambertMaterial({name:"defaultUnsafeMat",color:11184810,transparent:!0,opacity:.5,depthWrite:!1}),o.selectionMat=new THREE.MeshLambertMaterial({name:"selectionMat",color:DV3D.Defaults.selectionColor,side:THREE.DoubleSide}),o.transparentMat=new THREE.MeshLambertMaterial({name:"transparentMat",color:13421772,transparent:!0,opacity:.5,depthWrite:!1}),o.transparentSelectionMat=new THREE.MeshLambertMaterial({name:"transparentSelectionMat",color:DV3D.Defaults.selectionColor,transparent:!0,opacity:.5,depthWrite:!1}),o.wireframeMat=new THREE.MeshBasicMaterial({name:"wireframeMat",color:DV3D.Defaults.edgeColor,wireframe:!0}),o.wireframeSelectionMat=new THREE.MeshBasicMaterial({name:"wireframeSelectionMat",color:DV3D.Defaults.selectionColor,wireframe:!0}),o.highlightMat=new THREE.MeshLambertMaterial({name:"highlightMat",color:16777028}),o.transparentHighlightMat=new THREE.MeshLambertMaterial({name:"transparentHighlightMat",color:16777028,transparent:!0,opacity:.5}),o.xrayMat=new THREE.ShaderMaterial({name:"xrayMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.1},intensity:{type:"f",value:1},vColor:{type:"c",value:new THREE.Color(0)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),o.xraySelectionMat=new THREE.ShaderMaterial({name:"xraySelectionMat",side:THREE.DoubleSide,transparent:!0,depthWrite:!1,depthTest:!1,uniforms:{ambient:{type:"f",value:.05},edgefalloff:{type:"f",value:.3},intensity:{type:"f",value:1.5},vColor:{type:"c",value:new THREE.Color(DV3D.Defaults.selectionColor)}},vertexShader:THREE.XRayShader.vertexShader,fragmentShader:THREE.XRayShader.fragmentShader}),o.edgesMat=new THREE.LineBasicMaterial({name:"edgesMat",color:DV3D.Defaults.edgeColor}),o.edgesSelectionMat=new THREE.LineBasicMaterial({name:"edgesSelectionMat",color:DV3D.Defaults.selectionColor}),o.edgesHighlightMat=new THREE.LineBasicMaterial({name:"edgesHighlightMat",color:16777028});var i=new THREE.FontLoader,r={};return i.load("fonts/helvetiker_bold.typeface.json",function(e){r.HelvetikerBold=e}),THREE.DokuVisTray={scene:t,directionalLight:n,geometries:a,materials:o,standardGeometries:Object.keys(a),standardMaterials:Object.keys(o),fonts:r,objects:new DV3D.ObjectCollection,plans:new DV3D.Collection,spatialImages:new DV3D.Collection},THREE.DokuVisTray}]),angular.module("dokuvis.viewport").directive("viewportNavigation",["viewportSettings",function(e){return{templateUrl:"components/dokuvis.viewport/viewportNavigation.tpl.07417b6a.html",restrict:"E",link:function(o){var i=!0,r=!0;function n(e,t){var n;o.navigation.default=!1,o.navigation.rotate=!1,o.navigation.pan=!1,o.navigation.zoom=!1,e&&e in o.navigation?o.navigation[e]=!0:o.navigation.default=!0,o.$applyAsync(),!1!==t&&(n=e,o.$emit("viewportNavigationChange",n))}o.navigation={default:!0,rotate:!1,pan:!1,zoom:!1},o.shadings=e.shadings,o.cameras=e.cameras,o.vpSettings=e,o.focus=function(e){var t;t=e,o.$emit("viewportFocusStart",t)},o.setNavigationMode=n,o.$on("viewportNavigationChange",function(e,t){e.targetScope!==o&&n(t,!1)}),o.$on("viewportShadingChange",function(e,t,n){e.targetScope!==o&&t!==n&&(o.vpSettings.shading=t,r=!1)}),o.$watch("vpSettings.shading",function(e,t){var n,a;r?(n=e,a=t,o.$emit("viewportShadingChange",n,a)):r=!0}),o.$on("viewportCameraChange",function(e,t,n){e.targetScope!==o&&t!==n&&(o.vpSettings.camera=t,i=!1)}),o.$watch("vpSettings.camera",function(e,t){var n,a;i?(n=e,a=t,o.$emit("viewportCameraChange",n,a)):i=!0})}}}]).directive("viewportAxis",["$timeout",function(t){return{restrict:"E",link:function(e,n){var a,o,i,r;function s(){a.render(i,o)}t(function(){var e,t;e=n.width(),t=n.height(),(a=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(e,t),n.append(a.domElement),(o=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,100)).position.set(0,0,50),r=new THREE.AxisHelper(50),(i=new THREE.Scene).add(r),s()}),e.$on("viewportCameraMove",function(e,t){o.rotation.copy(t.rotation),o.position.copy(t.getWorldDirection().negate().setLength(50)),s()}),e.$on("$destroy",function(){r.geometry.dispose(),r.material.dispose(),a.forceContextLoss(),a.dispose()})}}}]).directive("viewportLoadprogress",function(){return{template:'<div class="loadprogress-bar ng-hide" ng-show="visible" ng-style="{ width: progress + \'%\' }"></div>\n<div class="loadprogress-label ng-hide" ng-show="visible">{{ item }} &ndash; {{ loaded }} / {{ total }}</div>',restrict:"E",link:function(o){o.visible=!1,o.item="",o.loaded=0,o.total=0,o.progress=0;var e=o.$on("viewportLoadProgress",function(e,t,n,a){o.visible||(o.progress=n/a*100,o.visible=!0,o.$apply()),o.item=t,o.loaded=n,o.total=a,o.progress=n/a*100,100===o.progress&&(o.visible=!1)});o.$on("$destroy",function(){e()})}}}).directive("viewportSpatializeManual",["$rootScope","Utilities",function(n,t){return{templateUrl:"/components/dokuvis.viewport/viewportSpatializeManual.tpl.995b3a58.html",restrict:"E",link:function(i,e){i.opacity=50,i.moveStep=.2,i.transformView=function(e){var t,n,a=new THREE.Vector3(0,1,0).applyQuaternion(i.camera.quaternion),o=(new THREE.Vector3).subVectors(i.controls.center,i.camera.position).normalize();switch(e){case"up":t=new THREE.Vector3(0,i.moveStep,0),n=a;break;case"down":t=new THREE.Vector3(0,-i.moveStep,0),n=a.negate();break;case"left":t=new THREE.Vector3(-i.moveStep,0,0),n=a.cross(o);break;case"right":t=new THREE.Vector3(i.moveStep,0,0),n=a.cross(o).negate();break;case"forward":t=new THREE.Vector3(0,0,-i.moveStep);break;case"backward":t=new THREE.Vector3(0,0,i.moveStep);break;case"tilt-up":n=new THREE.Vector3(0,i.moveStep,0);break;case"tilt-down":n=new THREE.Vector3(0,-i.moveStep,0)}t&&i.camera.translateOnAxis(t,i.moveStep),n&&(n.setLength(i.moveStep),i.controls.center.add(n)),i.animate()},i.changeFOV=function(){i.camera.updateProjectionMatrix(),i.animate()},i.save=function(){i.source&&i.camera&&(i.source.spatialize={matrix:i.camera.matrixWorld.toArray(),offset:[0,0],ck:1/Math.tan(i.camera.fov/2*THREE.Math.DEG2RAD)*.5},i.source.$spatialize({method:"manual"}).then(function(e){var t;console.log(e),t=e,n.$broadcast("spatializeManualSuccess",t),i.closeSpatializeManual()}).catch(function(e){t.throwApiException("#Source.spatialize",e)}))},e.on("$destroy",function(){i.$destroy()})}}}]).directive("viewportSnapshot",["$rootScope",function(a){return{templateUrl:"components/dokuvis.viewport/viewportSnapshot.6d097a57.html",restrict:"E",link:function(t,n){t.mode="paint",t.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1,width:t.size.width,height:t.size.height},t.setMode=function(e){"pin"===(t.mode=e)?t.startPinning():t.abortPinning()},t.$on("snapshotPrepareSave",function(){var e;e=n.find("#pwCanvasMain")[0].toDataURL("image/png"),a.$broadcast("snapshotPainting",e)}),n.on("$destroy",function(){t.$destroy()})}}}]).directive("viewportSnapshotView",function(){return{templateUrl:"components/dokuvis.viewport/viewportSnapshotView.tpl.2a92bb46.html",restrict:"E",link:function(e,t){e.screenOpacity=0,e.paintOpacity=1,t.on("$destroy",function(){e.$destroy()})}}}).directive("viewportImageControls",["viewportCache","viewportSettings",function(e,n){return{templateUrl:"components/dokuvis.viewport/viewportImageCtrls.tpl.f9975245.html",restrict:"E",link:function(t){t.opacity=100*n.images.opacity,t.scale=n.images.scale,t.setOpacity=function(){e.spatialImages.setOpacity(t.opacity/100),n.images.opacity=t.opacity/100},t.setScale=function(){e.spatialImages.forEach(function(e){e.setScale(t.scale)}),n.images.scale=t.scale}}}}]).directive("viewportSelectionDisplay",["$state",function(e){return{templateUrl:"components/dokuvis.viewport/viewportSelectionDisplay.tpl.06a6b10d.html",restrict:"E",link:function(n){n.imageList=[],n.objectList=[],n.inIsolationMode=!1,n.$on("viewportSelectionChange",function(e,t){n.imageList=t.filter(function(e){return e instanceof DV3D.ImageEntry}),n.objectList=t.filter(function(e){return e instanceof DV3D.ObjectEntry})}),n.$on("viewportIsolationEnter",function(){n.inIsolationMode=!0,console.log(n)}),n.$on("viewportIsolationExit",function(){n.inIsolationMode=!1})}}}]).directive("viewportContextMenu",["$state","ImageCollection",function(n,a){return{templateUrl:"components/dokuvis.viewport/viewportContextMenu.tpl.3916ee6e.html",restrict:"E",link:function(e,t){e.openDetails=function(){n.go(".image",{imageId:e.entry.source.id}),e.$parent.closeContextMenu()},e.addToCollection=function(){a.add(e.entry.source),e.$parent.closeContextMenu()},e.removeFromCollection=function(){a.remove(e.entry.source),e.$parent.closeContextMenu()},e.focus=function(){e.entry.focus(),e.$parent.closeContextMenu()},t.on("$destroy",function(){e.$destroy()})}}}]).directive("viewportAnalysisTools",["$debounce",function(a){return{templateUrl:"components/dokuvis.viewport/viewportAnalysisTools.tpl.805a1860.html",restrict:"E",link:function(t,e){function n(e){t.$emit("viewportHeatMapUpdate",angular.extend(e,{visible:t.heatMap.visible,overlay:t.heatMap.overlay,radius:t.heatMap.radius}))}t.heatMap={visible:!1,overlay:!1,radius:40,toggle:function(){n({visibilityChange:!0})},toggleOverlay:function(){n({overlayChange:!0})},changeRadius:a(function(){n({radiusChange:!0})},1e3)},e.on("$destroy",function(){t.$destroy()})}}}]),angular.module("dokuvis.viewport").directive("viewportObjectTree",["viewportCache",function(e){return{templateUrl:"components/dokuvis.viewport/viewportObjectTree.tpl.03bd6b80.html",restrict:"E",link:function(t){t.objects=e.objects,t.layers=e.objects.layers,t.hierarchy=e.objects.hierarchy,t.showLayers=!1,t.showHierarchy=!0,t.switchTo=function(e){switch(e){case"layers":t.showLayers=!0,t.showHierarchy=!1;break;default:t.showLayers=!1,t.showHierarchy=!0}}}}}]).directive("viewportPlanList",["viewportCache",function(t){return{templateUrl:"components/dokuvis.viewport/viewportPlanList.tpl.df662432.html",restrict:"E",link:function(e){e.plans=t.plans}}}]).directive("viewportImageList",["viewportCache",function(t){return{templateUrl:"components/dokuvis.viewport/viewportImageList.tpl.18bd03f3.html",restrict:"E",link:function(e){e.images=t.spatialImages}}}]),angular.module("dokuvis.imageViewer",[]).directive("imageViewer",["$document","$window","$timeout","SpatializeInterface","$debounce","$log",function(U,F,W,B,N,q){return{restrict:"E",template:'<div class="ctrl-container ctrl-bottom-left" ng-if="grid">\n\t<div>\n\t\t<div class="ctrl-group">\n\t\t\t<input type="checkbox" ng-model="grid.visible" ng-change="grid.onVisibilityChange()"/> Show grid\n\t\t</div>\n\t\t<div class="ctrl-group" ng-show="grid.visible">\n\t\t\t<div class="ctrl-slider">\n\t\t\t<span>Size</span>\n\t\t\t<input class="dvSlider" type="range" min="0" max="100" step="1" ng-model="grid.size" ng-change="grid.onSizeChange()"/>\n\t\t</div>\n\t</div>\n\t</div>\n</div>',scope:{source:"=src",options:"=options"},link:function(n,a,e){angular.element(a).css("overflow","hidden");var o,i,r,s,c,l,u,p,d,m,f,g,h,t,v=!1,E=!1,y=!1,w=!1,b=!1,T=.0015,M=.1,x=-.05,D=-1,R=new THREE.TextureLoader;function S(){n.$applyAsync()}U.on("mouseup",C),angular.element(F).on("resize",S);var $=N(function(){P()},200,!1,!1);function H(e){-1!==["jpg","png"].indexOf(e.split(".").pop())&&(E=!0,console.log("source:",e),v&&(y||(u.add(f),y=!0),R.load(e,function(e){e.minFilter=THREE.LinearFilter,r=n.options&&n.options.width&&n.options.height?n.options.width/n.options.height:e.image.width/e.image.height,n.spatialize&&(B.imageWidth=n.options.width||e.image.width,B.imageHeight=n.options.height||e.image.height),f.geometry.dispose(),f.geometry=new THREE.PlaneBufferGeometry(r,1,1,1),f.material.map&&f.material.map.dispose(),f.material.map=e,f.material.needsUpdate=!0,z()},null,function(){console.error("ImageViewer: Couldn't load texture!")})))}function j(){p.render(u,d)}function V(e){e.preventDefault(),(0===e.button&&!b||1===e.button)&&(w=!0)}function C(e){if(!w||0!==e.button&&1!==e.button){if(0===e.button&&b){var t=h;g.setNumber(B.markers2D.length+1),B.markers2D.push({object:g,u:t.x,v:t.y,x:(t.x-.5)*r,y:t.y-.5}),b=!1,g=null,j(),n.$applyAsync()}}else w=!1}function k(e){if(e.preventDefault(),w)f.translateX(e.originalEvent.movementX*T*-f.position.z),f.translateY(e.originalEvent.movementY*T*f.position.z),L(),j();else if(b){var t=new THREE.Vector2;t.x=e.offsetX/o*2-1,t.y=-e.offsetY/i*2+1,function(e){var t=new THREE.Vector3(e.x,e.y,.5).unproject(d),n=new THREE.Raycaster(d.position,t.sub(d.position).normalize()).intersectObject(f);if(n[0]){var a=n[0].uv;h=a,g.position.set(a.x*r-r/2,a.y-.5,0)}}(t),j()}}function I(e){if(e.originalEvent.deltaY<0){var t=-M*f.position.z;if(f.position.z+t>x)return;f.translateZ(t),L(),j()}else 0<e.originalEvent.deltaY&&(t=M*f.position.z,f.position.z+t<=D&&(t=D-f.position.z),f.translateZ(t),L(),j())}function L(){var e=Math.abs(f.position.z)*Math.tan(c),t=Math.abs(f.position.z)*Math.tan(l),n=2*e,a=2*t,o=Math.abs(f.position.x-r/2)+Math.abs(f.position.x+r/2),i=Math.abs(f.position.y-.5)+Math.abs(f.position.y+.5);r<s&&o<n?(e<f.position.x+r/2&&f.translateX(e-(f.position.x+r/2)),-e>f.position.x-r/2&&f.translateX(-e-(f.position.x-r/2))):(e>f.position.x+r/2&&f.translateX(e-(f.position.x+r/2)),-e<f.position.x-r/2&&f.translateX(-e-(f.position.x-r/2))),s<r&&i<a?(t<f.position.y+.5&&f.translateY(t-(f.position.y+.5)),-t>f.position.y-.5&&f.translateY(-t-(f.position.y-.5))):(t>f.position.y+.5&&f.translateY(t-(f.position.y+.5)),-t<f.position.y-.5&&f.translateY(-t-(f.position.y-.5)))}function z(){if(r<s)f.position.set(0,0,-1),D=-1;else{var e=r/2/Math.tan(c);f.position.set(0,0,-e),D=-e}j()}function O(){angular.forEach(B.markers2D,function(e){f.remove(e.object),e.object.dispose()}),B.markers2D.splice(0,B.markers2D.length),j(),n.$applyAsync()}function P(e,t){o=e||a.width(),i=t||a.height(),s=o/i,c=Math.atan(.5*s),l=Math.atan(.5);var n=f&&f.position.z===D;D=r&&s<r?-r/2/Math.tan(c):-1,d&&(d.aspect=s,d.updateProjectionMatrix()),p&&(p.setSize(o,i),f&&n?z():j())}function A(e){var t=Math.log(.1),n=(Math.log(2)-t)/100;return Math.exp(t+n*(e-0))}n.$watch(function(){$()}),n.$watch("source",H),W(function(){P(),function(){u=new THREE.Scene,(p=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setClearColor(16777215,0),p.setSize(o,i),a.append(p.domElement),(d=new THREE.PerspectiveCamera(2*l*180/Math.PI,s,.01,500)).lookAt(new THREE.Vector3(0,0,-1));var e=new THREE.PlaneBufferGeometry(1,1,1,1),t=new THREE.MeshBasicMaterial;(f=new THREE.Mesh(e,t)).position.set(0,0,-1),(m=angular.element(p.domElement)).on("mousedown",V),m.on("mousemove",k),m.on("wheel",I),m.on("contextmenu",function(e){e.preventDefault()}),v=!0,j()}(),E&&H(n.source)}),"spatialize"in e&&(n.spatialize={markers:B.markers2D}),n.spatialize&&(n.startMarking=function(){(g=new DV3D.TorusMarker(.008)).addEventListener("change",j),f.add(g),b=!0},n.clearMarkers=O),"grid"in e&&(n.grid={visible:!1,size:50,onSizeChange:function(){var e=A(this.size);t.scale.set(e,e,e),j()},onVisibilityChange:function(){if(!this.visible||t&&f.getObjectById(t.id))f.remove(t);else{if(!t){(t=new THREE.GridHelper(20,200,65280,16776960)).material.transparent=!0,t.material.opacity=.5,t.rotateX(Math.PI/2),t.position.set(0,0,.01);var e=A(this.size);t.scale.set(e,e,e)}f.add(t)}j()}}),n.$on("$destroy",function(){f&&(f.geometry.dispose(),f.material.map&&f.material.map.dispose(),f.material.dispose()),t&&(f.geometry.dispose(),f.material.dispose()),p&&(p.forceContextLoss(),p.dispose(),p=null),n.spatialize&&O(),U.off("mouseup",C),angular.element(F).off("resize",S),q.debug("destroy imageViewer directive")})}}}]),angular.module("uh4d.images",["ngResource","xeditable","ngTagsInput","uh4d.actors"]).run(["editableOptions","editableThemes",function(e,t){e.theme="bs3",t.bs3.buttonsClass="btn-sm",t.bs3.inputClass="form-control-sm",t.bs3.submitTpl='<button type="submit" class="btn btn-primary"><span class="fa fa-check"></span></button>',t.bs3.cancelTpl='<button type="button" class="btn btn-default" ng-click="$form.$cancel()"><span class="fa fa-times"></span></button>'}]).factory("Image",["$resource",function(e){return e("api/image/:id",{id:"@id"},{query:{url:"api/search",method:"GET",isArray:!0},update:{method:"PUT"},spatialize:{method:"PUT",url:"api/image/:id/spatial"},checkFileUpdate:{url:"api/image/:id/file/check",method:"GET"},updateFile:{url:"api/image/:id/file/update",method:"GET"}})}]).component("imageList",{templateUrl:"components/uh4d.images/imageList.tpl.14e0d686.html",controller:["$scope","$state","Image","Utilities","viewportCache","$debounce","ImageCollection",function(e,a,t,n,o,i,r){var s=this;s.itemsPerPage=20,s.$onInit=function(){console.log("imageList init"),s.listTab="selection",s.listMode="list",s.listOrderBy={prop:"title",desc:!1},s.page=0,s.selection=[],r.promise.then(function(e){s.collection=e,l()})},e.$on("imageQuerySuccess",function(e,t){s.images=t,s.currentPage=1,l()});var c=i(function(e){s.selection=e.filter(function(e){return e instanceof DV3D.ImageEntry}).map(function(e){return e.source})},200);function l(){s.images&&s.images.length&&s.images.forEach(function(e){r.get(e.id)?e.inCollection=!0:!0===e.inCollection&&(e.inCollection=!1)})}e.$on("viewportSelectionChange",function(e,t){console.log(t),c(t)}),e.$on("ImageCollectionUpdate",function(){l()}),e.$on("imageUpdate",function(e,t){var n=s.images.find(function(e){return e.id===t.id});n&&angular.extend(n,t)}),s.openImage=function(e){a.go(".image",{imageId:e})},s.openCompareModal=function(e,t,n){e.stopPropagation(),a.go(".compare",{imageId1:t.id,imageId2:n.id})},s.setListTab=function(e){e===s.listTab?s.listTab="":s.listTab=e},s.setListMode=function(e){switch(e){case"list":case"cards":s.listMode=e}},s.addToCollection=function(e,t){e.stopPropagation(),r.add(t),s.collection=r.get()},s.removeFromCollection=function(e,t){e.stopPropagation(),r.remove(t),s.collection=r.get()},s.focusImage=function(e,t){if(e.stopPropagation(),t){var n=o.spatialImages.getByName(t.id);console.log(n),n&&n.focus()}}}]}).component("imageModal",{templateUrl:"components/uh4d.images/imageModal.tpl.75c3eda6.html",controller:["$rootScope","$state","$timeout","Image","Utilities","ImageCollection","Person","LegalBody","$http",function(a,t,e,o,i,r,n,s,c){var l=this;function u(e){a.$broadcast("imageUpdate",e)}l.$onInit=function(){e(function(){!function(n){if(!n)return;o.get({id:n}).$promise.then(function(e){var t;console.log(e),l.image=e,l.tags=e.tags.map(function(e){return{text:e}}),r.get(n)&&(l.image.inCollection=!0),a.editableMode&&(t=n,o.checkFileUpdate({id:t}).$promise.then(function(e){e.message||(l.fileUpdate=e)}).catch(function(e){i.throwApiException("Image.checkFileUpdate",e)}))}).catch(function(e){i.throwApiException("Image.get",e)})}(t.params.imageId)},0,!1)},l.addToCollection=function(){r.add(l.image)},l.removeFromCollection=function(){r.remove(l.image)},l.startSpatialize=function(){var e;t.go("^"),e=l.image,a.$broadcast("spatializeManualStart",e)},l.updateImage=function(t,e){if(l.image[t]===e)return!1;var n=l.image[t];return"tags"===t?l.image.tags=e.map(function(e){return e.text}):l.image[t]=e,l.image.$update({prop:t}).then(function(e){return console.log(e),u(l.image),!1}).catch(function(e){return i.throwApiException("Image.update",e),l.image[t]=n,!1})},l.updateFile=function(){l.isSaving=!0,o.updateFile({id:l.image.id}).$promise.then(function(e){console.log(e),l.image.file=e,l.fileUpdate=null,u(l.image),l.isSaving=!1}).catch(function(e){i.throwApiException("Image.updateFile",e),l.isSaving=!1})},l.queryPersons=function(e){return n.query({name:e}).$promise.then(function(e){return e.map(function(e){return e.name})}).catch(function(e){i.throwApiException("Person.query",e)})},l.queryLegalBodies=function(e){return s.query({name:e}).$promise.then(function(e){return e.map(function(e){return e.name})}).catch(function(e){i.throwApiException("LegalBody.query",e)})},l.queryTags=function(e){return c.get("api/tag?query="+e).then(function(e){return console.log(e),e.data.map(function(e){return e.tag})}).catch(function(e){i.throwApiException("$http.get api/tag",e)})},l.close=function(){t.go("^")}}]}).component("compareModal",{templateUrl:"components/uh4d.images/compareModal.tpl.a00dd742.html",controller:["$q","$state","$timeout","Image","Utilities",function(n,e,t,a,o){var i=this;function r(e){var t=n.defer();return a.get({id:e}).$promise.then(function(e){t.resolve(e)}).catch(function(e){o.throwApiException("Image.get",e),t.resolve(null)}),t.promise}i.$onInit=function(){t(function(){r(e.params.imageId1).then(function(e){i.image1=e}),r(e.params.imageId2).then(function(e){i.image2=e})},0,!1)},i.close=function(){e.go("^")}}]}).service("ImageCollection",["$window","$rootScope","$q","Image","Utilities",function(o,e,i,r,s){var c=[],l=o.localStorage.collectionIds?angular.fromJson(o.localStorage.collectionIds):[],t=[],n=i.defer();function u(){e.$broadcast("ImageCollectionUpdate",c)}l.forEach(function(e){t.push(r.get({id:e}).$promise)}),i.all(t).then(function(e){e.forEach(function(e){e&&(e.inCollection=!0,c.push(e))}),n.resolve(c)}),this.promise=n.promise,this.get=function(t){return t?c.find(function(e){return e.id===t}):c},this.add=function(e){if(e){var t,n,a="string"==typeof e?e:e.id;if(-1===l.indexOf(a))l.push(a),o.localStorage.collectionIds=angular.toJson(l),"string"==typeof e?(t=a,n=i.defer(),r.get({id:t}).$promise.then(function(e){n.resolve(e)}).catch(function(e){s.throwApiException("Image.get() in ImageCollection",e),n.resolve()}),n.promise).then(function(e){e&&(e.inCollection=!0,c.push(e))}):(e.inCollection=!0,c.push(e)),u()}},this.remove=function(e){if(e){var t="string"==typeof e?e:e.id,n=l.indexOf(t);-1!==n&&(l.splice(n,1),o.localStorage.collectionIds=angular.toJson(l),-1!==(n=c.findIndex(function(e){return e.id===t}))&&c.splice(n,1),e.inCollection&&(e.inCollection=!1),u())}}}]),angular.module("uh4d.models",["ngResource"]).factory("DigitalObject",["$resource",function(e){function o(e,t){for(var n=0;n<e.length;n++){if(e[n].id===t)return e[n];if(e[n].children){var a=o(e[n].children,t);if(void 0!==a)return a}}}var i=e("api/model/:id",{id:"@id"},{query:{method:"GET",isArray:!0,transformResponse:function(e){return function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.children||(n.children=[]),n.parent){var a=o(e,n.parent);a&&(a.children||(a.children=[]),a.children.push(new i(n)),e.splice(t,1),t--)}}return e}(angular.fromJson(e))}}});return i}]),angular.module("uh4d.actors",["ngResource"]).factory("Person",["$resource",function(e){return e("api/person/:id",{id:"@id"})}]).factory("LegalBody",["$resource",function(e){return e("api/legalbody/:id",{id:"@id"})}]);