angular.module("uh4dApp",["ui.router","ngAnimate","ngResource","mgcrea.ngStrap","ui.bootstrap","ng-clamp","dokuvis.viewport","dokuvis.utils","dokuvis.imageViewer","uh4d.images","uh4d.models","uh4d.timeSlider"]).config(["$stateProvider","$urlRouterProvider","$modalProvider","$uibModalProvider","$selectProvider",function(e,t,n,o,a){t.otherwise("/"),e.state({name:"root",url:"?edit",abstract:!0,views:{root:{template:"<ui-view></ui-view>"},header:"header"},params:{edit:{type:"query",value:null}}}).state({name:"root.home",url:"/",templateUrl:"partials/home.d8d32bc7.html"}).state({name:"root.search",url:"/search?query&from&to&modelDate&undated&page&filterObjIncl&filterObjExcl",component:"search",params:{query:{type:"query",dynamic:!0,value:null},from:{type:"query",dynamic:!0,value:null},to:{type:"query",dynamic:!0,value:null},modelDate:{type:"query",dynamic:!0,value:null},undated:{type:"query",dynamic:!0,value:null},page:{type:"query",dynamic:!0,value:null},filterObjIncl:{type:"query",dynamic:!0,array:!0,value:[]},filterObjExcl:{type:"query",dynamic:!0,array:!0,value:[]}}}).state({name:"root.search.image",url:"/image/:imageId",redirectTo:function(e){if(!e.params().imageId)return"root.search"},params:{imageId:{dynamic:!0}},resolve:{imageModalInstance:["$state","$uibModal",function(e,t){var n=t.open({component:"imageModal",size:"large"});return n.result.then(null,function(){e.go("^")}),n}]},onExit:["imageModalInstance",function(e){e.close()}]}).state({name:"root.search.object",url:"/object/:objectId",resolve:{objectModalInstance:["$state","$uibModal",function(e,t){var n=t.open({component:"objectModal",size:"large"});return n.result.then(null,function(){e.go("^")}),n}]},onExit:["objectModalInstance",function(e){e.close()}]}).state({name:"root.search.uploadModel",url:"/uploadModel",resolve:{uploadModalInstance:["$state","$uibModal",function(e,t){var n=t.open({component:"uploadModal"});return n.result.then(null,function(){e.go("^")}),n}]},onExit:["uploadModalInstance","ModelUploader",function(e,t){e.close(),t.clearQueue()}]}).state({name:"root.search.compare",url:"/compare?imageId1&imageId2",redirectTo:function(e){if(!e.params().imageId1||!e.params().imageId2)return"root.search"},resolve:{compareModalInstance:["$state","$uibModal",function(e,t){var n=t.open({component:"compareModal",size:"xlarge"});return n.result.then(null,function(){e.go("^")}),n}]},onExit:["compareModalInstance",function(e){e.close()}]}).state({name:"root.help",url:"/help",templateUrl:"partials/help.02c5fe89.html"}).state({name:"root.legalnotice",url:"/legalnotice",templateUrl:"partials/legalnotice.503a83b0.html"}),angular.extend(n.defaults,{backdrop:"static",keyboard:!1}),angular.extend(o.options,{animation:!1,backdrop:!0,keyboard:!1}),angular.extend(a.defaults,{templateUrl:"partials/overrides/bs.select.tpl.4f5a4048.html"})}]).run(["$rootScope","$state",function(t,e){t.showModelLoadPanel=!0,t.$watch(function(){return e.params.edit},function(e){t.editableMode="true"===e})}]),angular.module("uh4dApp").component("header",{templateUrl:"app/header/header.tpl.9ad6f16c.html",controller:["$scope","$state",function(e,t){var n=this;n.submitSearch=function(){t.go("root.search",{query:n.searchTerm})},e.$watch(function(){return t.params.query},function(e){n.searchTerm=e})}]}),angular.module("uh4dApp").component("search",{templateUrl:"app/search/search.tpl.77e96dd4.html",controller:["$scope","$rootScope","$state","$uiRouterGlobals","$timeout","Image","DigitalObject","Utilities",function(e,a,c,t,i,n,o,r){function s(e){n.query({query:e||c.params.query,from:c.params.from,to:c.params.to,undated:c.params.undated,filterObjIncl:c.params.filterObjIncl,filterObjExcl:c.params.filterObjExcl}).$promise.then(function(e){var t,n,o;console.log(e),t=e,a.$broadcast("imageQuerySuccess",t),n=[],e.forEach(function(e){e.spatial&&n.push(e)}),o=n,a.$broadcast("spatialImageLoadStart",o)}).catch(function(e){r.throwApiException("Image.query() in search component",e)})}function l(){o.query({modelDate:c.params.modelDate}).$promise.then(function(e){var t,n;console.log(e),a.showModelLoadPanel=!1,t=e,a.$broadcast("modelQuerySuccess",t,!0===n)}).catch(function(e){r.throwApiException("DigitalObject.query",e)})}function u(){e.$watchGroup([function(){return c.params.query},function(){return c.params.from},function(){return c.params.to},function(){return c.params.undated},function(){return c.params.filterObjIncl.length},function(){return c.params.filterObjExcl.length}],function(){s()}),e.$watchGroup([function(){return c.params.modelDate}],function(){l()})}console.log("search component",e),e.$on("searchUpdate",function(){s()}),e.$on("timeSliderReady",function(e,t,n,o,a){c.go("root.search",{from:t,to:n,modelDate:o,undated:a}),i(u,0,!0)}),e.$on("filterByDate",function(e,t,n,o,a){c.go("root.search",{from:t,to:n,modelDate:o,undated:a})}),e.$on("filterByObject",function(e,t,n){console.log("filterByObject event",t,n);var o=[].concat(c.params.filterObjIncl),a=[].concat(c.params.filterObjExcl),i=!1,r=t instanceof DV3D.ObjectEntry?t.name:t.id;switch(n){case"include":-1===o.indexOf(r)&&(o.push(r),i=!0);break;case"exclude":-1===a.indexOf(r)&&(a.push(r),i=!0);break;default:var s=o.indexOf(r);-1!==s&&(o.splice(s,1),i=!0),-1!==(s=a.indexOf(r))&&(a.splice(s,1),i=!0)}i&&c.go("root.search",{filterObjIncl:o,filterObjExcl:a})})}]}),angular.module("uh4dApp").factory("SpatializeInterface",function(){var o={callFunc:{},markers2D:[],markers3D:[],imageWidth:0,imageHeight:0,getDLTInputs:function(){if(o.markers2D.length!==o.markers3D.length)return console.warn("Missing markers!"),void console.log(o.markers2D,o.markers3D);for(var e="",t=0,n=o.markers2D.length;t<n;t++)e+=[t+1,o.markers3D[t].x,o.markers3D[t].y,o.markers3D[t].z,1e3*o.markers2D[t].x,1e3*o.markers2D[t].y,"\n"].join(" ");return console.log(e),e}};return o}),angular.module("dokuvis.utils",["mgcrea.ngStrap","pascalprecht.translate"]).factory("Utilities",["$timeout","$alert",function(i,o){var r={waitfor:function(e,t,n,o,a){e()===t?a(o):setTimeout(function(){r.waitfor(e,t,n,o,a)},n)},dblclickSwitch:function(t,n){return function(e){o?(o=!1,a&&i.cancel(a),n&&n(e)):a=i(function(){o=!1,t&&t(e)},300,!(o=!0))};var o,a},successAlert:function(e){o({content:e,type:"success",duration:5})},dangerAlert:function(e){o({content:e,type:"danger",duration:5})},throwException:function(e,t,n){o({title:e+":",content:t,type:"danger",duration:5}),console.error(e+": "+t,n,"\n"+(new Error).stack.split("\n")[2])},throwApiException:function(e,t){403===t.status&&(e="Access denied "+e+" ("+t.statusText+" "+t.status+")"),o({title:"API Exception:",content:e,type:"danger",duration:5}),console.error("API Exception: "+e,t,"\n"+(new Error).stack.split("\n")[2])}};return r}]).factory("ConfirmDialog",["$q","$alert",function(i,r){var s={backdrop:"static",templateUrl:"components/dokuvis.utils/confirmAlert.tpl.28b6556b.html",show:!0},c={abortButtonText:"abort",actionButtonText:"OK",headerText:"continue?",bodyText:"Sind Sie sicher?",type:"warning",translationData:{}};return function(e,t){return t||(t={}),function(e,t){var n={},o={};angular.extend(n,s,t),angular.extend(o,c,e),n.alertOptions=o;var a=i.defer();return n.controller=function(e){e.alertOptions=o,e.alertOptions.ok=function(){e.$hide(),a.resolve()},e.alertOptions.abort=function(){e.$hide(),a.reject()}},r(n),a.promise}(e,t)}}]).directive("fileDropArea",["$timeout","$state",function(e,a){return{restrict:"AE",scope:{uploader:"=",label:"@"},link:function(t,n,o){e(function(){var e=angular.element(n);"uiSref"in o&&(e.find("input").remove(),t.uploader.onAfterAddingAll=function(){a.includes(o.uiSref)||a.includes("**"+o.uiSref)||a.go(o.uiSref)}),"multiple"in o&&e.find("input").attr("multiple",!0),"column"in o&&e.children().css("flex-direction","column")}),t.openFileDialog=function(){e(function(){angular.element(n).find("input").trigger("click")})}},template:'<div ng-if="uploader" data-uploader="uploader" nv-file-drop nv-file-over ng-click="openFileDialog()">\n\t<input type="file" ng-hide="1" data-uploader="uploader" nv-file-select ng-click="$event.stopPropagation()"/>\n\t<svg x="0px" y="0px" viewBox="0 0 10 10" enable-background="new 0 0 10 10" xml:space="preserve">\n\t\t<path d="M3.746,10V6.283H0V3.717h3.746V0h2.497v3.717H10v2.566H6.243V10H3.746z"/>\n\t</svg>\n\t<div>{{label|translate}}</div>\n</div>'}}]).directive("noContextMenu",function(){return{compile:function(e){e.bind("contextmenu",function(e){e.preventDefault()})}}}).directive("resizable",["$rootScope","$document","$timeout",function(g,h,v){return{restrict:"A",link:function(e,t,n){var o=!0,a=t.find("> *").first();a.addClass("resize-object");var i='<div class="resize-handle"><span></span></div>';switch(n.rDirection){case"top":t.prepend(i),t.addClass("resize-top"),o=!1;break;case"bottom":t.append(i),t.addClass("resize-bottom"),o=!1;break;case"left":t.prepend(i),t.addClass("resize-left");break;default:t.append(i),t.addClass("resize-right")}var r=t.find(".resize-handle"),s=0,c=0,l=!1,u=!0,d=n.rSizeMin?parseInt(n.rSizeMin):0;function p(e){if(!l)if(o){var t=c+s-e.pageX;a.css({width:(t<d?d:t)+"px"})}else{var n=c+s-e.pageY;a.css({height:(n<d?d:n)+"px"})}}function f(e){h.off("mousemove",p),h.off("mouseup",f),u||e.target!==r[0]&&e.target.parentNode!==r[0]?(o&&s!==e.pageX||!o&&s!==e.pageY)&&m():function(){l=l?(t.removeClass("resize-toggled"),!1):(t.addClass("resize-toggled"),!0);m()}()}function m(){g.$broadcast("resizeLayout")}r.on("mousedown",function(e){e.preventDefault(),0===e.button&&(v(function(){u=!0},200,u=!1),h.on("mousemove",p),h.on("mouseup",f),c=o?(s=e.pageX,a.width()+r.width()):(s=e.pageY,a.height()+r.height()))})}}}]).component("legendGradient",{template:"<svg></svg>",bindings:{domain:"<",gradient:"<",orientation:"@"},controller:["$scope","$element","$timeout",function(e,t,n){var p,f,m=this,g={0:"#000",1:"#fff"},h=[0,100];function o(){p.empty(),"left"===m.orientation||"right"===m.orientation?(p.css("width","50px"),p.css("height","100%")):(p.css("width","100%"),p.css("height","40px"));var e=p.width(),t=p.height(),n=m.domain||h,o=[n[0],Math.round((n[1]-n[0])/2+n[0]),n[1]],a=m.gradient||g,i=[];for(var r in a)i.push({stop:100*r,color:a[r]});i.sort(function(e,t){return e.stop-t.stop});var s=f.append("defs").append("linearGradient").attr("id","svgGradient").attr("x1","0%").attr("y2","0%");i.forEach(function(e){s.append("stop").attr("offset",e.stop+"%").attr("stop-color",e.color)});var c,l=d3.scaleLinear().domain(n),u=f.append("rect"),d=f.append("g");switch(m.orientation){case"left":s.attr("x2","0%").attr("y1","100%"),u.attr("x",30).attr("y",10).attr("width",20).attr("height",Math.max(t-20+1,0)),l.range([t-20,0]),c=d3.axisLeft(l).tickValues(o),d.attr("transform","translate(30,10)");break;case"right":s.attr("x2","0%").attr("y1","100%"),u.attr("y",10).attr("width",20).attr("height",Math.max(t-20+1,0)),l.range([t-20,0]),c=d3.axisRight(l).tickValues(o),d.attr("transform","translate(20,10)");break;case"top":s.attr("x2","100%").attr("y1","0%"),u.attr("x",10).attr("y",20).attr("width",Math.max(e-20+1,0)).attr("height",20),l.range([0,e-20]),c=d3.axisTop(l).tickValues(o),d.attr("transform","translate(10,20)");break;default:s.attr("x2","100%").attr("y1","0%"),u.attr("x",10).attr("width",Math.max(e-20+1,0)).attr("height",20),l.range([0,e-20]),c=d3.axisBottom(l).tickValues(o),d.attr("transform","translate(10,20)")}u.attr("fill","url(#svgGradient)"),d.call(c)}m.$onInit=function(){p=t.find("svg"),f=d3.select(p[0]),e.$watchGroup([function(){return m.domain},function(){return m.gradient}],function(){n(o)})}}]}),angular.module("dokuvis.viewport",["pascalprecht.translate","ngDebounceThrottle"]).component("viewport",{template:"<canvas ng-class=\"{'cursor_orbit': navigation.rotate, 'cursor_pan': navigation.pan, 'cursor_zoom': navigation.zoom}\"></canvas>\n<div class=\"viewport-extras\"></div>",controller:["$scope","$element","$attrs","$state","$window","$timeout","viewportCache","viewportSettings","$rootScope","$q","Utilities","$debounce","$throttle","SpatializeInterface","$log","$compile","$animate","Image",function(N,q,a,e,i,t,r,f,_,m,B,n,o,s,c,G,Q,X){console.log(N,q,a);var J,K,l,u,d,p,g,h,v,E,b=a.id||0;s.callFunc[b]={};var y,w,Z,x,ee,te,D,ne,$,oe,j,M,T,C,R,I,k,V,H,O,S,A,z,L,U,ae,ie,re,P=f.defaults.NEAR,se=f.defaults.FAR,Y=new THREE.Raycaster,ce=[],W=null,F=[],le=null,ue=0,de=!1,pe=!1,fe=new THREE.Vector2,me=null,ge=-1,he=!1,ve=!1,Ee=!1,be=N.navigation={default:!0,rotate:!1,pan:!1,zoom:!1},ye=!1,we=!1,xe=!1,De=!1,$e=r.objects,je=r.plans,Me=r.spatialImages,Te=r.geometries,Ce=r.materials;function Re(){K&&(K.$destroy(),K=null),J&&(Q.leave(J),J=null)}var Ie=n(function(e,t){var n,o;e instanceof DV3D.ClusterObject?(e.explode(),Ye()):(n=e,o=t,(u=N.$new(!1)).position=o,u.entry=n,u.close=ke,l=G("<viewport-tooltip></viewport-tooltip>")(u),Q.enter(l,q))},500,!(this.$onInit=function(){console.log("viewport $onInit"),y=q.width(),w=q.height(),console.log("viewport size: ",y,w),oe=new THREE.PerspectiveCamera(35,y/w,P,se),r.viewpoint?oe.position.copy(r.viewpoint.cameraPosition):oe.position.copy(f.defaults.viewpoint.cameraPosition),ee=r.scene,Z=q.find("canvas"),(x=new THREE.WebGLRenderer({antialias:!0,alpha:!1,preserveDrawingBuffer:!0,canvas:Z.get(0)})).setClearColor(DV3D.Defaults.backgroundColor,1),x.setSize(y,w),q.append(x.domElement),(te=new THREE.OrbitControls(oe,x.domElement)).zoomSpeed=1,r.viewpoint?te.target.copy(r.viewpoint.controlsTarget):te.target.copy(f.defaults.viewpoint.controlsTarget),oe.target=te.target,te.addEventListener("change",ze),te.addEventListener("end",function(){$t()}),j=r.directionalLight;var e=r.loadingManager;e.onProgress=Se,e.onLoad=function(){},Z.on("mousedown",pt),Z.on("mousemove",ft),Z.on("mouseup",mt),Z.on("dblclick",gt),q.on("mouseleave",ht),Z.on("wheel",vt),Z.on("contextmenu",function(e){e.preventDefault()});var t,n,o=angular.element(i);o.on("keydown",Et),o.on("keyup",bt),o.on("resize",Pt),N.$on("resizeLayout",Pt),M=new THREE.Octree({}),(T=new DV3D.ClusterTree(ee,M)).setDistanceMultiplier(f.images.clusterDistance),(D=new THREE.TransformControls(oe,x.domElement)).addEventListener("change",ze),D.addEventListener("dragging-changed",function(e){te.enabled=!e.value}),ee.add(D),(I=new DV3D.GizmoMove(10,2.5,1.2)).addEventListener("change",Ne),(k=new DV3D.GizmoRotate(10)).addEventListener("change",Ne),$e.forEach(function(e){e.addEventListener("change",Ye),e.addEventListener("toggle",Vt),e.addEventListener("focus",Ht),e.addEventListener("select",Ot)}),Me.forEach(function(e){e.addEventListener("change",Ye),e.addEventListener("toggle",Ct),e.addEventListener("select",Ot),e.addEventListener("focus",Ht)}),T.bulkInsert(Me.get().map(function(e){return e.object})),Ne(),Ae(oe),"navigation"in a&&((t=N.$new(!1)).focus=function(e){if(!oe.inOrthographicMode)switch(e){case"selected":St(ce);break;default:At()}},t.flyHome=Ut,n=G("<viewport-navigation></viewport-navigation>")(t),Q.enter(n,q)),"compass"in a&&((t=N.$new(!1)).faceNorth=Lt,n=G("<viewport-compass></viewport-compass>")(t),Q.enter(n,q)),"loadProgress"in a&&(t=N.$new(!1),n=G("<viewport-load-progress></viewport-load-progress>")(t),Q.enter(n,q)),"imageControls"in a&&((t=N.$new(!1)).setClusterDistanceMultiplier=function(e){T.setDistanceMultiplier(e),Ye()},n=G("<viewport-image-controls></viewport-image-controls>")(t),Q.enter(n,q)),"selectionDisplay"in a&&((t=N.$new(!1)).exitIsolation=function(){Tt(),Ye()},n=G("<viewport-selection-display></viewport-selection-display>")(t),Q.enter(n,q)),"analysisTools"in a&&((t=N.$new(!1)).linkToObjects=function(){var t=0,n=Me.list.length;Me.forEach(function(e){st(e),console.log("Link object "+ ++t+" / "+n)})},t.toggleDummyCreationMode=function(){return De=!De},n=G("<viewport-analysis-tools></viewport-analysis-tools>")(t),Q.enter(n,q))}),!1);function ke(){u&&(u.$destroy(),u=null),l&&(Q.leave(l),l=null,N.$applyAsync())}function Ve(){h&&(h.$destroy(),h=null),g&&(Q.leave(g),g=null)}function He(){E&&(E.$destroy(),E=null),v&&(Q.leave(v),v=null)}function Oe(){ne.dispose(),ne=null,Ue();var e=new THREE.Vector3(0,0,-100);e.applyQuaternion(oe.quaternion),e.add(oe.position),te.target.copy(e),_.$broadcast("searchUpdate"),p&&(p.$destroy(),p=null),d&&(Q.leave(d),d=null),q.find("viewport-selection-display, viewport-analysis-tools").show()}function Se(e,t,n){N.$broadcast("viewportLoadProgress",e,t,n)}function Ae(e){N.$broadcast("viewportCameraMove",e)}N.$on("triggerSpatializeManual",function(e,t){var n;"spatializeManual"in a&&(n=t,angular.element(q).find("viewport-spatialize-manual").length||(Xe(null),T.clean(),Me.forEach(function(e){Me.remove(e),e.dispose()}),(ne=new THREE.FlyControls(oe,x.domElement)).movementSpeed=100,ne.rollSpeed=.1,ne.moveFactor=1,ne.dragToLook=!0,Le(),(p=N.$new(!1)).source=n,p.camera=oe,p.controls=ne,p.close=Oe,p.onAfterSave=function(e){return jt(e).then(function(e){return e.object.updateMatrixWorld(!0),st(e)})},d=G("<viewport-spatialize-manual></viewport-spatialize-manual>")(p),Q.enter(d,q),q.find("viewport-selection-display, viewport-analysis-tools").hide()))});n(function(){x&&x.render(ee,oe),M.update()},100);function ze(){Tt(),We(),Ae(oe)}function Le(){de||(te.removeEventListener("change",ze),de=!0,$=new THREE.Clock,Ne())}function Ue(){de&&(te.addEventListener("change",ze),Ae(oe),de=!1,$.stop(),Ye())}function Pe(){de||Ne()}var Ye=n(Pe,50),We=o(Pe,20),Fe=o(Pe,500);function Ne(){if(de?(TWEEN.update(),ne||te.update(),TWEEN.getAll().length||z?requestAnimationFrame(Ne):ne?(ne.movementSpeed=Math.max(10,Math.abs(oe.position.y))*ne.moveFactor,ne.update($.getDelta()),requestAnimationFrame(Ne)):Ue()):(te&&te.update(),pe||xe||T.update(oe),pe||Me.forEach(function(e){e.updateTextureByDistance(oe.position,30)},!0)),r.grid){var e=f.defaults.gridSize/f.defaults.gridDivisions;r.grid.position.x=Math.round(oe.position.x/e)*e,r.grid.position.z=Math.round(oe.position.z/e)*e}if(z&&z.draw(),j){j.position.set(4,4,4);var t=(new THREE.Matrix4).makeRotationFromQuaternion(oe.quaternion);j.position.applyMatrix4(t)}qe()}function qe(){x&&x.render(ee,oe)}function _e(e){var t=new THREE.Vector3(e.x,e.y,P).unproject(oe).sub(oe.position).normalize();Y.set(oe.position,t)}function Be(e,t){var n=Y.intersectObjects(e,t||!1);return n.length?n[0]:null}function Ge(e){var t=Array.from(arguments),n=[];return-1!==t.indexOf("objects")&&$e.forEach(function(e){"object"===e.type&&n.push(e.object)},!0),-1!==t.indexOf("plans")&&je.forEach(function(e){n.push(e.object.mesh)},!0),-1!==t.indexOf("spatialImages")&&M.search(Y.ray.origin,0,!0,Y.ray.direction).forEach(function(e){n.push(e.object)}),n}function Qe(e,t){_e(e);var n=Be(Ge("objects","plans","spatialImages"),!0);if(n)if(c.debug(n),n.object.entry instanceof DV3D.ObjectEntry){for(var o=n.object.entry;o.parent;)o=o.parent;Xe(o,t)}else n.object.parent.entry instanceof DV3D.Entry?Xe(n.object.parent.entry,t):n.object.parent.cluster instanceof DV3D.ClusterObject?Xe(n.object.parent.cluster,t):c.warn("Raycast hit unknown object",n);else Xe(null,t)}function Xe(e,t,n){t=t||!1,n=n||!1;var o=!1;ce.length&&!t&&(ce.forEach(function(e){Ze(e),o=!0}),Rt(),ce=[]),e&&!n&&-1===ce.indexOf(e)?(Ke(e),ce.push(e),o=!0,e instanceof DV3D.PlanEntry&&Rt(e.object,"move")):e&&!n&&-1!==ce.indexOf(e)&&(Ze(e),ce.splice(ce.indexOf(e),1),o=!0,R&&R.object===e.object&&Rt()),o&&Je(),Ye()}var Je=n(function(){_.$broadcast("viewportSelectionChange",ce)},200);function Ke(e){e instanceof DV3D.Entry?(e instanceof DV3D.ObjectEntry?(!function(e){if("object"!==e.type)return;switch(f.shading){case"xray":e.object.material=Ce.get("xraySelectionMat")}e.edges&&("edgesMat"===e.edges.material.name?e.edges.material=Ce.get("edgesSelectionMat"):e.edges.material.color=Ce.get("edgesSelectionMat").color)}(e),e.children.forEach(function(e){Ke(e)})):e instanceof DV3D.PlanEntry?e.object.select():e instanceof DV3D.ImageEntry&&e.object.select(),e.select(null,!0)):e instanceof DV3D.ClusterObject&&(e.implode(),e.select(!0))}function Ze(e){e instanceof DV3D.Entry?(e instanceof DV3D.ObjectEntry?(!function(e){if("object"!==e.type)return;switch(f.shading){case"xray":e.object.material=Ce.get("xrayMat")}e.edges&&("edgesSelectionMat"===e.edges.material.name?e.edges.material=Ce.get("edgesMat"):e.edges.material.color=Ce.get("edgesMat").color)}(e),e.children.forEach(function(e){Ze(e)})):e instanceof DV3D.PlanEntry?e.object.deselect():e instanceof DV3D.ImageEntry&&e.object.deselect(),e.select(null,!1)):e instanceof DV3D.ClusterObject&&e.select(!1)}function et(e){var t=!1;W&&W!==e&&(!function t(e){e instanceof DV3D.Entry?e instanceof DV3D.ObjectEntry?(ot(e.object),e.children.forEach(function(e){t(e)})):e instanceof DV3D.ImageEntry&&e.highlight(!1):e instanceof DV3D.ClusterObject&&(e.implode(),e.highlight(!1))}(W),t=!(W=null)),e&&null===W&&(!function t(e){e instanceof DV3D.Entry?e instanceof DV3D.ObjectEntry?(nt(e.object),e.children.forEach(function(e){t(e)})):e instanceof DV3D.ImageEntry&&e.highlight(!0):e instanceof DV3D.ClusterObject&&e.highlight(!0)}(e),W=e,t=!0),t&&Ye()}function tt(e){if(-1===F.indexOf(e)){for(var t=0;t<W.length;t++)W[t]!==e&&-1===F.indexOf(W[t])&&(ot(W[t]),W.splice(t,1),--t);e&&-1===W.indexOf(e)&&("object"===e.userData.type&&nt(e),W.push(e))}}function nt(e){if("object"===e.entry.type){var n=new THREE.Color(DV3D.Defaults.highlightColor);switch(f.shading){case"grey":e.material=Ce.get("highlightMat");break;case"transparent":e.material=Ce.get("transparentHighlightMat");break;case"xray":e.material=Ce.get("xrayHighlightMat");break;default:Array.isArray(e.material)?e.material=e.material.map(function(e){var t=e.clone();return t.color.lerp(n,.3),t.name+="_highlight",Ce.assign(t),t}):(e.material=e.material.clone(),e.material.color.lerp(n,.3),e.material.name+="_highlight",Ce.assign(e.material))}}}function ot(e){if("object"===e.entry.type)switch(Ce.remove(e.material),f.shading){case"grey":e.material=Ce.get("defaultDoubleSideMat");break;case"transparent":e.material=Ce.get("transparentMat");break;case"xray":e.material=Ce.get("xrayMat");break;default:Array.isArray(e.userData.originalMat)?e.material=e.userData.originalMat.map(function(e){return Ce.get(e)}):e.material=Ce.get(e.userData.originalMat)}}function at(e,t){!0===t?e&&-1!==F.indexOf(e)&&(rt(e),F.splice(F.indexOf(e),1)):e&&-1===F.indexOf(e)&&(tt(),"object"===e.userData.type&&function(e){ot(e),e.material=e.material.clone();var t=new THREE.Color(16711680);e.material.color.lerp(t,.5),e.material.name+="_mark"}(e),F.push(e))}function it(){F.forEach(function(e){rt(e)}),F=[]}function rt(e){ot(e)}function st(e){var t=m.defer();e.object.updateMatrixWorld(!0);for(var n=Ge("objects"),o=0;o<20;o++)for(var a=0;a<20;a++){var i=o*e.object.width/21+e.object.width/20-e.object.width/2,r=a*e.object.height/21+e.object.height/20-e.object.height/2,s=new THREE.Vector3(i,r,0);s.applyMatrix4(e.object.image.matrixWorld);var c=s.sub(e.object.position).normalize();Y.set(e.object.position,c);var l=Be(n,!0);if(l){for(var u=l.object.entry;u.parent;)u=u.parent;u&&-1===ce.indexOf(u)&&(Ke(u),ce.push(u))}}return console.log(e),console.log(ce.map(function(e){if(e instanceof DV3D.ObjectEntry)return e.name})),e.source.$setLinksToObjects({objectIds:ce.map(function(e){if(e instanceof DV3D.ObjectEntry)return e.name})}).then(function(e){console.log(e),t.resolve()}).catch(function(e){B.throwApiException("#Image.setLinksToObjects",e),t.reject(e)}),Xe(null,!1,!0),Ye(),t.promise}function ct(t,e){if(t!==e){var n="onlyEdges"===t&&"onlyEdges"!==e,o="onlyEdges"===e&&"onlyEdges"!==t,a="xray"===t&&"xray"!==e,i=f.showEdges&&"xray"===e;$e.forEach(function(e){switch(e.visible&&(n&&(e.parent?e.parent.object.remove(e.object):ee.remove(e.object)),o&&(e.parent?e.parent.object.add(e.object):ee.add(e.object)),a&&e.edges&&ee.remove(e.edges),i&&e.edges&&ee.add(e.edges)),t){case"grey":e.object.material=Ce.get("defaultDoubleSideMat");break;case"transparent":e.object.material=Ce.get("transparentMat");break;case"xray":-1!==ce.indexOf(e)?e.object.material=Ce.get("xraySelectionMat"):e.object.material=Ce.get("xrayMat");break;default:Array.isArray(e.object.userData.originalMat)?e.object.material=e.object.userData.originalMat.map(function(e){return Ce.get(e)}):e.object.material=Ce.get(e.object.userData.originalMat)}}),Ne()}}function lt(e){N.$broadcast("viewportNavigationChange",e)}function ut(e){var t=new THREE.Vector2;return t.x=e.offsetX/y*2-1,t.y=-e.offsetY/w*2+1,t}function dt(e){var t=y*(e.x+1)/2,n=w*(1-e.y)/2;return new THREE.Vector2(t,n)}function pt(e){if(Re(),ke(),ge=e.button,fe=ut(e),me=e,!ne)if(De&&0===e.button){var t=new THREE.Plane(new THREE.Vector3(0,1,0),-3);_e(fe),ae=Y.ray.intersectPlane(t)}else if(be.default)if(0===e.button)if(e.shiftKey){var n=angular.element("<div/>",{id:"select-rectangle",class:"select-rectangle"});q.append(n),ye=!0}else oe.inPerspectiveMode;else 1===e.button&&(te.onMouseDown(e.originalEvent,2),Z.addClass("cursor_pan"),Ee=!0);else be.rotate?0===e.button&&(te.onMouseDown(e.originalEvent,0),he=!0):be.pan?0===e.button&&(te.onMouseDown(e.originalEvent,2),Ee=!0):be.zoom&&0===e.button&&(te.onMouseDown(e.originalEvent,1),ve=!0)}function ft(e){e.preventDefault();var t,n,o,a,i,r=ut(e);if(ke(),!ne)if(De&&ae){var s=new THREE.Plane(new THREE.Vector3(0,1,0),-3);_e(r);var c=Y.ray.intersectPlane(s),l=(new THREE.Vector3).subVectors(c,ae),u=l.length();ie=l.normalize(),re?(re.setDirection(l),re.setLength(u)):(re=new THREE.ArrowHelper(l,ae,u),ee.add(re)),Ne()}else if(-1!==ge)he||Ee||ve?te.onMouseMove(e.originalEvent):ye?q.find("#select-rectangle").css((n=r,o=dt(t=fe),a=dt(n),i={},n.x>t.x?(i.left=o.x,i.width=a.x-o.x):(i.left=a.x,i.width=o.x-a.x),n.y<t.y?(i.top=o.y,i.height=a.y-o.y):(i.top=a.y,i.height=o.y-a.y),i)):0!==ge||fe.equals(r)||(te.onMouseDown(me.originalEvent,0),Z.addClass("cursor_orbit"),he=!0);else{if(_e(r),xe)var d=Ge("objects");else d=Ge("objects","spatialImages");var p=Be(d,!0);if(p){var f=p.object.entry||p.object.parent.entry||p.object.parent.cluster;if(f instanceof DV3D.ObjectEntry)for(;f.parent;)f=f.parent;et(f),Ie(f,new THREE.Vector2(e.offsetX,e.offsetY))}else et(),Ie.cancel()}}function mt(e){if(-1!==ge){ge=-1;var t,n,o,a,i,r,s,c,l,u,d,p,f,m,g,h,v,E,b,y,w,x,D,$,j,M,T,C,R,I,k,V,H,O,S,A,z,L,U,P,Y=ut(e);if(!ne)if(De&&ae)re&&(ee.remove(re),re.line.geometry.dispose(),re.line.material.dispose(),re.cone.geometry.dispose(),re.cone.material.dispose()),z=ae,L=ie,U=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,-1),L),P=(new THREE.Matrix4).compose(z,U,new THREE.Vector3(1,1,1)),X.createDummy({matrix:P.toArray(),offset:[0,0],ck:1/Math.tan((45*Math.random()+20)/2*THREE.Math.DEG2RAD)*.5,width:Math.round(800*Math.random()+400),height:Math.round(800*Math.random()+400)}).$promise.then(function(e){console.log(e),jt(e).then(function(e){Ne(),st(e)}),_.$broadcast("imageUpdate",e)}).catch(function(e){B.throwApiException("Image.createDummy",e)}),ie=ae=re=null,Ne();else if(be.default&&2!==e.button)if(he)te.onMouseUp(e.originalEvent),Z.removeClass("cursor_orbit"),he=!1;else if(Ee)te.onMouseUp(e.originalEvent),Z.removeClass("cursor_pan"),Ee=!1;else if(ve)te.onMouseUp(e.originalEvent),Z.removeClass("cursor_zoom"),ve=!1;else if(ye){if(q.find("#select-rectangle").remove(),ye=!1,0!==e.button)return;var W,F;F=Y.x>fe.x&&Y.y<fe.y||Y.x<fe.x&&Y.y>fe.y?(W=fe,Y):(W=new THREE.Vector2(fe.x,Y.y),new THREE.Vector2(Y.x,fe.y)),o=W,a=F,i=e.ctrlKey,r=new THREE.Vector3(o.x,o.y,.5).unproject(oe),s=new THREE.Vector3(o.x,a.y,.5).unproject(oe),c=new THREE.Vector3(a.x,a.y,.5).unproject(oe),l=new THREE.Vector3(a.x,o.y,.5).unproject(oe),u=new THREE.Vector3(0,0,.5).unproject(oe),d=(new THREE.Vector3).subVectors(r,oe.position),p=(new THREE.Vector3).subVectors(s,oe.position),f=(new THREE.Vector3).subVectors(c,oe.position),m=(new THREE.Vector3).subVectors(l,oe.position),g=(new THREE.Vector3).subVectors(u,oe.position),h=new THREE.Vector3(0,0,.5).unproject(oe).add(g.clone().setLength(se)),v=(new THREE.Vector3).subVectors(h,oe.position),E=(new THREE.Vector3).crossVectors(p,d).normalize(),b=(new THREE.Vector3).crossVectors(f,p).normalize(),y=(new THREE.Vector3).crossVectors(m,f).normalize(),w=(new THREE.Vector3).crossVectors(d,m).normalize(),x=g.clone().normalize(),D=v.clone().negate().normalize(),$=-E.dot(r),j=-b.dot(s),M=-y.dot(c),T=-w.dot(l),C=-x.dot(u),R=-D.dot(h),I=new THREE.Plane(E,$),k=new THREE.Plane(b,j),V=new THREE.Plane(y,M),H=new THREE.Plane(w,T),O=new THREE.Plane(x,C),S=new THREE.Plane(D,R),A=new THREE.Frustum(I,k,V,H,O,S),i||Xe(null,!1,!0),$e.forEach(function(e){if("object"===e.type&&-1===ce.indexOf(e.object)&&A.intersectsObject(e.object)){console.log("first check");for(var t=e.object.geometry.attributes.position.array,n=e.object.matrixWorld,o=0,a=t.length;o<a;o+=3){var i=new THREE.Vector3(t[o],t[o+1],t[o+2]);if(i.applyMatrix4(n),A.containsPoint(i)){console.log("second check"),Xe(e,!0);break}}}},!0),Ne()}else Y.equals(fe)&&(Ie.cancel(),Qe(Y,e.ctrlKey),Ne());else be.rotate||be.pan||be.zoom?(2===e.button&&lt(),(he||Ee||ve)&&(te.onMouseUp(e.originalEvent),he=Ee=ve=!1)):2===e.button&&Y.equals(fe)&&(Qe(Y),ce[0]&&(Ie.cancel(),ke(),(ce[0]instanceof DV3D.ImageEntry||ce[0]instanceof DV3D.ObjectEntry)&&(t=ce[0],n=new THREE.Vector2(e.offsetX,e.offsetY),(K=N.$new(!1)).position=n,K.entry=t,K.close=Re,K.deleteDummy=xt,J=G("<viewport-context-menu no-context-menu></viewport-context-menu>")(K),Q.enter(J,q))))}}function gt(){ce[0]&&(ce[0]instanceof DV3D.ImageEntry?ce[0].focus():ce[0]instanceof DV3D.ObjectEntry?ce[0].focus():ce[0]instanceof DV3D.ClusterObject&&function(e){var t=new THREE.Geometry;e.getLeaves().forEach(function(e){t.vertices.push(e.position)}),t.computeBoundingSphere();var n=(new THREE.Vector3).subVectors(oe.position,te.target),o=t.boundingSphere.radius/Math.tan(oe.fov/2*THREE.Math.DEG2RAD),a=(new THREE.Vector3).addVectors(t.boundingSphere.center,n.setLength(o));new TWEEN.Tween(oe.position.clone()).to(a,500).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){oe.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(t.boundingSphere.center,500).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){te.target.copy(this)}).start(),Le()}(ce[0]))}function ht(e){ge=-1,Re(),ke(),et(),Ie.cancel(),ne?ne.mouseup(e.originalEvent):be.default?he?(te.onMouseUp(e.originalEvent),Z.removeClass("cursor_orbit"),he=!1):Ee?(te.onMouseUp(e.originalEvent),Z.removeClass("cursor_pan"),Ee=!1):ve?(te.onMouseUp(e.originalEvent),Z.removeClass("cursor_zoom"),ve=!1):ye&&(q.find("#select-rectangle").remove(),ye=!1):(be.rotate||be.pan||be.zoom)&&(he||Ee||ve)&&(te.onMouseUp(e.originalEvent),he=Ee=ve=!1)}function vt(e){e.preventDefault(),ke(),ne||te.onMouseWheel(e.originalEvent)}function Et(e){-1===["INPUT","TEXTAREA"].indexOf(e.target.tagName)&&(ne||te.onKeyDown(e.originalEvent))}function bt(e){if(-1===["INPUT","TEXTAREA"].indexOf(e.target.tagName)&&!ne&&D)switch(e.keyCode){case 81:D.setSpace("local"===D.space?"world":"local");break;case 87:D.setMode("translate");break;case 69:D.setMode("rotate");break;case 82:D.setMode("scale")}}N.$watch(function(){return f.shading},function(e,t){ct(e,t)}),N.$watch(function(){return f.camera},function(e,t){ct(e,t)}),N.$on("viewportNavigationChange",function(e,t){var n;e.stopPropagation&&e.stopPropagation(),n=t,V&&(ee.remove(V),V.dispose(),V=null),H&&(ee.remove(H),H.dispose(),we=!1,tt(H=null)),be.default=!1,be.rotate=!1,be.pan=!1,be.zoom=!1,n&&n in be?be[n]=!0:be.default=!0,Ne()});var yt=null;function wt(e){var t=new THREE.Vector3(e.cameraMatrix[12],e.cameraMatrix[13],e.cameraMatrix[14]),n=(new THREE.Vector3).fromArray(e.cameraCenter);new TWEEN.Tween(oe.position.clone()).to(t,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){oe.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(n,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){te.target.copy(this)}).start(),oe.fov===e.cameraFOV&&new TWEEN.Tween({fov:oe.fov}).to({fov:e.cameraFOV},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){oe.fov=this.fov,oe.updateProjectionMatrix()}).start(),Le()}function xt(t){Xe(null),_.$broadcast("imageUpdate",t.source,!0),t.source.$deleteDummy().then(function(e){console.log(e),ee.remove(t.object),M.remove(t.object.collisionObject),Me.remove(t),t.dispose(),console.log(t),Ye()}).catch(function(e){B.throwApiException("Image.$deleteDummy",e)})}function Dt(){O&&(O.update(oe,Me.get().map(function(e){return e.object}),function(e){N.$broadcast("viewportHeatMapComplete",e)}),Ye()),L&&(L.update(oe,T.getActiveClusters()),Ye()),U&&(U.update(oe,T.getActiveClusters()),Ye()),S&&(S.computeUVs(),(h=N.$new(!1)).close=Ve,g=G("<viewport-progress-bar></viewport-progress-bar>")(h),Q.enter(g,q),S.computeMap(function(e,i){_e(e);var t=Be([i]);if(!t)return 0;var r=t.point,s=t.face.normal.clone().applyQuaternion(i.quaternion),c=0;return Me.forEach(function(e){var t=e.object.position.clone().sub(r).normalize(),n=new THREE.Vector3(0,0,-1).applyQuaternion(e.object.quaternion);if(0<s.dot(t)&&t.dot(n)<e.object.fov/180-1){var o=r.distanceTo(e.object.position);Y.set(r.clone().add(s),t);var a=Be([i]);(!a||a.distance>o)&&c++}},!1),c},function(e,t){N.$broadcast("viewportProgressUpdate",e,t)},function(){Ye()})),A&&(A.update(oe,function(n){var e=M.search(n,ue),o=0,a=0,i=ue,r=new THREE.Vector3,s=[];return e.forEach(function(e){if(e.object.parent.cluster){var t=e.object.parent.cluster;n.clone().sub(t.position).length()<ue+t.distance&&(s=s.concat(t.getLeaves()))}else s.push(e.object.parent)}),s.forEach(function(e){var t=n.clone().sub(e.position).length();t<ue&&(r.add(new THREE.Vector3(0,0,-1).applyQuaternion(e.quaternion)),o++,a+=t,i=Math.min(i,t))}),{direction:r.normalize(),count:o,disWeight:1-i/ue,dirWeight:1-a/ue/o}},function(e){N.$broadcast("viewportHeatMapComplete",e)}),Ye()),z&&(z.update(oe,function(n){var e=M.search(n,ue),o=0,a=0,i=ue,r=new THREE.Vector3,s=[];return e.forEach(function(e){if(e.object.parent.cluster){var t=e.object.parent.cluster;n.clone().sub(t.position).length()<ue+t.distance&&(s=s.concat(t.getLeaves()))}else s.push(e.object.parent)}),s.forEach(function(e){var t=n.clone().sub(e.position).length();t<ue&&(r.add(new THREE.Vector3(0,0,-1).applyQuaternion(e.quaternion)),o++,a+=t,i=Math.min(i,t))}),{direction:r.normalize(),count:o,disWeight:1-i/ue,dirWeight:1-a/ue/o}},function(e){N.$broadcast("viewportHeatMapComplete",e)}),Le())}N.$on("snapshotViewScreen",function(e,t,n){if(!angular.element(q).find("viewport-snapshot-view").length){var o=N.$new(!1);o.screen=t,o.pins=n,yt=G("<viewport-snapshot-view></viewport-snapshot-view>")(o),Q.enter(yt,q),angular.element(q).find("viewport-navigation").attr("disabled",!0),wt(t)}}),N.$on("snapshotViewClose",function(){N.closeSnapshotView()}),N.closeSnapshotView=function(){yt&&Q.leave(yt),yt=null,angular.element(q).find("viewport-navigation").attr("disabled",!1)},N.$on("snapshotStart",function(){if(!angular.element(q).find("viewport-snapshot").length){var e=N.$new(!1);e.size={width:y,height:w},yt=G("<viewport-snapshot></viewport-snapshot>")(e),Q.enter(yt,q),angular.element(q).find("viewport-navigation").attr("disabled",!0),t(function(){var e;e={sData:x.domElement.toDataURL("image/jpeg"),cameraMatrix:oe.matrix.toArray(),cameraFOV:oe.fov,cameraCenter:te.target.toArray(),width:y,height:w},_.$broadcast("snapshotScreenshot",e)})}}),N.$on("snapshotEnd",function(){yt&&Q.leave(yt),yt=null,angular.element(q).find("viewport-navigation").attr("disabled",!1),it(),Ye()}),N.startPinning=function(){lt(),H=new DV3D.Pin(3,.5),ee.add(H),we=!0},N.abortPinning=function(){we=!1,lt()},N.mousemovePinLayer=function(e){if(we&&H){var t=ut(e),n=[];$e.forEach(function(e){"object"===e.type&&n.push(e.object)},!0),_e(t);var o=Be(n);o?(H.set(o),tt(o.object)):(H.set(),tt()),We()}},N.mouseleavePinLayer=function(){we&&H&&(H.set(),tt(),Ye())},N.mouseupPinLayer=function(e){if(e.preventDefault(),we&&H&&0===e.button&&W[0]){var t=W[0];-1===F.indexOf(t)&&(at(t),n=$e.get(t.id),o=H.matrixWorld.toArray(),_.$broadcast("snapshotPinSuccess",n,o),We())}var n,o},N.$on("snapshotPinRemove",function(e,t){at(t.object,!0),Ye()}),N.$on("snapshotViewStart",function(e,t){wt(t)}),N.$on("viewportHeatMapUpdate",function(e,t){if(t){if(t.typeChange&&(!O||"heatMap"===t.type&&t.visible||(ee.remove(O),O.dispose(),O=null),!S||"objectHeatMap"===t.type&&t.visible||(S.dispose(),S=null),!A||"vectorField"===t.type&&t.visible||(ee.remove(A),A.dispose(),A=null),!z||"windMap"===t.type&&t.visible||(ee.remove(z),z.dispose(),z=null,Ue()),!L||"radarChart"===t.type&&t.visible||(ee.remove(L),L.dispose(),L=null),!U||"radialFan"===t.type&&t.visible||(ee.remove(U),U.dispose(),U=null),t.visible)){switch(t.type){case"heatMap":(O=new DV3D.HeatMap3).setRadius(t.radius),ee.add(O);break;case"objectHeatMap":S=new DV3D.ObjectHeatMap($e.getByName("d1_HJrdAjjfG_Zwinger").object,oe);break;case"vectorField":A=new DV3D.VectorField,ee.add(A);break;case"windMap":(z=new DV3D.WindMap).configure({numParticles:2e4}),z._useWeight=t.useWeight,ee.add(z);break;case"radarChart":L=new DV3D.RadarChart,ee.add(L);break;case"radialFan":U=new DV3D.RadialFan,ee.add(U)}ue=t.radius,Dt()}t.overlayChange&&(O&&(O.material.depthTest=!t.overlay,O.material.depthWrite=!t.overlay),A&&A.setConfig({depthTest:!t.overlay,transparent:t.overlay}),z&&(z.material.depthTest=!t.overlay,z.material.depthWrite=!t.overlay)),t.radiusChange&&(ue=t.radius,O&&O.setRadius(t.radius),Dt()),t.settingsChange&&(U&&(U.setAngleOffset(t.radarChartAngle),t.radarChartResolution&&U.setAngleResolution(t.radarChartResolution)),z&&(z._useWeight=t.useWeight),Dt()),Ye()}});var $t=n(Dt,500);function jt(e){if(!e.spatial)return m.reject("No spatial information");var t=m.defer(),n=new DV3D.ImagePane("data/"+e.file.path+e.file.preview,{width:e.file.width,height:e.file.height,ck:e.spatial.ck,offset:e.spatial.offset,preview:"data/"+e.file.path+e.file.thumb});n.onComplete=function(){1!==f.images.opacity&&a.setOpacity(f.images.opacity),a.setScale(f.images.scale),Ye(),t.resolve(a)};var o=(new THREE.Matrix4).fromArray(e.spatial.matrix);n.applyMatrix(o),n.name=e.spatial.id,n.userData.source=e,n.userData.type="image";var a=new DV3D.ImageEntry(n,e.title);return a.addEventListener("change",Ye),a.addEventListener("toggle",Ct),a.addEventListener("select",Ot),a.addEventListener("focus",Ht),Me.add(a),t.promise}function Mt(e){var t;Tt(),t=e,T.hide(),M.update(),t.entry.toggle(!0),xe=!0,N.$broadcast("viewportIsolationEnter");var n=new THREE.Vector3(0,0,-100);n.applyQuaternion(e.quaternion),n.add(e.position);var o=Math.abs(e.image.position.z*e.scale.z);oe.near>.8*o&&(oe.near=.8*o,oe.updateProjectionMatrix()),new TWEEN.Tween(oe.position.clone()).to(e.position,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){oe.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(n,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){te.target.copy(this)}).start(),new TWEEN.Tween({fov:oe.fov}).to({fov:e.fov},500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){oe.fov=this.fov,oe.updateProjectionMatrix()}).start(),Le()}function Tt(){xe&&(xe=!1,N.$broadcast("viewportIsolationExit"))}function Ct(e){var t=e.target;if(e.visible){if(ee.getObjectById(t.object.id))return;ee.add(t.object)}else ee.remove(t.object),Xe(t,!1,!0);Ye()}function Rt(e,t,n){switch(R&&R.attachToObject(null),t){case"move":R=I;break;case"rotate":R=k;break;default:R=null}R&&R.attachToObject(e,n)}function It(e){return e.reduce(function(e,t){var n=t.file?t:t.object;return e.then(function(){return function(t){var n,e=m.defer();switch(t.obj.type){case"group":n=new THREE.Group;break;case"object":n=new THREE.Mesh(Te.get("initGeo"),Ce.get("defaultMat"));break;default:return e.reject("Unsupported type"),e.promise}var o=new THREE.Matrix4;if(o.fromArray(t.obj.matrix),"Z"===t.obj.up&&!t.parent){var a=new THREE.Matrix4;a.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),o.multiplyMatrices(a,o)}var i=new THREE.Vector3,r=new THREE.Quaternion,s=new THREE.Vector3;o.decompose(i,r,s);var c="number"==typeof t.obj.unit?t.obj.unit:1;t.parent||(i.multiplyScalar(c),s.multiplyScalar(c));o.compose(i,r,s),n.applyMatrix(o),n.matrixAutoUpdate=!1,n.name=t.obj.id,n.userData.id=t.obj.id,n.userData.name=t.obj.name,n.userData.type=t.obj.type,n.userData.layer=t.obj.layer;var l=null;t.parent&&(l=ee.getObjectByName(t.parent,!0));l?l.add(n):ee.add(n);n.userData.node=t.node||l.userData.node;var u=new DV3D.ObjectEntry(n);if(u.addEventListener("change",Ye),u.addEventListener("toggle",Vt),u.addEventListener("focus",Ht),u.addEventListener("select",Ot),$e.add(u),"object"===t.obj.type){var d=Array.isArray(t.file.mesh)?t.file.mesh.map(function(e){return t.file.path+e}):t.file.path+t.file.mesh;if(Te.loadCTMGeometry(d).then(function(e){n.geometry=e,"onlyEdges"===f.shading&&n.parent.remove(n),Fe()}).catch(function(e){console.error(e)}),Ce.setMaterial(t.materials).then(function(e){n.material=e,n.userData.originalMat=Array.isArray(e)?e.map(function(e){return e.name}):e.name}).catch(function(e){console.error(e),n.material=Ce.assign("defaultDoubleSideMat"),n.userData.originalMat=n.material.name}).then(function(){switch(f.shading){case"grey":n.material=Ce.get("defaultDoubleSideMat");break;case"transparent":n.material=Ce.get("transparentMat");break;case"xray":n.material=Ce.get("xrayMat")}Fe()}),t.file.edges){var p=Array.isArray(t.file.edges)?t.file.edges.map(function(e){return t.file.path+e}):t.file.path+t.file.edges;Te.loadEdgesGeometry(p).then(function(e){var t=new THREE.LineSegments(e,Ce.assign("edgesMat"));t.matrix=n.matrixWorld,t.matrixAutoUpdate=!1,u.addEdges(t),"xray"!==f.shading&&ee.add(t),Fe()}).catch(function(e){console.error(e)})}}return e.resolve(),e.promise}(n)}).then(function(){return It(n.children)})},m.resolve())}function kt(e){[].concat(e.children).forEach(function(e){kt(e)}),e.object.parent&&e.object.parent.remove(e.object),"object"===e.type&&(Te.remove(e.object.geometry),Array.isArray(e.object.userData.originalMat)?e.object.userData.originalMat.forEach(function(e){Ce.remove(Ce.get(e))}):Ce.remove(Ce.get(e.object.userData.originalMat)),e.edges&&(ee.remove(e.edges),Te.remove(e.edges.geometry),Ce.remove(e.edges.material))),$e.remove(e),e.dispose()}function Vt(e){var t=e.target,n=t.parent?t.parent.object:ee;if(e.visible&&t.parent&&!t.parent.visible&&(t.parent.visible=!0,Vt({target:t.parent,visible:!0})),e.visible){if(n.getObjectById(t.object.id))return;n.add(t.object),f.showEdges&&t.edges&&ee.add(t.edges)}else n.remove(t.object),f.showEdges&&t.edges&&ee.remove(t.edges),Xe(t,!1,!0);Ye()}function Ht(e){if(e.target.object){var t=e.target.object;t instanceof DV3D.ImagePane?Mt(t):t instanceof DV3D.Plan?function(e){var t=e.mesh.geometry,n=e.mesh.matrixWorld,o=(new THREE.Quaternion).setFromRotationMatrix(n),a=new THREE.Vector3(t.attributes.normal.array[0],t.attributes.normal.array[1],t.attributes.normal.array[2]).applyQuaternion(o),i=t.boundingBox.clone().applyMatrix4(n),r=y/w,s=Math.sqrt(Math.pow(i.max.x-i.min.x,2)+Math.pow(i.max.z-i.min.z,2))/2,c=(i.max.y-i.min.y)/2;(.707<a.y||a.y<-.707)&&(s=Math.sqrt(Math.pow(i.max.x-i.min.x,2)+Math.pow(i.max.y-i.min.y,2))/2,c=(i.max.z-i.min.z)/2),r<s/c&&(c=1/r*s);var l=c/Math.tan(oe.fov/2*Math.PI/180),u=t.boundingSphere.center.clone().applyMatrix4(n),d=new THREE.Vector3;d.addVectors(u,a.setLength(l)),new TWEEN.Tween(oe.position.clone()).to(d,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){oe.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(u,500).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){te.target.copy(this)}).onComplete(function(){oe.toOrthographic(te.target),N.$apply()}).start(),Le()}(t):St([e.target])}}function Ot(e){Xe(e.target,e.originalEvent.ctrlKey)}function St(e){if(!(e.length<1))if(1===e.length&&e[0]instanceof DV3D.ImageEntry)Mt(e[0].object);else{var o=[];!function e(t){for(var n=0;n<t.length;n++)e(t[n].children),"object"!==t[n].type&&"plan"!==t[n].type||o.push(t[n].object)}(e),zt(o)}}function At(){var t=[];$e.forEach(function(e){"object"===e.type&&t.push(e.object)},!0),t.length<1||zt(t)}function zt(e){var t=new THREE.Box3;e.forEach(function(e){t.expandByObject(e)});var n=t.getBoundingSphere(),o=(new THREE.Vector3).subVectors(oe.position,te.target),a=n.radius/Math.tan(oe.fov/2*THREE.Math.DEG2RAD),i=(new THREE.Vector3).addVectors(n.center,o.setLength(a));oe.near=n.radius/100,oe.far=Math.max(100*n.radius,f.defaults.FAR),oe.updateProjectionMatrix(),new TWEEN.Tween(oe.position.clone()).to(i,500).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){oe.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(n.center,500).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){te.target.copy(this)}).start(),Le()}function Lt(){var e=new THREE.Vector3(oe.position.x,te.target.y,oe.position.z).sub(te.target),t=e.length(),n=Math.atan2(e.x,e.z);new TWEEN.Tween({theta:n}).to({theta:0},1e3).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){e.x=t*Math.sin(this.theta),e.y=oe.position.y,e.z=t*Math.cos(this.theta),oe.position.copy(new THREE.Vector3(te.target.x,0,te.target.z)).add(e)}).start(),Le()}function Ut(){new TWEEN.Tween(oe.position.clone()).to(f.defaults.viewpoint.cameraPosition,1e3).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){oe.position.copy(this)}).start(),new TWEEN.Tween(te.target.clone()).to(f.defaults.viewpoint.controlsTarget,1e3).easing(TWEEN.Easing.Cubic.InOut).onUpdate(function(){te.target.copy(this)}).start(),35!==oe.fov&&new TWEEN.Tween({fov:oe.fov}).to({fov:35},1e3).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){oe.fov=this.fov,oe.updateProjectionMatrix()}).start(),Le()}function Pt(){y=q.width(),w=q.height(),c.debug("resize called",y,w),oe.aspect=y/w,oe.updateProjectionMatrix(),x.setSize(y,w),Ne()}N.$on("spatialImageLoadStart",function(e,t){if(Xe(null),!ne){pe=!0;var n,o=[],a=[],i=[];(n=Array.isArray(t)?t:[t]).forEach(function(e){if(e.spatial){var t=Me.getByName(e.spatial.id);t?a.push({entry:t,resource:e}):o.push(e)}}),Me.forEach(function(t){n.find(function(e){return!!e.spatial&&t.name===e.spatial.id})||i.push(t)}),T.clean(),i.forEach(function(e){Me.remove(e),e.dispose()}),a.forEach(function(e){e.entry.source=e.resource,e.entry.object.userData.source=e.resource});var r=[];o.forEach(function(e){r.push(jt(e))}),m.all(r).then(function(){_.$broadcast("spatialImageLoadSuccess"),T.bulkInsert(Me.get().map(function(e){return e.object})),pe=!1,Ye()}).catch(function(e){B.throwException("Spatial Image Loading Error","An error occurred while loading spatial image",e)}),Dt()}}),N.$on("mapLoad",function(e,t){C&&(ee.remove(C),C.dispose(),C=null),t?(C=new DV3D.TiledMap("data/plans/"+t)).promise.then(function(){ee.add(C),Ye()}):Ye()}),N.$on("modelUploadSuccess",function(e,n){It([n]).then(function(){console.log("uploaded objects loaded",n),t(function(){var e,t=$e.getByName(n.object.id);console.log(t),t.focus(),t.object.matrixAutoUpdate=!0,D.attach(t.object),t.object.userData.position0=t.object.position.clone(),t.object.userData.quaternion0=t.object.quaternion.clone(),t.object.userData.scale0=t.object.scale.clone(),le=t.object,console.log(D),e=t,(E=N.$new(!1)).entry=e,E.reset=function(e){"position"!==e&&"quaternion"!==e&&"scale"!==e||(le[e].copy(le.userData[e+"0"]),Ye())},E.close=function(){D.detach(),le.matrixAutoUpdate=!1,le=null,He(),Ye()},E.abort=function(){D.detach(),kt(le.entry),le=null,He(),Ye()},v=G("<viewport-upload-ctrls></viewport-upload-ctrls>")(E),Q.enter(v,q),console.log(Ce)},1e3,!1),Ye()}).catch(function(e){B.throwException("Loading Error","An error occurred while loading objects. See concole for details.",e)})}),N.$on("modelQuerySuccess",function(e,t){Xe();var n,o=[],a=[],i=[];(n=Array.isArray(t)?t:[t]).forEach(function(e){var t=$e.getByName(e.object.id);t?a.push({entry:t,resource:e}):o.push(e)}),$e.forEach(function(t){t.parent||n.find(function(e){return t.name===e.object.id})||i.push(t)}),i.forEach(function(e){kt(e)}),a.forEach(function(t){t.entry.label=t.resource.name,t.entry.traverse(function(e){e.node=t.resource.object.node,e.object.userData.node=t.resource.object.node})}),It(o).then(function(){c.debug("objects loaded"),Ye()}).catch(function(e){B.throwException("Loading Error","An error occurred while loading objects. See concole for details.",e)})}),N.$on("viewportFocusStart",function(e,t){if(!oe.inOrthographicMode)switch(t){case"selected":St(ce);break;default:At()}}),N.$on("$destroy",function(){Xe(null,!1,!0),Me.dehighlight(),it(),Tt(),T.clean(),N.spatialize&&(angular.forEach(s.markers3D,function(e){ee.remove(e.object),e.object.dispose()}),s.markers3D.splice(0,s.markers3D.length),qe(),N.$applyAsync()),C&&(ee.remove(C),C.dispose()),O&&(ee.remove(O),O.dispose()),S&&S.dispose(),A&&(ee.remove(A),A.dispose()),z&&(ee.remove(z),z.dispose()),L&&(ee.remove(L),L.dispose()),U&&(ee.remove(U),U.dispose()),delete s.callFunc[b],r.viewpoint||(r.viewpoint={cameraPosition:new THREE.Vector3,controlsTarget:new THREE.Vector3}),r.viewpoint.cameraPosition.copy(oe.position),r.viewpoint.controlsTarget.copy(te.target),te.dispose(),D.dispose(),ne&&ne.dispose(),x.forceContextLoss(),x.dispose();var e=angular.element(i);e.off("keydown",Et),e.off("keyup",bt),e.off("resize",Pt),$e.forEach(function(e){e.removeEventListener("change",Ye),e.removeEventListener("toggle",Vt),e.removeEventListener("focus",Ht),e.removeEventListener("select",Ot)}),Me.forEach(function(e){e.removeEventListener("change",Ye),e.removeEventListener("toggle",Ct),e.removeEventListener("focus",Ht),e.removeEventListener("select",Ot)}),c.debug("destroy viewport directive")})}]}),angular.module("dokuvis.viewport").factory("viewportSettings",[function(){var e=[{value:"color",label:"Color"},{value:"grey",label:"Grey"},{value:"transparent",label:"Transparent"},{value:"onlyEdges",label:"Only edges"},{value:"xray",label:"X-Ray"}],t=[{value:"perspective",label:"Perspective"},{value:"top",label:"Top"},{value:"front",label:"Front"},{value:"back",label:"Back"},{value:"left",label:"Left"},{value:"right",label:"Right"},{value:"custom",label:"Custom"}];return{defaults:{NEAR:1,FAR:6e3,initWidth:800,initHeight:600,backgroundColor:6710886,selectionColor:16535082,highlightColor:16777028,objectColor:14540253,edgeColor:3407667,gridSize:3e3,gridDivisions:100,viewpoint:{cameraPosition:new THREE.Vector3(603,630,692),controlsTarget:new THREE.Vector3(603,52,-462)}},shadings:e,cameras:t,shading:e[0].value,camera:t[0].value,showEdges:!0,images:{opacity:1,scale:3,clusterDistance:10}}}]).factory("viewportCache",["viewportSettings",function(e){var t=new THREE.Scene;t.fog=new THREE.Fog(e.defaults.backgroundColor,e.defaults.FAR-100,e.defaults.FAR);var n=new THREE.GridHelper(e.defaults.gridSize,e.defaults.gridDivisions,2834e3,2834e3);n.position.set(1e3,-.1,-1e3),n.material.dispose(),n.material=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)},opacity:{value:.7},fogNear:{value:1},fogFar:{value:e.defaults.gridSize/2}},vertexShader:"#include <common>\n#include <color_pars_vertex>\n\nvarying float fogDepth;\n\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n\n\t#include <color_vertex>\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\n\t#include <worldpos_vertex>\n\n\tfogDepth = -mvPosition.z;\n\n}",fragmentShader:"uniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <color_pars_fragment>\n\nvarying float fogDepth;\nuniform float fogNear;\nuniform float fogFar;\n\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\n\tgl_FragColor = diffuseColor;\n\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\tgl_FragColor.a *= 1.0 - fogFactor;\n\n}",vertexColors:THREE.VertexColors,transparent:!0}),n.renderOrder=-90,t.add(n),t.add(new THREE.AmbientLight(8947848));var o=new THREE.DirectionalLight(16777215,.7);o.position.set(-2,8,4),t.add(o);var a=new THREE.SphereBufferGeometry(4e3,32,15),i=new THREE.ShaderMaterial({uniforms:{topColor:{value:(new THREE.Color).setHSL(.6,1,.6)},horizonColor:{value:new THREE.Color(16777215)},bottomColor:{value:new THREE.Color(6710886)},offset:{value:33},topExponent:{value:.6},bottomExponent:{value:.3}},vertexShader:"varying vec3 vWorldPosition;\n\nvoid main() {\n\n\tvec4 worldPosition = modelMatrix * vec4(position, 1.0);\n\tvWorldPosition = worldPosition.xyz;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\n}",fragmentShader:"uniform vec3 topColor;\nuniform vec3 horizonColor;\nuniform vec3 bottomColor;\nuniform float offset;\nuniform float topExponent;\nuniform float bottomExponent;\nvarying vec3 vWorldPosition;\n\nvoid main() {\n\n\tfloat h = normalize(vWorldPosition + offset).y;\n\tif (h > 0.0)\n\t\tgl_FragColor = vec4( mix( horizonColor, topColor, max( pow( h, topExponent ), 0.0 ) ), 1.0);\n\telse\n\t\tgl_FragColor = vec4( mix( horizonColor, bottomColor, max( pow( abs(h), bottomExponent ), 0.0 ) ), 1.0);\n\n}",side:THREE.BackSide}),r=new THREE.Mesh(a,i);r.renderOrder=-100,t.add(r);var s=new THREE.FontLoader,c={};s.load("fonts/helvetiker_bold.typeface.json",function(e){c.HelvetikerBold=e});var l=new THREE.LoadingManager;return THREE.DokuVisTray={scene:t,grid:n,directionalLight:o,geometries:new DV3D.GeometryManager(l,{pathPrefix:"data/"}),materials:new DV3D.MaterialManager(l,{pathPrefix:"data/"}),loadingManager:l,fonts:c,objects:new DV3D.ObjectCollection,plans:new DV3D.Collection,spatialImages:new DV3D.Collection},THREE.DokuVisTray}]),angular.module("dokuvis.viewport").component("viewportNavigation",{templateUrl:"components/dokuvis.viewport/viewportNavigation.tpl.839b1271.html",controller:["$scope","viewportSettings",function(o,e){var a=this;a.$onInit=function(){a.navigation={default:!0,rotate:!1,pan:!1,zoom:!1},a.vpSettings=e},a.flyHome=function(){o.$parent.flyHome()},a.focus=function(e){o.$parent.focus(e)},a.setNavigationMode=function(e){o.$emit("viewportNavigationChange",e)},o.$on("viewportNavigationChange",function(e,t){var n;n=t,a.navigation.default=!1,a.navigation.rotate=!1,a.navigation.pan=!1,a.navigation.zoom=!1,n&&n in a.navigation?a.navigation[n]=!0:a.navigation.default=!0,o.$applyAsync()})}]}).directive("viewportAxis",["$timeout",function(t){return{restrict:"E",scope:!0,link:function(e,n){var o,a,i,r;function s(){o.render(i,a)}t(function(){var e,t;e=n.width(),t=n.height(),(o=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(e,t),n.append(o.domElement),(a=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,100)).position.set(0,0,50),r=new THREE.AxisHelper(50),(i=new THREE.Scene).add(r),s()}),e.$on("viewportCameraMove",function(e,t){a.rotation.copy(t.rotation),a.position.copy(t.getWorldDirection().negate().setLength(50)),s()}),e.$on("$destroy",function(){r.geometry.dispose(),r.material.dispose(),o.forceContextLoss(),o.dispose()})}}}]).component("viewportCompass",{template:'<div class="north" title="Orient north" ng-click="$ctrl.faceNorth()">N</div>',controller:["$scope","$element","$timeout",function(e,n,t){var o,a,i,r,s;function c(){o.render(i,a)}t(function(){var e,t;e=n.width(),t=n.height(),s=e,(o=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setSize(e,t),n.append(o.domElement),(a=new THREE.OrthographicCamera(-e/2,e/2,t/2,-t/2,1,100)).position.set(0,0,s),i=new THREE.Scene,(new THREE.TextureLoader).load("img/compass_v01.52931ae1.png",function(e){e.anisotropy=8;var t=new THREE.PlaneBufferGeometry(s-1,s-1);t.rotateX(-Math.PI/2);var n=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});r=new THREE.Mesh(t,n),i.add(r),c()})}),this.faceNorth=function(){e.$parent.faceNorth()},e.$on("viewportCameraMove",function(e,t){a.rotation.copy(t.rotation),a.position.copy(t.getWorldDirection().negate().setLength(s)),c()}),e.$on("$destroy",function(){r.geometry.dispose(),r.material.dispose(),o.forceContextLoss(),o.dispose()})}]}).component("viewportLoadProgress",{template:'<div class="border border-light"><div class="progress"><div class="progress-bar" ng-style="{width: $ctrl.progress+\'%\'}"><b>{{$ctrl.progress}} %</b></div></div></div><p>{{ $ctrl.item }} &ndash; {{ $ctrl.loaded }} / {{ $ctrl.total }}</p>',controller:["$scope","$element",function(a,i){var r=this,s=!1;this.$onInit=function(){i.hide(),this.item="",this.loaded=0,this.total=0,this.progress=0},a.$on("viewportLoadProgress",function(e,t,n,o){s||(i.show(),s=!0),r.item=t,r.loaded=n,r.total=o,r.progress=Math.round(n/o*100),100===r.progress&&(i.hide(),s=!1),a.$applyAsync()})}]}).component("viewportSpatializeManual",{templateUrl:"/components/dokuvis.viewport/viewportSpatializeManual.tpl.ff2b27df.html",controller:["$scope","$rootScope","Utilities",function(t,e,n){var o,a,i,r=this;r.$onInit=function(){o=r.source=t.$parent.source,a=r.camera=t.$parent.camera,i=t.$parent.controls,r.opacity=50,r.moveFactor=i.moveFactor||1},r.changeFOV=function(){a.updateProjectionMatrix()},r.changeFactor=function(){i.rollSpeed=.1*r.moveFactor,i.moveFactor=r.moveFactor},r.save=function(){o&&a&&(o.spatialize={matrix:a.matrixWorld.toArray(),offset:[0,0],ck:1/Math.tan(a.fov/2*THREE.Math.DEG2RAD)*.5},o.$spatialize({method:"manual"}).then(function(e){return t.$parent.onAfterSave(e)}).then(function(){console.log("linkToObjects done"),r.close()}).catch(function(e){n.throwApiException("#Source.spatialize",e)}))},r.close=function(){t.$parent.close()}}]}).directive("viewportSnapshot",["$rootScope",function(o){return{templateUrl:"components/dokuvis.viewport/viewportSnapshot.e66a2239.html",restrict:"E",scope:!0,link:function(t,n){t.mode="paint",t.paintOptions={opacity:1,color:"rgba(255,255,0,1.0)",backgroundColor:"rgba(255,255,255,0.0)",lineWidth:3,undo:!0,imageSrc:!1,width:t.size.width,height:t.size.height},t.setMode=function(e){"pin"===(t.mode=e)?t.startPinning():t.abortPinning()},t.$on("snapshotPrepareSave",function(){var e;e=n.find("#pwCanvasMain")[0].toDataURL("image/png"),o.$broadcast("snapshotPainting",e)}),n.on("$destroy",function(){t.$destroy()})}}}]).directive("viewportSnapshotView",function(){return{templateUrl:"components/dokuvis.viewport/viewportSnapshotView.tpl.5da3350b.html",restrict:"E",scope:!0,link:function(e,t){e.screenOpacity=0,e.paintOpacity=1,t.on("$destroy",function(){e.$destroy()})}}}).component("viewportImageControls",{templateUrl:"components/dokuvis.viewport/viewportImageCtrls.tpl.5df56100.html",controller:["$scope","viewportCache","viewportSettings",function(e,t,n){var o=this;o.$onInit=function(){o.opacity=100*n.images.opacity,o.scale=n.images.scale,o.clusterDistance=n.images.clusterDistance},o.setOpacity=function(){t.spatialImages.setOpacity(o.opacity/100),n.images.opacity=o.opacity/100},o.setScale=function(){t.spatialImages.forEach(function(e){e.setScale(o.scale)}),n.images.scale=o.scale},o.setClusterDistanceMultiplier=function(){e.$parent.setClusterDistanceMultiplier(o.clusterDistance)}}]}).component("viewportSelectionDisplay",{templateUrl:"components/dokuvis.viewport/viewportSelectionDisplay.tpl.af84cc8a.html",controller:["$scope","$rootScope","$state","DigitalObject",function(e,t,n,o){var a=this;this.$onInit=function(){this.imageList=[],this.objectList=[],this.inIsolationMode=!1,this.includesList=[],this.excludesList=[],n.params.filterObjIncl.forEach(function(e){o.get({id:e}).$promise.then(function(e){console.log(e),a.includesList.push({id:e.id,name:e.obj.name,label:e.obj.name})})}),n.params.filterObjExcl.forEach(function(e){o.get({id:e}).$promise.then(function(e){a.excludesList.push({id:e.id,name:e.obj.name,label:e.obj.name})})})},e.$on("viewportSelectionChange",function(e,t){a.imageList=t.filter(function(e){return e instanceof DV3D.ImageEntry}),a.objectList=t.filter(function(e){return e instanceof DV3D.ObjectEntry})}),this.exitIsolation=function(){e.$parent.exitIsolation()},e.$on("viewportIsolationEnter",function(){a.inIsolationMode=!0}),e.$on("viewportIsolationExit",function(){a.inIsolationMode=!1}),this.removeFilterObject=function(e){t.$broadcast("filterByObject",e,"remove")},e.$on("filterByObject",function(e,t,n){switch(n){case"include":a.includesList.push(t);break;case"exclude":a.excludesList.push(t);break;default:var o=a.includesList.findIndex(function(e){return e.name===t.name});-1!==o&&a.includesList.splice(o,1),-1!==(o=a.excludesList.findIndex(function(e){return e.name===t.name}))&&a.excludesList.splice(o,1)}})}]}).component("viewportContextMenu",{templateUrl:"components/dokuvis.viewport/viewportContextMenu.tpl.bc98fa7a.html",controller:["$scope","$element","$rootScope","$state","$timeout","ImageCollection",function(t,n,o,e,a,i){var r=this;this.$onInit=function(){this.entry=t.$parent.entry,this.position={x:-999,y:-999},a(function(){var e=n.find(".context-menu-dialog");r.position.x=Math.min(t.$parent.position.x,n.width()-e.width()),r.position.y=Math.min(t.$parent.position.y,n.height()-e.height())}),this.isImage=this.entry instanceof DV3D.ImageEntry,this.isObject=this.entry instanceof DV3D.ObjectEntry,this.isDummyImage=/_dummy$/.test(this.entry.name),this.isObject&&(-1!==e.params.filterObjIncl.indexOf(this.entry.name)&&(this.isIncluded=!0),-1!==e.params.filterObjExcl.indexOf(this.entry.name)&&(this.isExcluded=!0))},this.openImageDetails=function(){e.go(".image",{imageId:this.entry.source.id}),t.$parent.close()},this.openObjectDetails=function(){e.go(".object",{objectId:this.entry.node.id}),t.$parent.close()},this.addToCollection=function(){i.add(this.entry.source),t.$parent.close()},this.removeFromCollection=function(){i.remove(this.entry.source),t.$parent.close()},this.focus=function(){this.entry.focus(),t.$parent.close()},this.filterByObject=function(e){o.$broadcast("filterByObject",this.entry,e),t.$parent.close()},this.deleteDummyImage=function(){t.$parent.deleteDummy(this.entry),t.$parent.close()}}]}).component("viewportTooltip",{templateUrl:"components/dokuvis.viewport/viewportTooltip.tpl.eb3eee44.html",controller:["$scope","$element","$timeout",function(i,r,e){var s=this;this.$onInit=function(){this.entry=i.$parent.entry,this.position={x:-999,y:-999},this.isImage=this.entry instanceof DV3D.ImageEntry,this.isObject=this.entry instanceof DV3D.ObjectEntry,this.tooltipCss={};var a=r.find(".tooltip-dialog");a.find("img.tooltip-image").on("load",function(){s.tooltipCss.image={left:Math.min(0,r.width()-i.$parent.position.x-a.width()),top:Math.min(0,r.height()-i.$parent.position.y-a.height())},i.$applyAsync()}),e(function(){var e=a.find("[ng-bind]"),t=e.position(),n=0<i.$parent.position.y+t.top,o=r.width()-i.$parent.position.x-e.outerWidth();s.tooltipCss.label={transform:"translate("+Math.min(o,Math.max(-10,-i.$parent.position.x))+"px,"+(n?"-100%":"0")+")",top:n?"-20px":"20px"},s.tooltipCss.line={top:n?"-20px":"0"},s.position=i.$parent.position})}}]}).component("viewportAnalysisTools",{templateUrl:"components/dokuvis.viewport/viewportAnalysisTools.tpl.e49d4474.html",controller:["$scope","$element","$timeout","$debounce",function(t,e,n,o){var a=this;function i(e){t.$emit("viewportHeatMapUpdate",angular.extend(e,{type:a.analysis.type,visible:a.analysis.visible,overlay:a.analysis.overlay,radius:a.analysis.radius,useWeight:a.analysis.disWeight?"disWeight":"countWeight",radarChartAngle:a.analysis.radarChartAngle}))}this.$onInit=function(){a.analysis={type:"heatMap",visible:!1,overlay:!1,radius:40,disWeight:!1,radarChartAngle:0,toggle:function(){i({typeChange:!(a.legend=null),overlayChange:!0})},toggleOverlay:function(){i({overlayChange:!0})},changeType:function(){i({typeChange:!(a.legend=null),overlayChange:!0})},changeRadius:o(function(){i({radiusChange:!0})},1e3),changeSetting:function(){i({settingsChange:!0})}}},this.incrementRadarChartAngle=function(e){a.analysis.radarChartAngle+=e*Math.PI/180,i({settingsChange:!0})},this.setRadarChartResolution=function(e){i({settingsChange:!0,radarChartResolution:e})},this.linkToObjects=function(){t.$parent.linkToObjects()},this.toggleDummyCreationMode=function(){a.dummyCreationMode=t.$parent.toggleDummyCreationMode()},t.$on("viewportHeatMapComplete",function(e,t){a.legend={gradient:t.gradient,domain:[t.scale.min,t.scale.max]}})}]}).component("viewportProgressBar",{template:'<div class="border border-light"><div class="progress"><div class="progress-bar" ng-style="{width: $ctrl.percent+\'%\'}"><b>{{$ctrl.percent}} %</b></div></div></div>',controller:["$scope","$timeout",function(o,a){var i=this;i.$onInit=function(){i.percent=0},o.$on("viewportProgressUpdate",function(e,t,n){i.percent=Math.min(Math.round(t/n*100),100),o.$applyAsync(),100===i.percent&&a(o.$parent.close,100)})}]}).component("viewportUploadCtrls",{templateUrl:"components/dokuvis.viewport/viewportUploadCtrls.tpl.3ad09657.html",controller:["$scope","DigitalObject","Utilities",function(n,o,a){var i;this.$onInit=function(){i=n.$parent.entry,console.log(i)},this.reset=function(e){n.$parent.reset(e)},this.save=function(){var t=i.node;delete t.object.node,t.object.obj.matrix=i.object.matrixWorld.toArray(),o.save(t).$promise.then(function(e){console.log(e),t.object.node=i.node,n.$parent.close()}).catch(function(e){a.throwApiException("DigitalObject.save",e)})},this.abort=function(){var e=i.node;delete e.object.node,o.deleteTemp(e).$promise.then(function(){n.$parent.abort()}).catch(function(e){a.throwApiException("DigitalObject.deleteTemp",e)})}}]}),angular.module("dokuvis.viewport").directive("viewportObjectTree",["viewportCache",function(e){return{templateUrl:"components/dokuvis.viewport/viewportObjectTree.tpl.42bf6dea.html",restrict:"E",link:function(t){t.objects=e.objects,t.layers=e.objects.layers,t.hierarchy=e.objects.hierarchy,t.showLayers=!1,t.showHierarchy=!0,t.switchTo=function(e){switch(e){case"layers":t.showLayers=!0,t.showHierarchy=!1;break;default:t.showLayers=!1,t.showHierarchy=!0}}}}}]).directive("viewportPlanList",["viewportCache",function(t){return{templateUrl:"components/dokuvis.viewport/viewportPlanList.tpl.7c5d4820.html",restrict:"E",link:function(e){e.plans=t.plans}}}]).directive("viewportImageList",["viewportCache",function(t){return{templateUrl:"components/dokuvis.viewport/viewportImageList.tpl.a009c803.html",restrict:"E",link:function(e){e.images=t.spatialImages}}}]),angular.module("dokuvis.imageViewer",[]).directive("imageViewer",["$document","$window","$timeout","SpatializeInterface","$debounce","$log",function(P,Y,W,F,N,q){return{restrict:"E",template:'<div class="ctrl-container ctrl-bottom-left" ng-if="grid">\n\t<div>\n\t\t<div class="ctrl-group">\n\t\t\t<input type="checkbox" ng-model="grid.visible" ng-change="grid.onVisibilityChange()"/> Show grid\n\t\t</div>\n\t\t<div class="ctrl-group" ng-show="grid.visible">\n\t\t\t<div class="ctrl-slider">\n\t\t\t<span>Size</span>\n\t\t\t<input class="dvSlider" type="range" min="0" max="100" step="1" ng-model="grid.size" ng-change="grid.onSizeChange()"/>\n\t\t</div>\n\t</div>\n\t</div>\n</div>',scope:{source:"=src",options:"=options"},link:function(n,o,e){angular.element(o).css("overflow","hidden");var a,i,r,s,c,l,u,d,p,f,m,g,h,t,v=!1,E=!1,b=!1,y=!1,w=!1,x=.0015,D=.1,$=-.05,j=-1,M=new THREE.TextureLoader;function T(){n.$applyAsync()}P.on("mouseup",V),angular.element(Y).on("resize",T);var C=N(function(){L()},200,!1,!1);function R(e){-1!==["jpg","png"].indexOf(e.split(".").pop())&&(E=!0,console.log("source:",e),v&&(b||(u.add(m),b=!0),M.load(e,function(e){r=n.options&&n.options.width&&n.options.height?n.options.width/n.options.height:e.image.width/e.image.height,n.spatialize&&(F.imageWidth=n.options.width||e.image.width,F.imageHeight=n.options.height||e.image.height),m.geometry.dispose(),m.geometry=new THREE.PlaneBufferGeometry(r,1,1,1),m.material.map&&m.material.map.dispose(),m.material.map=e,m.material.needsUpdate=!0,A()},null,function(){console.error("ImageViewer: Couldn't load texture!")})))}function I(){d.render(u,p)}function k(e){e.preventDefault(),(0===e.button&&!w||1===e.button)&&(y=!0)}function V(e){if(!y||0!==e.button&&1!==e.button){if(0===e.button&&w){var t=h;g.setNumber(F.markers2D.length+1),F.markers2D.push({object:g,u:t.x,v:t.y,x:(t.x-.5)*r,y:t.y-.5}),w=!1,g=null,I(),n.$applyAsync()}}else y=!1}function H(e){if(e.preventDefault(),y)m.translateX(e.originalEvent.movementX*x*-m.position.z),m.translateY(e.originalEvent.movementY*x*m.position.z),S(),I();else if(w){var t=new THREE.Vector2;t.x=e.offsetX/a*2-1,t.y=-e.offsetY/i*2+1,function(e){var t=new THREE.Vector3(e.x,e.y,.5).unproject(p),n=new THREE.Raycaster(p.position,t.sub(p.position).normalize()).intersectObject(m);if(n[0]){var o=n[0].uv;h=o,g.position.set(o.x*r-r/2,o.y-.5,0)}}(t),I()}}function O(e){if(e.originalEvent.deltaY<0){var t=-D*m.position.z;if(m.position.z+t>$)return;m.translateZ(t),S(),I()}else 0<e.originalEvent.deltaY&&(t=D*m.position.z,m.position.z+t<=j&&(t=j-m.position.z),m.translateZ(t),S(),I())}function S(){var e=Math.abs(m.position.z)*Math.tan(c),t=Math.abs(m.position.z)*Math.tan(l),n=2*e,o=2*t,a=Math.abs(m.position.x-r/2)+Math.abs(m.position.x+r/2),i=Math.abs(m.position.y-.5)+Math.abs(m.position.y+.5);r<s&&a<n?(e<m.position.x+r/2&&m.translateX(e-(m.position.x+r/2)),-e>m.position.x-r/2&&m.translateX(-e-(m.position.x-r/2))):(e>m.position.x+r/2&&m.translateX(e-(m.position.x+r/2)),-e<m.position.x-r/2&&m.translateX(-e-(m.position.x-r/2))),s<r&&i<o?(t<m.position.y+.5&&m.translateY(t-(m.position.y+.5)),-t>m.position.y-.5&&m.translateY(-t-(m.position.y-.5))):(t>m.position.y+.5&&m.translateY(t-(m.position.y+.5)),-t<m.position.y-.5&&m.translateY(-t-(m.position.y-.5)))}function A(){if(r<s)m.position.set(0,0,-1),j=-1;else{var e=r/2/Math.tan(c);m.position.set(0,0,-e),j=-e}I()}function z(){angular.forEach(F.markers2D,function(e){m.remove(e.object),e.object.dispose()}),F.markers2D.splice(0,F.markers2D.length),I(),n.$applyAsync()}function L(e,t){a=e||o.width(),i=t||o.height(),s=a/i,c=Math.atan(.5*s),l=Math.atan(.5);var n=m&&m.position.z===j;j=r&&s<r?-r/2/Math.tan(c):-1,p&&(p.aspect=s,p.updateProjectionMatrix()),d&&(d.setSize(a,i),m&&n?A():I())}function U(e){var t=Math.log(.1),n=(Math.log(2)-t)/100;return Math.exp(t+n*(e-0))}n.$watch(function(){C()}),n.$watch("source",R),W(function(){L(),function(){u=new THREE.Scene,(d=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).setClearColor(16777215,0),d.setSize(a,i),o.append(d.domElement),(p=new THREE.PerspectiveCamera(2*l*180/Math.PI,s,.01,500)).lookAt(new THREE.Vector3(0,0,-1));var e=new THREE.PlaneBufferGeometry(1,1,1,1),t=new THREE.MeshBasicMaterial;(m=new THREE.Mesh(e,t)).position.set(0,0,-1),(f=angular.element(d.domElement)).on("mousedown",k),f.on("mousemove",H),f.on("wheel",O),f.on("contextmenu",function(e){e.preventDefault()}),v=!0,I()}(),E&&R(n.source)}),"spatialize"in e&&(n.spatialize={markers:F.markers2D}),n.spatialize&&(n.startMarking=function(){(g=new DV3D.TorusMarker(.008)).addEventListener("change",I),m.add(g),w=!0},n.clearMarkers=z),"grid"in e&&(n.grid={visible:!1,size:50,onSizeChange:function(){var e=U(this.size);t.scale.set(e,e,e),I()},onVisibilityChange:function(){if(!this.visible||t&&m.getObjectById(t.id))m.remove(t);else{if(!t){(t=new THREE.GridHelper(20,200,65280,16776960)).material.transparent=!0,t.material.opacity=.5,t.rotateX(Math.PI/2),t.position.set(0,0,.01);var e=U(this.size);t.scale.set(e,e,e)}m.add(t)}I()}}),n.$on("$destroy",function(){m&&(m.geometry.dispose(),m.material.map&&m.material.map.dispose(),m.material.dispose()),t&&(m.geometry.dispose(),m.material.dispose()),d&&(d.forceContextLoss(),d.dispose(),d=null),n.spatialize&&z(),P.off("mouseup",V),angular.element(Y).off("resize",T),q.debug("destroy imageViewer directive")})}}}]),angular.module("uh4d.images",["ngResource","xeditable","ngTagsInput","dndLists","uh4d.actors","angularMoment"]).run(["editableOptions","editableThemes",function(e,t){e.theme="bs3",t.bs3.buttonsClass="btn-sm",t.bs3.inputClass="form-control-sm",t.bs3.submitTpl='<button type="submit" class="btn btn-primary"><span class="fa fa-check"></span></button>',t.bs3.cancelTpl='<button type="button" class="btn btn-default" ng-click="$form.$cancel()"><span class="fa fa-times"></span></button>'}]).factory("Image",["$resource",function(e){return e("api/image/:id",{id:"@id"},{query:{url:"api/search",method:"GET",isArray:!0},update:{method:"PUT"},spatialize:{method:"PUT",url:"api/image/:id/spatial"},checkFileUpdate:{url:"api/image/:id/file/check",method:"GET"},updateFile:{url:"api/image/:id/file/update",method:"GET"},setLinksToObjects:{url:"api/image/:id/link",method:"PUT"},createDummy:{url:"api/image/dummy",method:"POST"},deleteDummy:{url:"api/image/dummy/:id",method:"DELETE"},getDateExtent:{method:"GET",url:"api/image/dateExtent"}})}]).component("imageList",{templateUrl:"components/uh4d.images/imageList.tpl.9ec85fc6.html",controller:["$scope","$element","$state","Image","Utilities","viewportCache","$debounce","ImageCollection",function(e,t,o,n,a,i,r,s){var c=this;function l(){c.images&&c.images.length&&c.images.forEach(function(e){s.get(e.id)?e.inCollection=!0:!0===e.inCollection&&(e.inCollection=!1)})}c.images=[],c.itemsPerPage=20,c.$onInit=function(){c.listTab="results",c.listMode="list",c.listOrderBy={prop:"date.from",desc:!1},c.page=0,c.selection=[],s.promise.then(function(e){c.collection=e,l()})},e.$on("imageQuerySuccess",function(e,t){c.images=t,c.currentPage=1,l()}),e.$on("viewportSelectionChange",function(e,t){console.log(t),c.selection=t.filter(function(e){return e instanceof DV3D.ImageEntry}).map(function(e){return e.source})}),e.$on("ImageCollectionUpdate",function(){l()}),e.$on("imageUpdate",function(e,t,n){if(!0===n){var o=c.images.findIndex(function(e){return e.id===t.id});c.images.splice(o,1)}else{var a=c.images.find(function(e){return e.id===t.id});a?angular.extend(a,t):c.images.push(t)}}),c.openImage=function(e){o.go(".image",{imageId:e})},c.openCompareModal=function(e,t,n){e.stopPropagation(),o.go(".compare",{imageId1:t.id,imageId2:n.id})},c.setListTab=function(e){e===c.listTab?c.listTab="":c.listTab=e},c.setListMode=function(e){switch(e){case"list":case"cards":c.listMode=e}},c.onPaginationChange=function(){t.find(".list-body").scrollTop(0)},c.addToCollection=function(e,t){e.stopPropagation(),s.add(t),c.collection=s.get()},c.removeFromCollection=function(e,t){e.stopPropagation(),s.remove(t),c.collection=s.get()},c.collectionChangedByDnd=function(e){c.collection.splice(e,1),s.updateStorage()},c.focusImage=function(e,t){if(e.stopPropagation(),t){var n=i.spatialImages.getByName(t.id);console.log(n),n&&n.focus()}}}]}).component("imageModal",{templateUrl:"components/uh4d.images/imageModal.tpl.3b78d193.html",controller:["$rootScope","$state","$timeout","Image","Utilities","ImageCollection","Person","LegalBody","$http",function(o,e,t,a,i,r,n,s,c){var l=this;function u(e){o.$broadcast("imageUpdate",e)}l.$onInit=function(){t(function(){!function(n){if(!n)return;a.get({id:n}).$promise.then(function(e){var t;console.log(e),l.image=e,l.tags=e.tags.map(function(e){return{text:e}}),r.get(n)&&(l.image.inCollection=!0),o.editableMode&&(t=n,a.checkFileUpdate({id:t}).$promise.then(function(e){e.message||(l.fileUpdate=e)}).catch(function(e){i.throwApiException("Image.checkFileUpdate",e)}))}).catch(function(e){i.throwApiException("Image.get",e)})}(e.params.imageId)},0,!1)},l.addToCollection=function(){r.add(l.image)},l.removeFromCollection=function(){r.remove(l.image)},l.startSpatialize=function(){e.go("^"),o.$broadcast("triggerSpatializeManual",l.image)},l.updateImage=function(t,e){if(l.image[t]===e)return!1;var n=l.image[t];return"tags"===t?l.image.tags=e.map(function(e){return e.text}):l.image[t]="date"===t?{value:e}:e,l.image.$update({prop:t}).then(function(e){return console.log(e),u(l.image),!1}).catch(function(e){return i.throwApiException("Image.update",e),l.image[t]=n,!1})},l.updateFile=function(){l.isSaving=!0,a.updateFile({id:l.image.id}).$promise.then(function(e){console.log(e),l.image.file=e,l.fileUpdate=null,u(l.image),l.isSaving=!1}).catch(function(e){i.throwApiException("Image.updateFile",e),l.isSaving=!1})},l.queryPersons=function(e){return n.query({name:e}).$promise.then(function(e){return e.map(function(e){return e.name})}).catch(function(e){i.throwApiException("Person.query",e)})},l.queryLegalBodies=function(e){return s.query({name:e}).$promise.then(function(e){return e.map(function(e){return e.name})}).catch(function(e){i.throwApiException("LegalBody.query",e)})},l.queryTags=function(e){return c.get("api/tag?query="+e).then(function(e){return console.log(e),e.data.map(function(e){return e.tag})}).catch(function(e){i.throwApiException("$http.get api/tag",e)})},l.close=function(){e.go("^")}}]}).component("compareModal",{templateUrl:"components/uh4d.images/compareModal.tpl.20cfeb0a.html",controller:["$q","$state","$timeout","Image","Utilities",function(n,e,t,o,a){var i=this;function r(e){var t=n.defer();return o.get({id:e}).$promise.then(function(e){t.resolve(e)}).catch(function(e){a.throwApiException("Image.get",e),t.resolve(null)}),t.promise}i.$onInit=function(){t(function(){r(e.params.imageId1).then(function(e){i.image1=e}),r(e.params.imageId2).then(function(e){i.image2=e})},0,!1)},i.close=function(){e.go("^")}}]}).service("ImageCollection",["$window","$rootScope","$q","Image","Utilities",function(a,e,i,r,s){var c=[],l=a.localStorage.collectionIds?angular.fromJson(a.localStorage.collectionIds):[],t=[],n=i.defer();function u(){e.$broadcast("ImageCollectionUpdate",c)}l.forEach(function(e){t.push(r.get({id:e}).$promise)}),i.all(t).then(function(e){e.forEach(function(e){e&&(e.inCollection=!0,c.push(e))}),n.resolve(c)}),this.promise=n.promise,this.get=function(t){return t?c.find(function(e){return e.id===t}):c},this.add=function(e){if(e){var t,n,o="string"==typeof e?e:e.id;if(-1===l.indexOf(o))l.push(o),a.localStorage.collectionIds=angular.toJson(l),"string"==typeof e?(t=o,n=i.defer(),r.get({id:t}).$promise.then(function(e){n.resolve(e)}).catch(function(e){s.throwApiException("Image.get() in ImageCollection",e),n.resolve()}),n.promise).then(function(e){e&&(e.inCollection=!0,c.push(e))}):(e.inCollection=!0,c.push(e)),u()}},this.remove=function(e){if(e){var t="string"==typeof e?e:e.id,n=l.indexOf(t);-1!==n&&(l.splice(n,1),a.localStorage.collectionIds=angular.toJson(l),-1!==(n=c.findIndex(function(e){return e.id===t}))&&c.splice(n,1),e.inCollection&&(e.inCollection=!1),u())}},this.updateStorage=function(){l=c.map(function(e){return e.id}),a.localStorage.collectionIds=angular.toJson(l)}}]).filter("imageDate",["moment",function(n){return function(e){if(!e.display)return e.value;var t;switch(e.display){case"YYYY/YYYY":t=n(e.from).format("YYYY")+"/"+n(e.to).format("YYYY");break;case"around YYYY":t="around "+n(e.from).add(5,"years").format("YYYY");break;case"before YYYY":t="before "+n(e.to).format("YYYY");break;case"after YYYY":t="after "+n(e.from).format("YYYY");break;default:t=n(e.from).format(e.display)}return t}}]),angular.module("uh4d.models",["ngResource","angularFileUpload"]).factory("DigitalObject",["$resource",function(e){return e("api/model/:id",{id:"@id"},{query:{method:"GET",isArray:!0,transformResponse:function(e){var t=angular.fromJson(e);return t.forEach(function(e){e.object.node=e}),t}},update:{method:"PUT"},save:{url:"api/model",method:"POST"},deleteTemp:{url:"api/model/temp",method:"POST"},duplicate:{url:"api/model/:id/duplicate",method:"PUT"}})}]).factory("ModelUploader",["$rootScope","FileUploader","Utilities",function(n,e,a){var o=new e({url:"api/model/upload",alias:"uploadModelFile",queueLimit:1}),i=["dae"];return o.filters.push({name:"modelFilter",fn:function(e){var t=e.name.slice(e.name.lastIndexOf(".")+1).toLowerCase();return-1!==i.indexOf(t)}}),o.onWhenAddingFileFailed=function(e,t,n){"queueLimit"===t.name?(o.clearQueue(),o.addToQueue(e)):"modelFilter"===t.name?a.dangerAlert("Model type not supported! Use Collada (.dae)."):(console.warn("onWhenAddingFileFailed",e,t,n),a.dangerAlert("Unkown error. See console."))},o.onSuccessItem=function(e,t){t instanceof Object&&!t.error?(console.log(e,t),t.object.node=t,n.$broadcast("modelUploadSuccess",t)):a.throwApiException("#model/upload",t)},o.onErrorItem=function(e,t,n,o){console.error("onErrorItem",e,t,n,o),a.throwApiException("#model/upload",t)},o}]).component("uploadModal",{templateUrl:"components/uh4d.models/uploadModal.tpl.20f73d80.html",controller:["$scope","$state","ModelUploader","Utilities",function(e,t,n,o){var a=this;a.$onInit=function(){a.uploader=n},e.$watch(function(){return n.queue[0]},function(e){a.fileItem=e||null}),a.upload=function(){a.fileItem&&a.fileItem.upload()},e.$on("modelUploadSuccess",function(){a.close()}),a.close=function(){t.go("^")}}]}).component("objectModal",{templateUrl:"components/uh4d.models/objectModal.tpl.3d3bbd3c.html",controller:["$rootScope","$state","$timeout","DigitalObject","viewportCache","moment","Utilities",function(e,t,n,o,i,r,s){var c=this;c.$onInit=function(){n(function(){o.get({id:t.params.objectId}).$promise.then(function(e){console.log(e),c.object=e}).catch(function(e){s.throwApiException("DigitalObject.get",e)})},0,!1)},c.updateObject=function(t,e){if(c.object[t]===e)return!1;var n=c.object[t];switch(t){case"from":var o=r(e,"YYYY-MM-DD");if(!o.isValid())return s.dangerAlert('Wrong date format! Use "YYYY-MM-DD".'),!1;if(c.object.date.to&&r(c.object.date.to).isBefore(o))return s.dangerAlert("Date must be before destruction date!"),!1;c.object.date.from=o.format("YYYY-MM-DD");break;case"to":var a=r(e,"YYYY-MM-DD");if(!a.isValid())return s.dangerAlert('Wrong date format! Use "YYYY-MM-DD".'),!1;if(c.object.date.from&&r(c.object.date.from).isAfter(a))return s.dangerAlert("Date must be after erection date!"),!1;c.object.date.to=a.format("YYYY-MM-DD");break;default:c.object[t]=e}return c.object.$update({prop:t}).then(function(e){console.log(e);var t=i.objects.getByName(e.object.id);return t&&(t.label=e.name,t.node=e,t.object.userData.node=e),!1}).catch(function(e){return s.throwApiException("DigitalObject.update",e),c.object[t]=n,!1})},c.duplicate=function(){c.object.$duplicate().then(function(){s.successAlert("Duplication successful.")}).catch(function(e){s.throwApiException("DigitalObject.duplicate",e)})},c.close=function(){t.go("^")}}]}),angular.module("uh4d.actors",["ngResource"]).factory("Person",["$resource",function(e){return e("api/person/:id",{id:"@id"})}]).factory("LegalBody",["$resource",function(e){return e("api/legalbody/:id",{id:"@id"})}]),angular.module("uh4d.timeSlider",[]).component("timeSlider",{templateUrl:"components/uh4d.timeSlider/timeSlider.tpl.1ed5ea3b.html",controller:["$scope","$element","$rootScope","$state","$window","moment","Image","Utilities",function(e,t,n,o,a,i,r,s){var c,l,u,d,p,f,m,g,h,v,E,b,y,w,x,D,$,j,M=this,T=d3.timeFormat("%Y");function C(){j=h(new Date(+h.domain()[0]).setFullYear(h.domain()[0].getFullYear()+1));var e=d.selectAll("g.tick").data(h.ticks(Math.floor(f/50))),t=e.enter().append("g").attr("class","tick").attr("transform",function(e){return"translate("+h(e)+",0)"});t.append("line").attr("y1",0).attr("y2",6),t.append("text").attr("y",18).attr("text-anchor","middle").text(T),e.transition().duration(0).attr("transform",function(e){return"translate("+h(e)+",0)"}).select("text").text(T),e.exit().remove(),R(),I(),D.forEach(function(e){e.x=h(e.date),e.element.attr("transform","translate("+e.x+",0)")})}function R(e){!1!==e&&(E.x=h(E.date),b.x=h(b.date),y.x=h(y.date),w.x=h(w.date));var t=b.x-E.x;p.attr("x",E.x).attr("width",t),E.element.attr("transform","translate("+E.x+",0)"),E.element.select("text").attr("x",Math.min(f-E.x-50,Math.max(17-E.x,Math.min(t/2,17)-17))).text(T(E.date)),b.element.attr("transform","translate("+b.x+",0)"),b.element.select("text").attr("x",Math.max(50-b.x,Math.min(f-b.x-17,Math.max(-t/2,-17)+17))).text(T(b.date))}function I(e){!1!==e&&(x.x=h(x.date)),x.element.attr("transform","translate("+x.x+",0)"),x.element.select("text").text(T(x.date))}function k(e){$&&$.element.classed("active",!1),e===$?($=null,n.$broadcast("mapLoad")):(e.element.classed("active",!0),$=e,n.$broadcast("mapLoad",e.year))}function V(){n.$broadcast("filterByDate",i(E.date).format("YYYY-MM-DD"),i(b.date).format("YYYY-MM-DD"),i(x.date).format("YYYY-MM-DD"),M.includeUndated)}function H(){f=c.width(),m=c.height(),l.select("#alphaMask > rect").attr("width",f).attr("height",m),v.translateExtent([[0,0],[f,0]]),g.range([0,f]),h.range([0,f]),C()}M.$onInit=function(){c=t.find("svg"),l=d3.select(c[0]),M.includeUndated=!o.params.undated||"true"===o.params.undated,e.$on("resizeLayout",H),angular.element(a).on("resize",H),r.getDateExtent().$promise.then(function(e){y={date:new Date(e.from)},w={date:new Date},E={date:o.params.from?Math.max(y.date,new Date(o.params.from)):y.date,x:0,element:null},b={date:o.params.to?Math.min(w.date,new Date(o.params.to)):w.date,x:0,element:null},x={date:o.params.modelDate?Math.min(w.date,Math.max(y.date,new Date(o.params.modelDate))):new Date("1930-01-01"),x:0,element:null},D=["1849","1911","1967","1994"].map(function(e){return{date:new Date(e),x:0,element:null,year:e}}),f=c.width(),m=c.height(),l.select("#alphaMask > rect").attr("width",f).attr("height",m),v=d3.zoom().scaleExtent([1,10]).translateExtent([[0,0],[f,0]]).on("zoom",function(){h=d3.event.transform.rescaleX(g),C()}),h=g=d3.scaleTime().domain([y.date,w.date]).range([0,f]).clamp(!1),(u=l.append("g").attr("class","container").call(v)).append("rect").attr("class","background").attr("width","100%").attr("height","100%"),p=u.append("rect").attr("class","image-span").attr("y",15).attr("height",32).call(d3.drag().on("drag",function(){var e=parseFloat(p.attr("width"));E.x=Math.min(Math.max(E.x+d3.event.dx,y.x),w.x-e),b.x=E.x+e,E.date=h.invert(E.x),b.date=h.invert(b.x),R(!1)}).on("end",V)),u.append("rect").attr("class","track").attr("x",0).attr("y",m/2-2).attr("width","100%").attr("height",3).attr("mask","url(#alphaMask)"),E.element=u.append("g").attr("class","from-handle"),E.element.append("path").attr("d","M 5 16 H 0 V 46 H 5"),E.element.append("text").attr("text-anchor","middle").attr("x",0).attr("y",12),E.element.append("rect").attr("x",-10).attr("width",20).attr("height","100%").call(d3.drag().container(u.node()).on("drag",function(){E.x=Math.min(Math.max(d3.event.x,0),b.x-j,f),E.date=h.invert(E.x),R(!1)}).on("end",V)),b.element=u.append("g").attr("class","to-handle"),b.element.append("path").attr("d","M -5 16 H 0 V 46 H -5"),b.element.append("text").attr("text-anchor","middle").attr("x",0).attr("y",12),b.element.append("rect").attr("x",-10).attr("width",20).attr("height","100%").call(d3.drag().container(u.node()).on("drag",function(){b.x=Math.max(Math.min(d3.event.x,f),E.x+j,0),b.date=h.invert(b.x),R(!1)}).on("end",V)),x.element=u.append("g").attr("class","obj-handle"),x.element.append("path").attr("d","M 0 16 V 46 M -4 46 H 4 M -4 16 H 4"),x.element.append("text").attr("text-anchor","middle").attr("x",0).attr("y",12),x.element.append("rect").attr("x",-10).attr("width",20).attr("height","100%").call(d3.drag().container(u.node()).on("drag",function(){x.x=Math.max(Math.min(d3.event.x,f),0),x.date=h.invert(x.x),I(!1)}).on("end",V)),D.forEach(function(e){e.element=u.append("g").attr("class","map-handle"),e.element.append("path").attr("d","M -2 16 V 46 H 4 V 16 Z"),e.element.append("text").attr("text-anchor","middle").attr("x",0).attr("y",12).text(T(e.date)),e.element.append("rect").attr("x",-10).attr("width",20).attr("height","100%").on("click",function(){k(e)})}),d=u.append("g").attr("class","tick-container").attr("transform","translate(0,25)").attr("mask","url(#alphaMask)"),C(),n.$broadcast("timeSliderReady",i(E.date).format("YYYY-MM-DD"),i(b.date).format("YYYY-MM-DD"),i(x.date).format("YYYY-MM-DD"),M.includeUndated),k(D[1])}).catch(function(e){s.throwApiException("Image.getDateExtent() in timeSlider component",e)})},M.includeUndatedChanged=function(){V()},M.$onDestroy=function(){angular.element(a).off("resize",H)}}]});